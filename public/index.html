<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Dikotik Dinleme Izmir</title>

<meta name="emailjs-user"    content="FLn2zMqKDGso3ePoO">
<meta name="emailjs-service" content="service_a8bnfmk">
<meta name="emailjs-template"content="template_7elc4wi">

<style>
body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:12px;color:#111;max-width:740px;margin-left:auto;margin-right:auto;}
.container{display:flex;gap:20px;flex-wrap:wrap;}
.col{flex:1;min-width:320px;}
.card{padding:12px;border:1px solid #ddd;border-radius:8px;margin-bottom:12px}
h1{font-size:20px;margin-bottom:8px}
input,select,textarea{padding:8px;margin:6px 0;width:100%;box-sizing:border-box}
.bigBtn{font-size:1rem;padding:10px 14px;margin:6px;border-radius:8px;border:1px solid #444;background:#eaeaea;cursor:pointer;}
.respBtn{font-size:1.05rem;padding:10px 14px;margin:6px;border-radius:8px;border:1px solid #444;background:#f6f6f6;cursor:pointer;}
.respBtn-active{background:#bdbdbd}
.stai-options{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
.small{font-size:13px;color:#666}
.hand-grid-row{display:flex;align-items:center;justify-content:space-between;border-top:1px solid #eee;padding:6px 0}
.hand-grid-row span{flex:2}
.hand-grid-row .col{flex:1;display:flex;justify-content:center;gap:8px}
.question-group{margin-bottom:10px}
</style>
</head>
<body>
<h1>Dikotik Dinleme — Tam Sürüm</h1>

<div class="container">
  <div class="col">
    <!-- 1) Katılımcı Bilgileri (ilk iki harf) -->
    <div id="participantCard" class="card">
      <h3>Katılımcı Bilgileri</h3>
      <div class="small">Gizlilik için ad & soyadın ilk 2 harfi yeterlidir (örn: "Al", "Ka").</div>
      <input id="name" placeholder="Ad (ilk 2 harf)">
      <input id="surname" placeholder="Soyad (ilk 2 harf)">
      <input id="age" type="number" placeholder="Yaş">
      <input id="race" placeholder="Doğum yeri / Irk">
      <input id="motherTongue" placeholder="Anadiliniz">
      <input id="email" type="email" placeholder="E-posta (opsiyonel)">
      <select id="gender">
        <option value="">Cinsiyet</option>
        <option value="Kadın">Kadın</option>
        <option value="Erkek">Erkek</option>
        <option value="Diğer">Diğer</option>
      </select>
      <select id="projectCode">
        <option value="">Proje Kodu Seçin</option>
        <option value="OykuTez">OykuTez</option>
        <option value="Izmir">Izmir</option>
        <option value="Esporcu">Esporcu</option>
        <option value="Sporcu">Sporcu</option>
      </select>
      <div><button id="toParticipationBtn" class="bigBtn">Devam</button></div>
      <div id="codeInfo" class="small"></div>
    </div>

    <!-- 2) Katılım Durumu -->
    <div id="participationCard" class="card hidden">
      <h3>Katılım Durumu</h3>
      <div id="participationOptions" class="small"></div>
      <div><button id="toNextStepBtn" class="bigBtn">Devam</button></div>
    </div>

    <!-- 3) Önceden katılanlar için kod girişi -->
    <div id="enterCodeCard" class="card hidden">
      <h3>Önceki Katılımcı Kodu</h3>
      <div class="small">Daha önce katıldıysanız lütfen size verilen katılımcı kodunu girin.</div>
      <input id="previousCode" placeholder="Örnek: IZ_AL_KA_12345">
      <div><button id="toStaiDirectBtn" class="bigBtn">Devam</button></div>
    </div>

    <!-- 4) Onam -->
    <div id="consentCard" class="card hidden">
      <h3>Aydınlatılmış Onam</h3>
      <div id="consentText" contenteditable="true">
        <p><b>Sayın Katılımcı,</b></p>
        <p>Bu çalışma işitsel algı ve dikkat süreçlerini incelemeyi amaçlar. Katılım gönüllülük esasına dayanır; veriler anonimleştirilecektir.</p>
        <p>Dilediğiniz an çalışmadan ayrılabilirsiniz.</p>
      </div>
      <label><input type="checkbox" id="consentAgree"> Okudum ve onaylıyorum</label>
      <div style="margin-top:8px">
        <button id="backToInfoBtn" class="bigBtn">Geri</button>
        <button id="toHandBtnFromConsent" class="bigBtn">Devam</button>
      </div>
    </div>

    <!-- 5) El Kullanımı -->
    <div id="handUseCard" class="card hidden">
      <h3>El Kullanımı Testi</h3>
      <div class="small">Her işlem için kullandığınız eli işaretleyin (her satır için tam olarak 2 kutucuk işaretlenmelidir: sol/sağ kombinasyonu).</div>
      <div id="handUseQuestions"></div>
      <div><button id="toStaiBtn" class="bigBtn">Devam</button></div>
    </div>

    <!-- 6) STAI -->
    <div id="staiCard" class="card hidden">
      <h3>STAI-TXI Formu</h3>
      <div id="staiQuestions"></div>
      <div><button id="toHearingBtn" class="bigBtn">Devam</button></div>
    </div>
  </div>

  <div class="col">
    <!-- 7) İşitme -->
    <div id="hearingCard" class="card hidden">
      <h3>İşitme Kontrolü</h3>
      <p class="small">1500 Hz tonunu sol/sağ kulaklar için ayrı ayrı test edin.</p>

      <div>
        <label><b>Sol Kulak</b></label>
        <input type="range" id="leftSlider" min="0" max="1" step="0.01" value="0.5">
        <button id="playLeftTone" class="bigBtn">Sol Ses Testi</button>
      </div>

      <div style="margin-top:12px">
        <label><b>Sağ Kulak</b></label>
        <input type="range" id="rightSlider" min="0" max="1" step="0.01" value="0.5">
        <button id="playRightTone" class="bigBtn">Sağ Ses Testi</button>
      </div>

      <div style="margin-top:14px"><button id="toSessionIntro" class="bigBtn">Devam</button></div>
    </div>

    <!-- 8) Oturum Intro -->
    <div id="sessionIntro" class="card hidden">
      <h3 id="sessionTitle"></h3>
      <p id="sessionInstr"></p>
      <div><button id="sessionStartBtn" class="bigBtn">Başla</button></div>
    </div>

    <!-- 9) Trial -->
    <div id="trialCard" class="card hidden">
      <div id="trialStatus" class="small" style="margin-bottom:8px"></div>
      <audio id="stimAudio" preload="auto"></audio>
      <div class="small">Hemen alttan duyduğunuz heceyi seçiniz.</div>
      <div style="margin-top:8px">
        <button class="respBtn" data-val="BA">BA</button>
        <button class="respBtn" data-val="DA">DA</button>
        <button class="respBtn" data-val="GA">GA</button>
        <button class="respBtn" data-val="KA">KA</button>
        <button class="respBtn" data-val="PA">PA</button>
        <button class="respBtn" data-val="TA">TA</button>
      </div>
    </div>

    <!-- 10) End -->
    <div id="endCard" class="card hidden">
      <h3>Deney tamamlandı ✅</h3>
      <div id="doneLog" class="small"></div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded',()=>{

/* ---------- helpers & state ---------- */
const $id=id=>document.getElementById(id);
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }

let participant={}, results=[], sessionOrder=[], currentSessionIndex=0, currentTrial=-1;
let audioCtx=null, leftOsc=null, rightOsc=null, leftGain=null, rightGain=null;
let isResponseAllowed=false, trialTimeout=null;

/* ---------- participation flow ---------- */
$id('toParticipationBtn').onclick = ()=>{
  const n=$id('name').value.trim(), s=$id('surname').value.trim(), a=$id('age').value.trim(), p=$id('projectCode').value;
  if(!n||!s||!a||!p){ alert('Lütfen ad (ilk2), soyad (ilk2), yaş ve proje kodunu doldurun.'); return; }
  // store minimal participant info
  participant.name = n.slice(0,2);
  participant.surname = s.slice(0,2);
  participant.age = a;
  participant.race = $id('race').value.trim();
  participant.motherTongue = $id('motherTongue').value.trim();
  participant.email = $id('email').value.trim();
  participant.phone = $id('phone').value.trim();
  participant.gender = $id('gender').value;
  participant.projectCode = p;

  // move to participation question
  $id('participantCard').classList.add('hidden');
  $id('participationCard').classList.remove('hidden');
  renderParticipationOptions(p);
};

function renderParticipationOptions(code){
  const container = $id('participationOptions');
  container.innerHTML = '';
  if(code === 'OykuTez'){
    container.innerHTML = `
      <label><input type="radio" name="participation" value="1"> İlk kez katılıyorum</label><br>
      <label><input type="radio" name="participation" value="2"> Bir kez katıldım ama tamamlayamadım</label><br>
      <label><input type="radio" name="participation" value="3"> İkinci kez katılıyorum</label><br>
      <label><input type="radio" name="participation" value="4"> İki kez katıldım ancak tamamlayamadım</label>
    `;
  } else {
    container.innerHTML = `
      <label><input type="radio" name="participation" value="1"> İlk kez katılıyorum</label><br>
      <label><input type="radio" name="participation" value="2"> Bir kez katıldım ama tamamlayamadım</label>
    `;
  }
}

$id('toNextStepBtn').onclick = ()=>{
  const sel = document.querySelector('input[name="participation"]:checked');
  if(!sel){ alert('Lütfen bir seçenek seçiniz.'); return; }
  const v = sel.value;
  if(v === '1'){
    // first time -> show consent
    $id('participationCard').classList.add('hidden');
    $id('consentCard').classList.remove('hidden');
  } else {
    // returning -> ask code
    $id('participationCard').classList.add('hidden');
    $id('enterCodeCard').classList.remove('hidden');
  }
};

/* ---------- consent handlers ---------- */
$id('backToInfoBtn').onclick = ()=>{ $id('consentCard').classList.add('hidden'); $id('participantCard').classList.remove('hidden'); };
$id('toHandBtnFromConsent').onclick = ()=>{
  if(!$id('consentAgree').checked){ alert('Lütfen onam kutusunu onaylayınız.'); return; }
  $id('consentCard').classList.add('hidden');
  $id('handUseCard').classList.remove('hidden');
  renderHand();
};

/* ---------- previous code handler ---------- */
$id('toStaiDirectBtn').onclick = ()=>{
  const code = $id('previousCode').value.trim();
  if(!code){ alert('Lütfen önceki katılımcı kodunu giriniz.'); return; }
  participant.code = code;
  // try load stored summary data (local)
  try{
    const raw = localStorage.getItem('participant.'+code);
    if(raw){ const saved = JSON.parse(raw); participant = {...participant, ...saved}; }
  }catch(e){ console.warn('local load err', e); }
  $id('enterCodeCard').classList.add('hidden');
  renderStai();
  $id('staiCard').classList.remove('hidden');
};

/* ---------- hand use ---------- */
const handQs = ["Yazmak","Çizmek","Taş Atmak","Makas kullanmak","Diş fırçası kullanmak","Bıçak kullanmak","Kaşık kullanmak","Süpürge (üst el)","Kibrit çakmak","Kutunun kapağını açmak"];
function renderHand(){
  const c = $id('handUseQuestions'); c.innerHTML = `<div class="hand-grid-header"><div style="flex:2"></div><div style="flex:1;text-align:center">Sol</div><div style="flex:1;text-align:center">Sağ</div></div>`;
  handQs.forEach((q,i)=>{
    c.innerHTML += `<div class="hand-grid-row" data-q="${i+1}"><span>${i+1}. ${q}</span>
      <div class="col"><input type="checkbox" class="left"><input type="checkbox" class="left"></div>
      <div class="col"><input type="checkbox" class="right"><input type="checkbox" class="right"></div>
    </div>`;
  });
}

$id('toStaiBtn').onclick = ()=>{
  // validate hand use: each row must have exactly 2 checked (as per your original requirement)
  const rows = document.querySelectorAll('#handUseQuestions .hand-grid-row');
  for(const r of rows){
    if(r.querySelectorAll('input:checked').length !== 2){ alert('Her işlem için tam olarak 2 kutucuk işaretleyiniz.'); return; }
  }
  // save
  participant.handUse = Array.from(rows).map(r=>({
    q: r.dataset.q,
    left: r.querySelectorAll('.left:checked').length,
    right: r.querySelectorAll('.right:checked').length
  }));
  // store summary locally to allow merging for returning participants
  try{ localStorage.setItem('participant.' + (participant.code || (participant.projectCode + '_' + participant.name + participant.surname)), JSON.stringify({ projectCode: participant.projectCode, handUse: participant.handUse, motherTongue: participant.motherTongue, race: participant.race })); }catch(e){console.warn(e);}
  document.getElementById('handUseCard').classList.add('hidden');
  renderStai();
  document.getElementById('staiCard').classList.remove('hidden');
};

/* ---------- STAI ---------- */
const staiQuestions = [
  "Şu anda sakinim","Kendimi emniyette hissediyorum","Şu anda sinirlerim gergin",
  "Pişmanlık duygusu içindeyim","Şu anda huzur içindeyim","Şu anda hiç keyfim yok",
  "Başıma geleceklerden endişe ediyorum","Kendimi dinlenmiş hissediyorum","Şu anda kaygılıyım",
  "Kendimi rahat hissediyorum","Kendime güvenim var","Şu anda asabım bozuk","Çok sinirliyim",
  "Sinirlerimin çok gergin olduğunu hissediyorum","Kendimi rahatlamış hissediyorum",
  "Şu anda halimden memnunum","Şu anda endişeliyim","Heyecandan kendimi şaşkına dönmüş hissediyorum",
  "Şu anda sevinçliyim","Şu anda keyfim yerinde"
];
function renderStai(){
  const c = $id('staiQuestions'); c.innerHTML = '';
  staiQuestions.forEach((q,i)=>{
    c.innerHTML += `<div class="question-group"><p>${i+1}. ${q}</p>
      <div class="stai-options">
        <label><input type="radio" name="staiQ${i+1}" value="1">Hiç</label>
        <label><input type="radio" name="staiQ${i+1}" value="2">Biraz</label>
        <label><input type="radio" name="staiQ${i+1}" value="3">Çok</label>
        <label><input type="radio" name="staiQ${i+1}" value="4">Tamamıyla</label>
      </div></div>`;
  });
}

$id('toHearingBtn').onclick = ()=>{
  const answered = document.querySelectorAll('#staiQuestions input:checked').length;
  if(answered < staiQuestions.length){ alert('Lütfen tüm STAI sorularını yanıtlayınız.'); return; }
  // collect answers
  const ans = {};
  document.querySelectorAll('#staiQuestions input:checked').forEach(i=> ans[i.name] = i.value);
  participant.staiAnswers = ans;
  $id('staiCard').classList.add('hidden');
  $id('hearingCard').classList.remove('hidden');
};

/* ---------- Hearing: two-ear logic ---------- */
function ensureAudioCtx(){ if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }

function stopLeftTone(){ try{ if(leftOsc) leftOsc.stop(); }catch(e){} leftOsc=null; leftGain=null; }
function stopRightTone(){ try{ if(rightOsc) rightOsc.stop(); }catch(e){} rightOsc=null; rightGain=null; }

function startLeftTone(){
  ensureAudioCtx();
  stopRightTone();
  stopLeftTone();
  leftOsc = audioCtx.createOscillator();
  leftGain = audioCtx.createGain();
  leftOsc.frequency.value = 1500;
  leftGain.gain.value = Number($id('leftSlider').value);
  const merger = audioCtx.createChannelMerger(2);
  leftOsc.connect(leftGain);
  leftGain.connect(merger,0,0); // left channel
  merger.connect(audioCtx.destination);
  leftOsc.start();
}

function startRightTone(){
  ensureAudioCtx();
  stopLeftTone();
  stopRightTone();
  rightOsc = audioCtx.createOscillator();
  rightGain = audioCtx.createGain();
  rightOsc.frequency.value = 1500;
  rightGain.gain.value = Number($id('rightSlider').value);
  const merger = audioCtx.createChannelMerger(2);
  rightOsc.connect(rightGain);
  rightGain.connect(merger,0,1); // right channel
  merger.connect(audioCtx.destination);
  rightOsc.start();
}

$id('playLeftTone').onclick = ()=>{ if(leftOsc) stopLeftTone(); else startLeftTone(); setTimeout(()=>stopLeftTone(),1500); };
$id('playRightTone').onclick = ()=>{ if(rightOsc) stopRightTone(); else startRightTone(); setTimeout(()=>stopRightTone(),1500); };

$id('toSessionIntro').onclick = ()=>{
  stopLeftTone(); stopRightTone();
  participant.leftLevel = $id('leftSlider').value;
  participant.rightLevel = $id('rightSlider').value;
  results.push({ session: 'hearing_test', stim:'1500Hz', leftLevel: participant.leftLevel, rightLevel: participant.rightLevel, code: participant.code || '' });
  $id('hearingCard').classList.add('hidden');
  // set session order: training, NF, randomized FR/FL
  sessionOrder = ['training','NF', ...shuffle(['FR','FL'])];
  currentSessionIndex = 0;
  showSessionIntro();
};

/* ---------- Session intro & trials ---------- */
const instr = {
  training: "Eğitim oturumu — yanıtlar kaydedilmeyecek.",
  NF: "Normal odak: en iyi duyduğunuz heceyi işaretleyiniz.",
  FR: "Sağa odak: sağ kulağınızdaki heceyi işaretleyiniz.",
  FL: "Sola odak: sol kulağınızdaki heceyi işaretleyiniz."
};

function showSessionIntro(){
  const s = sessionOrder[currentSessionIndex];
  $id('sessionTitle').innerText = "Oturum: " + s;
  $id('sessionInstr').innerHTML = instr[s] || '';
  $id('sessionIntro').classList.remove('hidden');
}

$id('sessionStartBtn').onclick = async ()=>{
  $id('sessionIntro').classList.add('hidden');
  // unlock audio if needed by creating short silent audio
  try{ const a = $id('stimAudio'); a.src = ''; await a.play().catch(()=>{}); }catch(e){}
  setTimeout(()=> startSession(), 250);
};

const trainingPlaylist = [ "LBA-RBA.wav","LDA-RDA.wav","LGA-RGA.wav","LKA-RKA.wav","LPA-RPA.wav","LTA-RTA.wav","LBA-RDA.wav","LDA-RGA.wav","LGA-RKA.wav","LKA-RTA.wav" ];
const mainPlaylist = [ "LBA-RKA.wav","LDA-RGA.wav","LPA-RBA.wav","LKA-RDA.wav","LBA-RBA.wav","LTA-RGA.wav","LBA-RDA.wav","LGA-RPA.wav","LDA-RKA.wav","LPA-RTA.wav","LKA-RKA.wav","LBA-RGA.wav","LKA-RPA.wav","LTA-RDA.wav","LGA-RKA.wav","LPA-RDA.wav","LGA-RGA.wav","LBA-RTA.wav","LGA-RDA.wav","LKA-RTA.wav","LDA-RPA.wav","LTA-RKA.wav","LPA-RPA.wav","LDA-RBA.wav","LGA-RTA.wav","LPA-RKA.wav","LTA-RBA.wav","LKA-RGA.wav","LTA-RTA.wav","LBA-RPA.wav","LDA-RTA.wav","LGA-RBA.wav","LTA-RPA.wav","LDA-RDA.wav","LKA-RBA.wav","LPA-RGA.wav" ];

function startSession(){
  currentTrial = -1;
  $id('trialCard').classList.remove('hidden');
  nextTrial();
}

const stimAudio = $id('stimAudio');
stimAudio.onended = ()=>{ /* handled by nextTrial timers */ };

function nextTrial(){
  clearTimeout(trialTimeout);
  const sType = sessionOrder[currentSessionIndex];
  const playlist = (sType === 'training') ? trainingPlaylist : mainPlaylist;
  currentTrial++;
  if(currentTrial >= playlist.length){
    $id('trialCard').classList.add('hidden');
    currentSessionIndex++;
    if(currentSessionIndex < sessionOrder.length){ showSessionIntro(); } else { endExperiment(); }
    return;
  }
  const stim = playlist[currentTrial];
  $id('trialStatus').innerText = `Deneme ${currentTrial+1}/${playlist.length} (${sType})`;
  playStim(stim);
}

async function playStim(stim){
  isResponseAllowed = false;
  const candidates = [
    './resources/sounds/erkek/' + stim,
    './sounds/erkek/' + stim,
    stim
  ];
  let played = false;
  for(const p of candidates){
    try{
      stimAudio.src = p;
      await stimAudio.play();
      played = true;
      break;
    }catch(e){ /* try next */ }
  }
  if(!played){
    console.warn('Ses çalma başarısız:', candidates);
    alert('Ses dosyası yüklenemedi. Lütfen dosya yolunu kontrol edin.');
    // mark as no_response and continue
    if(sessionOrder[currentSessionIndex] !== 'training'){
      results.push({ session: sessionOrder[currentSessionIndex], trial: currentTrial+1, stim, response: 'no_response', code: participant.code || '' });
    }
    setTimeout(nextTrial, 500);
    return;
  }
  // when audio is playing, allow response after 500ms
  stimAudio.onplaying = ()=>{ setTimeout(()=> isResponseAllowed = true, 500); };
  // set response timeout
  trialTimeout = setTimeout(()=>{
    if(sessionOrder[currentSessionIndex] !== 'training'){
      results.push({ session: sessionOrder[currentSessionIndex], trial: currentTrial+1, stim, response: 'no_response', code: participant.code || '' });
    }
    nextTrial();
  }, 4000);
}

/* ---------- response buttons ---------- */
document.querySelectorAll('.respBtn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    if(!isResponseAllowed) return;
    isResponseAllowed = false;
    clearTimeout(trialTimeout);
    const resp = btn.dataset.val;
    const sType = sessionOrder[currentSessionIndex];
    const playlist = (sType === 'training') ? trainingPlaylist : mainPlaylist;
    const stim = playlist[currentTrial];
    if(sType !== 'training'){
      results.push({
        session: sType,
        trial: currentTrial+1,
        stim,
        response: resp,
        leftLevel: participant.leftLevel || '',
        rightLevel: participant.rightLevel || '',
        code: participant.code || ''
      });
    }
    btn.classList.add('respBtn-active');
    setTimeout(()=> btn.classList.remove('respBtn-active'), 400);
    setTimeout(()=> nextTrial(), 1200);
  });
});

/* ---------- end & CSV / email ---------- */
function makeCsv(){
  // header includes participant summary columns and per-trial rows
  const header = ["session","trial","stim","response","leftLevel","rightLevel","age","gender","race","motherTongue","handUseAnswers","staiAnswers","code"];
  // participant summary as first row (session=info)
  const info = {
    session: "info",
    trial: 0,
    stim: "",
    response: "",
    leftLevel: participant.leftLevel || "",
    rightLevel: participant.rightLevel || "",
    age: participant.age || "",
    gender: participant.gender || "",
    race: participant.race || "",
    motherTongue: participant.motherTongue || "",
    handUseAnswers: JSON.stringify(participant.handUse || {}),
    staiAnswers: JSON.stringify(participant.staiAnswers || {}),
    code: participant.code || ""
  };
  const rows = [info, ...results];
  const csvLines = [header.join(',')];
  for(const r of rows){
    const line = header.map(k=> {
      const v = (r[k] === undefined || r[k] === null) ? '' : String(r[k]).replace(/"/g,'""');
      return `"${v}"`;
    }).join(',');
    csvLines.push(line);
  }
  return csvLines.join('\n');
}

let emailInProgress=false;
async function sendEmail(partial=false){
  if(emailInProgress) return;
  emailInProgress = true;
  const csv = makeCsv();
  if(!csv){ emailInProgress=false; return; }
  try{
    if(!window.emailjs){
      const s = document.createElement('script'); s.src = 'https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js';
      await new Promise((res,rej)=>{ s.onload=res; s.onerror=rej; document.head.appendChild(s); });
      emailjs.init(document.querySelector('meta[name="emailjs-user"]').content);
    }
    const service = document.querySelector('meta[name="emailjs-service"]').content;
    const template = document.querySelector('meta[name="emailjs-template"]').content;
    const subject = (participant.code ? participant.code : ('partial_' + new Date().toISOString()));
    // try to send via emailjs
    await emailjs.send(service, template, { subject: subject + (partial ? ' (partial)' : ''), message: csv });
    $id('doneLog').innerText = (partial ? 'Ara veriler e-posta ile gönderildi.' : 'Veriler e-posta ile gönderildi.');
  }catch(err){
    console.warn('emailjs send failed', err);
    // fallback: try navigator.sendBeacon to a generic logging endpoint (if you have one) - here we can't, so just store in localStorage
    try{ localStorage.setItem('pending_csv_' + (participant.code||Date.now()), csv); $id('doneLog').innerText = 'E-posta başarısız oldu, veriler localStorage\'a kaydedildi.'; }catch(e){console.warn(e);}
  } finally { emailInProgress=false; }
}

/* send on normal completion */
async function endExperiment(){
  $id('endCard').classList.remove('hidden');
  await sendEmail(false);
}

/* attempt to send partial when page unloads (best-effort) */
let unloadSent=false;
async function trySendOnUnload(){
  if(unloadSent) return;
  unloadSent=true;
  // attempt emailjs (may be blocked); also attempt sendBeacon fallback (storing csv in blob) to some endpoint if available
  // best-effort: call sendEmail but don't await in beforeunload handler
  try{ await sendEmail(true); }catch(e){ /* ignore */ }
}

// attach both pagehide and beforeunload
window.addEventListener('pagehide', ()=>{ trySendOnUnload(); });
window.addEventListener('beforeunload', ()=>{ trySendOnUnload(); });

/* ---------- initialization ---------- */
renderStai(); // prepare STAI markup ready if needed

/* If participant had prefilled code from earlier e.g. localStorage, codeInfo show */
if(participant.code) $id('codeInfo').innerText = 'Katılımcı kodu: ' + participant.code;

}); // DOMContentLoaded end
</script>
</body>
</html>
