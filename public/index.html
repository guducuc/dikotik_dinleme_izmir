<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dikotik Dinleme Izmir</title>

  <meta name="emailjs-user"    content="FLn2zMqKDGso3ePoO">
  <meta name="emailjs-service" content="service_a8bnfmk">
  <meta name="emailjs-template"content="template_7elc4wi">

  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:12px;color:#111;max-width:340px;margin:auto;}
    h1{font-size:20px;margin-bottom:8px}
    .hidden{display:none}
    .card{padding:12px;border:1px solid #ddd;border-radius:8px;margin-bottom:12px}
    input[type=text], input[type=number], input[type=email], select{padding:8px;margin:6px 0;width:100%;box-sizing:border-box}
    .bigBtn{font-size:1.1rem;padding:12px 20px;margin:6px;border-radius:8px;border:1px solid #444;background:#eaeaea;cursor:pointer;}
    .small{font-size:13px;color:#666}
    .stai-options{display:flex;gap:10px;margin-top:4px;flex-wrap:wrap;}
    .respRow{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;}
    .respBtn{font-size:1.2rem;padding:14px 24px;margin:6px;min-width:110px;border-radius:10px;border:1px solid #444;background:#f2f2f2;cursor:pointer;transition:background-color 0.2s;}
    .respBtn-active{background-color:#bdbdbd;}
    .hand-grid-header{display:flex;justify-content:space-between;margin-bottom:6px;font-weight:600}
    .hand-grid-row{display:flex;align-items:center;justify-content:space-between;border-top:1px solid #eee;padding:4px 0}
    .hand-grid-row span{flex:2}
    .hand-grid-row .col{flex:1;display:flex;justify-content:center;gap:10px}
    #consentText{max-height:240px;overflow-y:auto;border:1px solid #ccc;padding:8px;border-radius:6px;margin-bottom:10px;font-size:14px;line-height:1.4}
  </style>
</head>
<body>
<h1>Dikotik Dinleme İzmir</h1>

<!-- 1️⃣ PROJE KODU SEÇİMİ -->
<div id="projectCard" class="card">
  <h3>Proje Kodu Seçimi</h3>
  <select id="projectCode">
    <option value="">Proje Kodunuzu Seçin</option>
    <option value="OykuTez">OykuTez</option>
    <option value="Izmir">Izmir</option>
    <option value="Esporcu">Esporcu</option>
    <option value="Sporcu">Sporcu</option>
    <option value="Diger">Diğer</option>
  </select>
  <div style="margin-top:8px"><button id="toParticipationBtn" class="bigBtn">Devam</button></div>
</div>

<!-- 2️⃣ KATILIM DURUMU -->
<div id="participationCard" class="card hidden">
  <h3>Katılım Durumu</h3>
  <div id="participationOptions"></div>
  <div style="margin-top:8px"><button id="toNextStepBtn" class="bigBtn">Devam</button></div>
</div>

<!-- 3️⃣ KATILIMCI KODU GİRİŞİ -->
<div id="enterCodeCard" class="card hidden">
  <h3>Katılımcı Kodu</h3>
  <p class="small">Lütfen önceki oturumda size verilen katılımcı kodunu giriniz.</p>
  <input id="previousCode" placeholder="Örnek: ABCD_12345">
  <div style="margin-top:8px"><button id="toStaiDirectBtn" class="bigBtn">Devam</button></div>
</div>

<!-- 4️⃣ KATILIMCI BİLGİLERİ -->
<div id="participantCard" class="card hidden">
  <h3>Katılımcı Bilgileri</h3>
  <input id="name" placeholder="Adınız">
  <input id="surname" placeholder="Soyadınız">
  <input id="age" type="number" placeholder="Yaşınız">
  <input id="race" placeholder="Doğum Yeri / Köken">
  <input id="motherTongue" placeholder="Anadiliniz">
  <input id="email" type="email" placeholder="E-posta adresiniz">
  <input id="phone" type="text" placeholder="Telefon numaranız">
  <select id="gender">
    <option value="">Cinsiyetinizi Seçiniz</option>
    <option value="Kadın">Kadın</option>
    <option value="Erkek">Erkek</option>
    <option value="Diğer">Diğer</option>
  </select>
  <div style="margin-top:8px"><button id="toConsentBtn" class="bigBtn">Devam</button></div>
</div>

<!-- 5️⃣ AYDINLATILMIŞ ONAM -->
<div id="consentCard" class="card hidden">
  <h3>Aydınlatılmış Onam Formu</h3>
  <div id="consentText">
    <p><b>Sayın Katılımcı,</b><br>Bu çalışma, işitsel algı ve dikkat süreçlerinin araştırılması amacıyla yürütülmektedir.
    Katılımınız gönüllülük esasına dayanır. Tüm veriler anonim olarak saklanacaktır.
    Dilediğiniz zaman çalışmadan ayrılabilirsiniz.</p>
    <p>Bu formu onaylayarak araştırmaya katılmayı kabul etmiş olursunuz.</p>
  </div>
  <label><input type="checkbox" id="consentAgree"> Okudum ve onaylıyorum</label>
  <div style="margin-top:8px">
    <button id="backToInfoBtn" class="bigBtn">Geri</button>
    <button id="toHandBtn" class="bigBtn">Devam</button>
  </div>
</div>

<!-- 6️⃣ EL KULLANIMI TESTİ -->
<div id="handUseCard" class="card hidden">
  <h3>El Kullanımı Testi</h3>
  <div id="handUseQuestions"></div>
  <div style="margin-top:8px"><button id="toStaiBtn" class="bigBtn">Devam</button></div>
</div>

<!-- 7️⃣ STAI FORMU -->
<div id="staiCard" class="card hidden">
  <h3>STAI-TXI Formu</h3>
  <div id="staiQuestions"></div>
  <div style="margin-top:8px"><button id="toHearingBtn" class="bigBtn">Devam</button></div>
</div>

<!-- 8️⃣ İŞİTME TESTİ -->
<div id="hearingCard" class="card hidden">
  <h3>İşitme Kontrolü</h3>
  <p>1500 Hz sesleri duyabildiğinizden emin olun.</p>
  <div><strong>Sağ Kulak</strong><br><input type="range" id="rightSlider" min="0" max="1" step="0.01" value="0.5"><button id="playRight" class="bigBtn">Oynat</button></div>
  <div><strong>Sol Kulak</strong><br><input type="range" id="leftSlider" min="0" max="1" step="0.01" value="0.5"><button id="playLeft" class="bigBtn">Oynat</button></div>
  <div style="margin-top:8px"><button id="toSessionIntro" class="bigBtn">Devam</button></div>
</div>

<!-- 9️⃣ DİKOTİK TESTİ, SON EKRAN ve TÜM ORİJİNAL JS -->
<script>
document.addEventListener("DOMContentLoaded",()=>{

// --- Seçim ekranları mantığı ---
const $id=i=>document.getElementById(i);
let participant={projectCode:""};

$id("toParticipationBtn").onclick=()=>{
  const code=$id("projectCode").value;
  if(!code){alert("Lütfen proje kodunu seçiniz.");return;}
  participant.projectCode=code;
  $id("projectCard").classList.add("hidden");
  $id("participationCard").classList.remove("hidden");
  renderParticipationOptions(code);
};

function renderParticipationOptions(code){
  const c=$id("participationOptions");
  c.innerHTML="";
  if(code==="OykuTez"){
    c.innerHTML=`
      <label><input type="radio" name="participation" value="1"> İlk kez katılıyorum</label><br>
      <label><input type="radio" name="participation" value="2"> Bir kez katıldım ama tamamlayamadım</label><br>
      <label><input type="radio" name="participation" value="3"> İkinci kez katılıyorum</label><br>
      <label><input type="radio" name="participation" value="4"> İki kez katıldım ancak tamamlayamadım</label>`;
  } else {
    c.innerHTML=`
      <label><input type="radio" name="participation" value="1"> İlk kez katılıyorum</label><br>
      <label><input type="radio" name="participation" value="2"> Daha önce katıldım / tamamlayamadım</label>`;
  }
}

$id("toNextStepBtn").onclick=()=>{
  const val=document.querySelector('input[name="participation"]:checked');
  if(!val){alert("Lütfen bir seçenek seçiniz.");return;}
  const sel=val.value;
  if(sel==="1"){
    $id("participationCard").classList.add("hidden");
    $id("participantCard").classList.remove("hidden");
  }else{
    $id("participationCard").classList.add("hidden");
    $id("enterCodeCard").classList.remove("hidden");
  }
};

$id("toStaiDirectBtn").onclick=()=>{
  const prev=$id("previousCode").value.trim();
  if(!prev){alert("Lütfen kodunuzu giriniz.");return;}
  participant.code=prev;
  $id("enterCodeCard").classList.add("hidden");
  startStaiOnly();
};

// Yeni katılımcı akışı (bilgi → onam → el → stai)
$id("toConsentBtn").onclick=()=>{
  const n=$id("name").value.trim(), s=$id("surname").value.trim(), a=$id("age").value.trim(), g=$id("gender").value.trim();
  if(!n||!s||!a||!g){alert("Lütfen tüm bilgileri doldurunuz.");return;}
  participant.name=n; participant.surname=s; participant.age=a; participant.gender=g;
  participant.race=$id("race").value; participant.motherTongue=$id("motherTongue").value;
  participant.email=$id("email").value; participant.phone=$id("phone").value;
  if(participant.projectCode==="OykuTez"){
    $id("participantCard").classList.add("hidden");
    $id("consentCard").classList.remove("hidden");
  }else{
    $id("participantCard").classList.add("hidden");
    $id("handUseCard").classList.remove("hidden");
    renderHand();
  }
};

$id("toHandBtn").onclick=()=>{
  if(!$id("consentAgree").checked){alert("Onam formunu onaylamalısınız.");return;}
  $id("consentCard").classList.add("hidden");
  $id("handUseCard").classList.remove("hidden");
  renderHand();
};

// --- Buradan sonrası senin orijinal test kodunun aynısı ---


/* consent back */
$id('backToInfoBtn').onclick = () => {
  $id('consentCard').classList.add('hidden');
  $id('participantCard').classList.remove('hidden');
};

/* consent -> hand */
$id('toHandBtn').onclick = () => {
  if(!$id('consentAgree').checked){ alert("Lütfen onam kutusunu işaretleyiniz."); return; }
  $id('consentCard').classList.add('hidden');
  $id('handUseCard').classList.remove('hidden');
  renderHand();
};

/* hand back */
$id('backToParticipantFromHand').onclick = () => {
  $id('handUseCard').classList.add('hidden');
  $id('participantCard').classList.remove('hidden');
};

/* hand -> STAI */
$id('toStaiBtn').onclick = () => {
  const rows = document.querySelectorAll('#handUseQuestions .hand-grid-row');
  for(const r of rows){ if(r.querySelectorAll('input:checked').length !== 2){ alert("Her satırda 2 kutucuk işaretleyiniz."); return; } }
  participant.handUse = Array.from(rows).map(r=>({
    q: r.dataset.q,
    left: r.querySelectorAll('.left:checked').length,
    right: r.querySelectorAll('.right:checked').length
  }));
  $id('handUseCard').classList.add('hidden');
  renderStai();
  $id('staiCard').classList.remove('hidden');
};

/* STAI back */
$id('backToHandFromStai').onclick = () => {
  $id('staiCard').classList.add('hidden');
  $id('handUseCard').classList.remove('hidden');
};

/* STAI -> hearing */
$id('toHearingBtn').onclick = () => {
  const answered = document.querySelectorAll('#staiQuestions input:checked').length;
  const total = document.querySelectorAll('#staiQuestions input[type=radio]').length/4;
  if(answered < total){ alert("Lütfen tüm STAI sorularını yanıtlayınız."); return; }
  // store STAI
  const ans = {};
  document.querySelectorAll('#staiQuestions input:checked').forEach(i => ans[i.name] = i.value);
  participant.staiAnswers = ans;

  $id('staiCard').classList.add('hidden');
  $id('hearingCard').classList.remove('hidden');
};

/* hearing back */
$id('backToStaiFromHearing').onclick = () => {
  stopTone('right'); stopTone('left');
  $id('hearingCard').classList.add('hidden');
  $id('staiCard').classList.remove('hidden');
};

/* hearing -> session intro */
$id('toSessionIntro').onclick = () => {
  stopTone('right'); stopTone('left');
  // save hearing levels
  participant.rightLevel = rightLevel;
  participant.leftLevel = leftLevel;
  results.push({ session: "hearing_level", stim: "1500Hz", response: `right=${rightLevel},left=${leftLevel}`, code: participant.code });
  $id('hearingCard').classList.add('hidden');

  sessionOrder = ['training','NF', ...shuffle(['FR','FL'])];
  currentSessionIndex = 0;
  showSessionIntro();
};

/* ---------- Render helpers ---------- */
function renderHand(){
  const c = $id('handUseQuestions');
  const q = ["Yazmak","Çizmek","Taş atmak","Makas kullanmak","Diş fırçası kullanmak","Bıçak kullanmak","Kaşık kullanmak","Süpürge (üst el)","Kibrit çakmak","Kutunun kapağını açmak"];
  c.innerHTML = '<div class="hand-grid-header"><div style="flex:2"></div><div style="flex:1;text-align:center">Sol</div><div style="flex:1;text-align:center">Sağ</div></div>';
  q.forEach((txt,i)=>{
    c.innerHTML += `<div class="hand-grid-row" data-q="${i+1}"><span>${i+1}. ${txt}</span>
      <div class="col"><input type="checkbox" class="left"><input type="checkbox" class="left"></div>
      <div class="col"><input type="checkbox" class="right"><input type="checkbox" class="right"></div>
    </div>`;
  });
}

function renderStai(){
  const questions = ["Şu anda sakinim","Kendimi emniyette hissediyorum","Şu anda sinirlerim gergin","Pişmanlık duygusu içindeyim","Şu anda huzur içindeyim","Şu anda hiç keyfim yok","Başıma geleceklerden endişe ediyorum","Kendimi dinlenmiş hissediyorum","Şu anda kaygılıyım","Kendimi rahat hissediyorum","Kendime güvenim var","Şu anda asabım bozuk","Çok sinirliyim","Sinirlerimin çok gergin olduğunu hissediyorum","Kendimi rahatlamış hissediyorum","Şu anda halimden memnunum","Şu anda endişeliyim","Heyecandan kendimi şaşkına dönmüş hissediyorum","Şu anda sevinçliyim","Şu anda keyfim yerinde"];
  const c = $id('staiQuestions'); c.innerHTML = '';
  questions.forEach((txt,i)=>{
    c.innerHTML += `<div class="question-group"><p>${i+1}. ${txt}</p>
      <div class="stai-options">
        <label><input type="radio" name="staiQ${i+1}" value="1">Hiç</label>
        <label><input type="radio" name="staiQ${i+1}" value="2">Biraz</label>
        <label><input type="radio" name="staiQ${i+1}" value="3">Çok</label>
        <label><input type="radio" name="staiQ${i+1}" value="4">Tamamıyla</label>
      </div></div>`;
  });
}

/* ---------- Audio helpers ---------- */
function ensureCtx(){ if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
function startTone(ch){
  ensureCtx();
  if(ch==='right' && !rightOsc){
    rightOsc = audioCtx.createOscillator(); rightGain = audioCtx.createGain();
    rightOsc.frequency.value = 1500; rightGain.gain.value = Number(rightLevel);
    const m = audioCtx.createChannelMerger(2); rightOsc.connect(rightGain); rightGain.connect(m,0,1); m.connect(audioCtx.destination); rightOsc.start();
  }
  if(ch==='left' && !leftOsc){
    leftOsc = audioCtx.createOscillator(); leftGain = audioCtx.createGain();
    leftOsc.frequency.value = 1500; leftGain.gain.value = Number(leftLevel);
    const m = audioCtx.createChannelMerger(2); leftOsc.connect(leftGain); leftGain.connect(m,0,0); m.connect(audioCtx.destination); leftOsc.start();
  }
}
function stopTone(ch){ try{ if(ch==='right'&&rightOsc){ rightOsc.stop(); rightOsc=null; rightGain=null;} if(ch==='left'&&leftOsc){ leftOsc.stop(); leftOsc=null; leftGain=null;} }catch(e){} }

$id('playRight').onclick = ()=>{ if(rightOsc){ stopTone('right'); } else { stopTone('left'); startTone('right'); } };
$id('playLeft').onclick  = ()=>{ if(leftOsc){ stopTone('left'); } else { stopTone('right'); startTone('left'); } };
$id('rightSlider').oninput = e => { rightLevel = e.target.value; if(rightGain) rightGain.gain.value = Number(rightLevel); };
$id('leftSlider').oninput  = e => { leftLevel = e.target.value; if(leftGain) leftGain.gain.value = Number(leftLevel); };

/* ---------- Session / Trials ---------- */
function showSessionIntro(){
  const s = sessionOrder[currentSessionIndex];
  $id('sessionTitle').innerText = "Oturum: " + s;
  $id('sessionInstr').innerHTML = instr[s];
  $id('sessionIntro').classList.remove('hidden');
}
async function unlockAudio(){
  try{
    const a = $id('stimAudio'); a.src = CONFIG.AUDIO_PATH + "silence.wav"; await a.play(); a.pause(); a.currentTime = 0;
  }catch(e){ console.warn("Audio unlock failed:", e); }
}
$id('sessionStartBtn').onclick = async ()=>{
  $id('sessionIntro').classList.add('hidden');
  await unlockAudio();
  $id('waitScreen').classList.remove('hidden');
  setTimeout(()=>{ $id('waitScreen').classList.add('hidden'); startSession(); }, 2000);
};

function startSession(){ currentTrial = -1; $id('trialCard').classList.remove('hidden'); nextTrial(); }
function nextTrial(){
  clearTimeout(trialTimeout);
  const sessionType = sessionOrder[currentSessionIndex];
  const playlist = (sessionType === 'training') ? trainingPlaylist : mainPlaylist;
  currentTrial++;
  if(currentTrial >= playlist.length){
    $id('trialCard').classList.add('hidden');
    currentSessionIndex++;
    if(currentSessionIndex < sessionOrder.length){ showSessionIntro(); }
    else { endExperiment(); }
    return;
  }
  const stim = playlist[currentTrial];
  $id('trialStatus').innerText = `Deneme ${currentTrial+1}/${playlist.length} (${sessionType})`;
  playStim(stim);
}

function playStim(stim){
  const a = $id('stimAudio');
  isResponseAllowed = false;
  a.src = CONFIG.AUDIO_PATH + stim;
  a.play().catch(e=>console.warn("play error",e));
  a.onplaying = () => {
    setTimeout(()=>{ isResponseAllowed = true; }, 500);
  };
  trialTimeout = setTimeout(()=>{
    if(sessionOrder[currentSessionIndex] !== 'training'){
      results.push({ session: sessionOrder[currentSessionIndex], trial: currentTrial+1, stim: stim, response: "no_response", code: participant.code, age: participant.age, gender: participant.gender });
    }
    nextTrial();
  }, 4000);
}

/* response buttons */
document.querySelectorAll('.respBtn').forEach(btn=>{
  btn.onclick = ()=>{
    if(!isResponseAllowed) return;
    isResponseAllowed = false;
    clearTimeout(trialTimeout);
    const resp = btn.dataset.val;
    const sessionType = sessionOrder[currentSessionIndex];
    const playlist = (sessionType === 'training') ? trainingPlaylist : mainPlaylist;
    const stim = playlist[currentTrial];

    if(sessionType !== 'training'){
      results.push({
        session: sessionType,
        trial: currentTrial+1,
        stim: stim,
        response: resp,
        rightLevel: participant.rightLevel || "",
        leftLevel: participant.leftLevel || "",
        age: participant.age || "",
        gender: participant.gender || "",
        race: participant.race || "",
        motherTongue: participant.motherTongue || "",
        code: participant.code || ""
      });
    }

    btn.classList.add('respBtn-active');
    setTimeout(()=>{ btn.classList.remove('respBtn-active'); }, 500);
    setTimeout(()=>{ nextTrial(); }, 2500);
  };
});

/* ---------- End & Data ---------- */
async function endExperiment(){
  $id('endCard').classList.remove('hidden');
  const csv = makeCsv();
  $id('doneLog').innerText = "Veri hazır. (CSV satır sayısı: " + (csv ? csv.split('\\n').length : 0) + ")";
  // sendEmail(); // opsiyonel: e-posta göndermek istersen yorumdan çıkar
}

function makeCsv(){
  const allData = [
    {
      session: "info",
      trial: 0,
      stim: "",
      response: "",
      rightLevel: participant.rightLevel || "",
      leftLevel: participant.leftLevel || "",
      age: participant.age || "",
      gender: participant.gender || "",
      race: participant.race || "",
      motherTongue: participant.motherTongue || "",
      email: participant.email || "",
      phone: participant.phone || "",
      projectCode: participant.projectCode || "",
      staiAnswers: JSON.stringify(participant.staiAnswers || {}),
      handUseAnswers: JSON.stringify(participant.handUse || {}),
      code: participant.code || ""
    },
    ...results
  ];
  const keys = ["session","trial","stim","response","rightLevel","leftLevel","age","gender","race","motherTongue","email","phone","projectCode","staiAnswers","handUseAnswers","code"];
  const header = keys.join(',');
  const rows = allData.map(r=> keys.map(k=>{
    const v = (r[k] === null || r[k] === undefined) ? "" : String(r[k]).replace(/,/g,';');
    return `"${v}"`;
  }).join(','));
  return [header, ...rows].join('\\n');
}

/* sendEmail (optional, using emailjs) */
async function sendEmail(){
  const csv = makeCsv();
  if(!csv) return;
  const projectCode = participant.projectCode || 'Diger';
  const templateID = CONFIG.EMAILJS_TEMPLATES[projectCode] || CONFIG.EMAILJS_TEMPLATES['Diger'];
  try{
    if(!window.emailjs){
      const s = document.createElement('script'); s.src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js";
      await new Promise((res,rej)=>{ s.onload=res; s.onerror=rej; document.head.appendChild(s); });
      emailjs.init(CONFIG.EMAILJS_USER);
    }
    const resp = await emailjs.send(CONFIG.EMAILJS_SERVICE, templateID, { subject: participant.code, message: csv });
    $id('doneLog').innerText = "E-posta gönderim durumu: " + JSON.stringify(resp);
  }catch(err){
    alert("E-posta gönderilemedi: " + JSON.stringify(err));
  }
}

/* ---------- Init UI ---------- */
renderStai(); // prepare stai markup (will be re-rendered when needed)
}); // DOMContentLoaded end
</script>
</body>
</html>
