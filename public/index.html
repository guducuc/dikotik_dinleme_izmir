<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dikotik Dinleme — Tam Sürüm</title>

<meta name="emailjs-user"    content="FLn2zMqKDGso3ePoO">
<meta name="emailjs-service" content="service_a8bnfmk">
<meta name="emailjs-template"content="template_r6sddff">

<style>
  body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:12px;color:#111;max-width:480px;margin:auto}
  h1{font-size:20px;margin-bottom:10px}
  .card{padding:12px;border:1px solid #ddd;border-radius:8px;margin-bottom:12px}
  .hidden{display:none}
  input,select,textarea{padding:8px;margin:6px 0;width:100%;box-sizing:border-box}

  input[type="radio"], input[type="checkbox"] {
    width: auto; 
    margin-right: 6px; 
  }
  
  #participationOptions label {
      display: block;
      margin-bottom: 8px; 
  }

  .bigBtn{font-size:1rem;padding:10px 14px;border-radius:8px;border:1px solid #444;background:#eaeaea;cursor:pointer}
  .btnGreen{background:#2ecc71;color:white;border:none}
  .btnRed{background:#e74c3c;color:white;border:none}
  
  .respRow{
    display: grid; 
    grid-template-columns: 1fr 1fr; 
    gap: 8px; 
    margin-top: 8px;
    padding: 0 12px; 
  }

  .respBtn{
    padding:10px 14px;
    border-radius:8px;
    border:1px solid #444;
    background:#f2f2f2;
    cursor:pointer;
    text-align: center;
  }

  .respBtn-active{background:#bdbdbd}
  .stai-options{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
  .hand-grid-header{display:flex;justify-content:space-between;margin-bottom:6px;font-weight:600}
  .hand-grid-row{display:flex;align-items:center;justify-content:space-between;border-top:1px solid #eee;padding:6px 0}
  .hand-grid-row span{flex:2}
  .hand-grid-row .col{flex:1;display:flex;justify-content:center;gap:8px}
  .small{font-size:13px;color:#666}
  .question-group{margin-bottom:10px}
  .linklike{color:#007bff;cursor:pointer;text-decoration:underline}

  .modal{position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:none}
  .modal-content{background:#fff;margin:5% auto;padding:20px;border-radius:10px;max-width:600px;max-height:80vh;overflow-y:auto}
  .close{float:right;font-size:24px;font-weight:bold;cursor:pointer;color:#888}
  .close:hover{color:#000}
</style>
</head>
<body>
<h1>Dikotik Dinleme</h1>

<div id="projectCard" class="card">
  <h3>Proje Kodu Seçimi</h3>
  <select id="projectCode">
    <option value="">Proje kodu seçiniz</option>
    <option value="OykuTez">Öykü Tez</option>
    <option value="Izmir">İzmir</option>
    <option value="Esporcu">Esporcu</option>
    <option value="Sporcu">Sporcu</option>
  </select>
  <div style="margin-top:8px"><button id="toParticipationBtn" class="bigBtn">Devam</button></div>
</div>

<div id="participationCard" class="card hidden">
  <h3>Katılım Durumu</h3>
  <div id="participationOptions" class="small"></div>
  <div style="margin-top:8px"><button id="toNextStepBtn" class="bigBtn">Devam</button></div>
</div>

<div id="consentCard" class="card hidden">
  <h3>Aydınlatılmış Onam</h3>
  <div id="consentText" style="border:1px solid #ddd;padding:8px;border-radius:6px;max-height:220px;overflow:auto; background:#f9f9f9; font-size:14px;">
    </div>
  <div id="consentButtons" style="display:flex;gap:8px;margin-top:10px">
    <button id="consentAccept" class="bigBtn btnGreen">Okudum, onaylıyorum</button>
    <button id="consentDecline" class="bigBtn btnRed">Kabul etmiyorum</button>
  </div>
  <div id="consentDeclinedMsg" class="small hidden" style="margin-top:10px;color:#c0392b; font-weight:bold;">
    Katılım kabul edilmedi. Deney sonlandırıldı. Sayfayı kapatabilirsiniz.
  </div>
</div>

<div id="consentModal" class="modal">
  <div class="modal-content">
    <span id="closeConsentModal" class="close">&times;</span>
    <h3>Aydınlatılmış Onam Formu (Tam Metin)</h3>
    <div id="modalConsentBody">
        </div>
  </div>
</div>

<div id="infoCard" class="card hidden">
  <h3>Katılımcı Bilgileri</h3>
  <div class="small">Ad ve soyad için ilk 2 harf yeterli (gizlilik).</div>
  <input id="name" placeholder="Ad (ilk 2 harf)">
  <input id="surname" placeholder="Soyad (ilk 2 harf)">
  <input id="age" type="number" placeholder="Yaş">
  <input id="email" type="email" placeholder="E-posta adresiniz">
  <input id="phone" type="tel" placeholder="Telefon numaranız">
  <input id="race" placeholder="Doğum yeri / Irk">
  <input id="motherTongue" placeholder="Anadiliniz">
  <select id="gender"><option value="">Cinsiyet</option><option>Kadın</option><option>Erkek</option><option>Diğer</option></select>
  <div id="codeInfo" class="small" style="margin-top:6px;color:#2c3e50"></div>
  <div style="margin-top:8px"><button id="toHandFromInfo" class="bigBtn">Devam</button></div>
</div>

<div id="enterCodeCard" class="card hidden">
  <h3>Önceki Katılımcı Kodu</h3>
  <div class="small">Daha önce katıldıysanız lütfen katılımcı kodunuzu girin.</div>
  <input id="previousCode" placeholder="Örnek: OY_AB_12345">
  <div style="margin-top:8px"><button id="toStaiDirectBtn" class="bigBtn">Devam</button></div>
</div>

<div id="handUseCard" class="card hidden">
  <h3>El Kullanımı Testi</h3>
  <p class="small">Lütfen her işlem için kullandığınız eli işaretleyin. Her satır için toplam 2 kutucuk işaretlemeyi unutmayın!</p>
  <div id="handUseQuestions"></div>
  <div style="margin-top:8px"><button id="toStaiBtn" class="bigBtn">Devam</button></div>
</div>

<div id="staiCard" class="card hidden">
  <h3>STAI-TXI Formu</h3>
  <p class="small">Her ifadeyi okuyun, anında nasıl hissettiğinizi gösteren cevabı işaretleyin.</p>
  <div id="staiQuestions"></div>
  <div style="margin-top:8px"><button id="toHearingBtn" class="bigBtn">Devam</button></div>
</div>

<div id="hearingCard" class="card hidden">
  <h3>İşitme Kontrolü</h3>
  <p class="small">Lütfen kulaklığınızı takın! Sol ve sağ kulak için ayrı ayrı sesi dinleyin.</p>
  <div style="margin-top:8px">
    <label><b>Sol Kulak</b></label>
    <input type="range" id="leftSlider" min="0" max="1" step="0.01" value="0.5">
    <button id="playLeft" class="bigBtn">Sol Oynat</button>
  </div>
  <div style="margin-top:12px">
    <label><b>Sağ Kulak</b></label>
    <input type="range" id="rightSlider" min="0" max="1" step="0.01" value="0.5">
    <button id="playRight" class="bigBtn">Sağ Oynat</button>
  </div>
  <div style="margin-top:12px"><button id="toSessionIntro" class="bigBtn">Devam</button></div>
</div>

<div id="sessionIntro" class="card hidden">
  <h3 id="sessionTitle"></h3>
  <p id="sessionInstr"></p>
  <div style="margin-top:8px"><button id="sessionStartBtn" class="bigBtn">Başla</button></div>
</div>

<div id="trialCard" class="card hidden">
  <div id="trialStatus" class="small" style="margin-bottom:8px"></div>
  <audio id="stimAudio" preload="auto"></audio>
  <div class="respRow">
    <button class="respBtn" data-val="BA">BA</button>
    <button class="respBtn" data-val="DA">DA</button>
    <button class="respBtn" data-val="GA">GA</button>
    <button class="respBtn" data-val="KA">KA</button>
    <button class="respBtn" data-val="PA">PA</button>
    <button class="respBtn" data-val="TA">TA</button>
  </div>
</div>

<div id="endCard" class="card hidden">
  <h3>Deney tamamlandı ✅</h3>
  <div id="doneLog" class="small"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', ()=>{

/* ---------- helpers & state ---------- */
const $id = id => document.getElementById(id);
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] } return arr; }

let participant = {}, results = [], sessionOrder = [], currentSessionIndex = 0, currentTrial = -1;
let audioCtx=null,leftOsc=null,rightOsc=null,leftGain=null,rightGain=null;
let isResponseAllowed=false, trialTimeout=null, responseStart=0;

/* ---------- DINAMIK ONAM METINLERI ---------- */
const CONSENT_TEXTS = {
    "OykuTez": `
        <p><b>Araştırmanın Adı:</b> WEB Tabanlı Türkçe Dikotik Dinleme Testi Test – Tekrar Test Güvenirliği</p>
        <p><b>Sorumlu:</b> Dr. Öğr. Üyesi Emre Eskicioğlu & Öykü Akkay</p>
        <p>Bu araştırma, Türkçe heceler içeren web tabanlı olarak geliştirilen dikotik dinleme testinin güvenirliğini değerlendirmeyi amaçlar. Normal şartlarda yalnızca laboratuvar ortamında uygulanabilen bu testin dijital ortama aktarılmasıyla daha geniş katılımcı gruplarına ulaşılması hedeflenmektedir. Bu tez araştırmasının en az 20 kişiye ulaştırılması hedeflenmektedir.</p>
        <p>Araştırmanın uygulama süreci toplamda 2 hafta olarak planlanmaktadır. İlk test uygulamasından sonra, ikinci test uygulaması 14 gün sonra yapılacaktır. Her bir oturum yaklaşık 20 dakika sürecek olup toplamda katılımcının araştırma sürecine ayıracağı süre 40 dakika olacaktır.</p>
    `,
    "Esporcu": `
        <h4>Esporcu Onam Formu</h4>
        <p>Bu çalışma, profesyonel esporcuların işitsel dikkat ve nörobilişsel tepkilerini ölçmek amacıyla tasarlanmıştır. Katılımınız, bu alandaki bilimsel verilere önemli katkı sağlayacaktır.</p>
        <p><i>DOKUZ EYLÜL ÜNİVERSİTESİ
“GİRİŞİMSEL OLMAYAN KLİNİK ARAŞTIRMALAR”
İÇİN BİLGİLENDİRİLMİŞ GÖNÜLLÜ OLUR FORMU

Araştırmanın Adı: Basketbolcu ve Elektronik Sporcularda İşitsel Dikkat ve Beyin Asimetrisinin Değerlendirilmesi

Sorumlu Araştırmacının Adı: Dr. Öğr.Üyesi Emre Eskicioğlu
Yardımcı Araştırmacının Adı: Doç. Dr. Egemen MANCI
Doç.Dr. Çağdaş Güdücü
Destekleyici (varsa):

	“Basketbolcu ve Elektronik Sporcularda İşitsel Dikkat ve Beyin Asimetrisinin Değerlendirilmesi” isimli araştırmada yer almak üzere davet edilmiş bulunmaktasınız. Bu çalışma bilimsel araştırma amaçlı olarak yapılmaktadır ve katılım gönüllülük esasına dayalıdır. 

Bu araştırmaya katılıp katılmama kararını vermeden önce, araştırmanın neden ve nasıl yapılacağını bilmeniz gerekmektedir. Bu nedenle bu formun okunup anlaşılması büyük önem taşımaktadır. Eğer anlayamadığınız ve sizin için açık olmayan şeyler varsa, ya da fazla bilgi isterseniz size iletişim bilgileri verilen araştırmacıya sorabilirsiniz.

Araştırmanın amacı nedir; benden başka kaç kişi bu araştırmaya katılacak? 
Bu başlık altında aşağıdaki bilgiler yer almalıdır:
●	Araştırmanın amacı,
Bu araştırmanın amacı geleneksel sporcular ile elektronik sporcuların işitsel dikkat ve beyin asimetrisini incelenmesidir.
●	Araştırmaya kaç kişinin alınmasının planlandığı 
Bu araştırmaya sizinle birlikte, sizin yaş grubunuzdan ortalama 22 kişinin alınması planlanmaktadır.

Bu araştırmaya katılırsam beni ne bekliyor?
Bu başlık altında aşağıdaki bilgiler yer almalıdır:
●	Araştırmanın hangi yöntemlerle gerçekleştirileceği,
Bu araştırma kapsamında sizlerden yaş, cinsiyet, sporculuk bilgileri ile birlikte bir bilgisayar ya da cep telefonu yardımıyla yaklaşık 10 dk. sürecek dikotik dinleme testleri uygulanacaktır. Dikotik dinleme testi kulaklıkla her iki kulağınıza da /ba/, /da/, /ga/, /ka/, /pa/ ve /ta/ hecelerinin dinletilmesi ile yapılmaktadır. Bu testte seçeceğiniz heceler ile işitsel dikkat ve beyin asimetrisinin değerlendirilmesi yapılacaktır.
●	Araştırmanın süresi
Araştırmanın toplamda bir katılımcı için 15 dk. sürmesi planlanmaktadır. 

Bu araştırmaya katılmalı mıyım? 
Bu araştırmada yer almak tamamen size bağlıdır. Şimdi bu formu imzalarsanız bile istediğiniz herhangi bir zamanda bir neden göstermeksizin araştırmadan ayrılmakta özgürsünüz. 

Araştırmanın olası riskleri nelerdir?
Araştırmada sadece diz üstü bilgisayar veya cep telefonu aracılığı ile veri toplanacağı için araştırma sırasında ortaya çıkabilecek olası bir yan etki / komplikasyon beklenmemektedir. 

Araştırmanın olası riskleri konusunda ne gibi önlemler alınacak?
Araştırmada sadece diz üstü bilgisayar veya cep telefonu aracılığı ile veri toplanacağı için araştırma sırasında ortaya çıkabilecek olası bir yan etki / komplikasyon beklenmemektedir. 
	
Bu araştırmaya katılmamın maliyeti nedir? 
Bu araştırmada yer almak tümüyle sizin isteğinize bağlıdır. Bu araştırma için size herhangi bir ödeme yapılmayacaktır. Araştırma sırasında oluşabilecek masraflar size ve bağlı olduğunuz kuruma ödetilmeyecektir.

Kişisel bilgilerim nasıl kullanılacak? 
Araştırmayı yapan araştırmacı kişisel bilgilerinizi, araştırmayı ve istatiksel analizleri yürütmek için kullanacaktır ancak kimlik bilgileriniz tıp etiği ve KVKK düzenlenmelerine uygun şekilde gizli tutulacaktır. Araştırma için kullanılacak bilgileriniz üçüncü kişilerle paylaşılmayacaktır. 
Yalnızca gereği halinde, sizinle ilgili bilgileri etik kurullar ya da resmi makamlar inceleyebilir. Araştırmanın sonunda, kendi sonuçlarınızla ilgili bilgi istemeye hakkınız vardır. Araştırma sonuçları araştırma bitiminde tıbbi literatürde yayınlanabilecektir ancak kimliğiniz açıklanmayacaktır. 

KATILIMCININ

 Biyofizik Anabilim dalında, Dr. Öğr. Üyesi Emre Eskicioğlu tarafından bir araştırma yapılacağı belirtilerek bu araştırma ile ilgili yukarıdaki bilgiler bana aktarıldı ve ilgili metni okudum. 

Araştırmaya katılmam konusunda zorlayıcı bir davranışla karşılaşmış değilim. Projenin yürütülmesi sırasında herhangi bir neden göstermeden araştırmadan çekilebilirim. (Ancak araştırmacıları zor durumda bırakmamak için araştırmadan çekileceğimi önceden bildirmemim uygun olacağının bilincindeyim). Araştırmacı tarafından araştırma dışı da tutulabileceğim konusunda bilgilendirildim.Araştırma için yapılacak harcamalarla ilgili herhangi bir parasal sorumluluk altına girmiyorum. Bana da bir ödeme yapılmayacaktır. Araştırmadan elde edilen benimle ilgili kişisel bilgilerin gizliliğinin korunacağını biliyorum.Araştırma uygulamasından kaynaklanan nedenlerle meydana gelebilecek herhangi bir sağlık sorunumun ortaya çıkması halinde, her türlü tıbbi müdahalenin sağlanacağı konusunda gerekli güvence verildi. (Bu tıbbi müdahalelerle ilgili olarak da parasal bir yük altına girmeyeceğim).Araştırma sırasında bir sağlık sorunu ile karşılaştığımda; herhangi bir saatte, Dr. Öğr. Üyesi Emre Eskicioğlu’nu, “0555 740 0187” numaralı telefondan arayabileceğimi biliyorum. Bana yapılan tüm açıklamaları ayrıntılarıyla anlamış bulunmaktayım. Bu koşullarla söz konusu klinik araştırmaya kendi rızamla, hiçbir baskı ve zorlama olmaksızın, gönüllülük içerisinde katılmayı kabul ediyorum.

İmzalı bu form kağıdının bir kopyası bana verilecektir.
Katılımcı                   
Adı, soyadı:
Adres:
Tel: 
İmza:
Tarih:

Görüşme tanığı
Adı, soyadı:
Adres:
Tel: 
İmza:
Tarih:

Katılımcı ile görüşen araştırmacı                                                   
Adı soyadı, unvanı:  Doç.Dr. Egemen MANCI
Adres: İzmir Demokrasi Üniversitesi Sağlık Bilimleri Fakültesi, Egzersiz ve Spor Bilimleri Bölümü 
Tel: 0506 592 66 47 
İmza:
Tarih:

Sorumlu araştırmacı                                                   
Adı soyadı, unvanı: Dr. Öğr. Üyesi Emre ESKİCİOĞLU
Adres: Dokuz Eylül Üniversitesi Tıp Fakültesi Biyofizik ABD, 35340 İnciraltı/İZMİR
Tel: 0555 740 01 87
İmza:
Tarih:
 

AYDINLATMA ve KATILIMCININ BEYANI KESİNLİKLE BİRBİRLERİNİN DEVAMI ŞEKLİNDE OLACAKTIR. AYRI AYRI SAYFALARDA YER ALMAYACAKTIR.	
 </i></p>
    `,
    "Sporcu": `
        <h4>Sporcu Onam Formu</h4>
        <p>Bu çalışma, sporcuların yoğun fiziksel aktivite sonrası işitsel algılama süreçlerini incelemeyi amaçlayan bir biyofizik araştırmasıdır.</p>
        <p><i>(Buraya Sporcu projesine özel detaylı metninizi ekleyebilirsiniz)</i></p>
    `,
    "Izmir": `
        <h4>İzmir Projesi Onam Formu</h4>
        <p>İzmir genelindeki katılımcılar için işitsel algı süreçlerini inceleme araştırmasıdır.</p>
    `
};

/* ---------- STAI & hand questions ---------- */
const staiQuestions = [
"Şu anda sakinim","Kendimi emniyette hissediyorum","Şu anda sinirlerim gergin",
"Pişmanlık duygusu içindeyim","Şu anda huzur içindeyim","Şu anda hiç keyfim yok",
"Başıma geleceklerden endişe ediyorum","Kendimi dinlenmiş hissediyorum","Şu anda kaygılıyım",
"Kendimi rahat hissediyorum","Kendime güvenim var","Şu anda asabım bozuk","Çok sinirliyim",
"Sinirlerimin çok gergin olduğunu hissediyorum","Kendimi rahatlamış hissediyorum",
"Şu anda halimden memnunum","Şu anda endişeliyim","Heyecandan kendimi şaşkına dönmüş hissediyorum",
"Şu anda sevinçliyim","Şu anda keyfim yerinde"
];

const handQs = ["Yazmak","Çizmek","Taş Atmak","Makas kullanmak","Diş fırçası kullanmak","Bıçak kullanmak","Kaşık kullanmak","Süpürge (üst el)","Kibrit çakmak","Kutunun kapağını açmak"];

function renderStai(){
  const c = $id('staiQuestions'); c.innerHTML = '';
  staiQuestions.forEach((q,i)=>{
    c.innerHTML += `<div class="question-group"><p>${i+1}. ${q}</p>
      <div class="stai-options">
        <label><input type="radio" name="staiQ${i+1}" value="1">Hiç</label>
        <label><input type="radio" name="staiQ${i+1}" value="2">Biraz</label>
        <label><input type="radio" name="staiQ${i+1}" value="3">Çok</label>
        <label><input type="radio" name="staiQ${i+1}" value="4">Tamamıyla</label>
      </div></div>`;
  });
}

function renderHand(){
  const c = $id('handUseQuestions'); c.innerHTML = `<div class="hand-grid-header"><div style="flex:2"></div><div style="flex:1;text-align:center">Sol</div><div style="flex:1;text-align:center">Sağ</div></div>`;
  handQs.forEach((q,i)=>{
    c.innerHTML += `<div class="hand-grid-row" data-q="${i+1}"><span>${i+1}. ${q}</span>
      <div class="col"><input type="checkbox" class="left"><input type="checkbox" class="left"></div>
      <div class="col"><input type="checkbox" class="right"><input type="checkbox" class="right"></div>
    </div>`;
  });
}

/* ---------- FLOW: project -> participation ---------- */
$id('toParticipationBtn').onclick = ()=>{
  const proj = $id('projectCode').value;
  if(!proj){ alert('Lütfen proje kodu seçiniz.'); return; }
  participant.projectCode = proj;
  $id('projectCard').classList.add('hidden');
  $id('participationCard').classList.remove('hidden');
  renderParticipationOptions(proj);
};

function renderParticipationOptions(project){
  const el = $id('participationOptions'); el.innerHTML = '';
  if(project === 'OykuTez'){
    el.innerHTML = `
      <label><input type="radio" name="participation" value="1"> İlk kez katılıyorum</label>
      <label><input type="radio" name="participation" value="2"> Bir kez katıldım ama tamamlayamadım</label>
      <label><input type="radio" name="participation" value="3"> İkinci kez katılıyorum</label>
      <label><input type="radio" name="participation" value="4"> İki kez katıldım ancak tamamlayamadım</label>
    `;
  } else {
    el.innerHTML = `
      <label><input type="radio" name="participation" value="1"> İlk kez katılıyorum</label>
      <label><input type="radio" name="participation" value="2"> Bir kez katıldım ama tamamlayamadım</label>
    `;
  }
}

$id('toNextStepBtn').onclick = ()=>{
  const sel = document.querySelector('input[name="participation"]:checked');
  if(!sel){ alert('Lütfen bir seçenek seçiniz.'); return; }
  const val = sel.value;
  participant.participation = val;
  $id('participationCard').classList.add('hidden');
  
  if(val === '1'){
    // DINAMIK METNI YUKLE
    const text = CONSENT_TEXTS[participant.projectCode] || "<p>Onam formu bulunamadı.</p>";
    $id('consentText').innerHTML = text;
    $id('modalConsentBody').innerHTML = text;
    $id('consentCard').classList.remove('hidden');
  } else {
    $id('enterCodeCard').classList.remove('hidden');
  }
};

// Modal popup control
$id('consentText').insertAdjacentHTML('beforebegin', '<button id="openConsentPopup" class="bigBtn" style="margin-bottom:10px">Onam Formunu Görüntüle</button>');
$id('openConsentPopup').onclick=()=>{ $id('consentModal').style.display='block'; };
$id('closeConsentModal').onclick=()=>{ $id('consentModal').style.display='none'; };
window.onclick=e=>{ if(e.target==$id('consentModal')) $id('consentModal').style.display='none'; };

/* ---------- Consent buttons ---------- */
$id('consentAccept').onclick = ()=>{
  $id('consentCard').classList.add('hidden');
  $id('infoCard').classList.remove('hidden');
};
$id('consentDecline').onclick = ()=>{
  $id('consentDeclinedMsg').classList.remove('hidden');
  $id('consentAccept').disabled = true;
  $id('consentDecline').disabled = true;
  $id('consentText').style.opacity = "0.3";
};

/* ---------- Participant info -> Hand ---------- */
$id('toHandFromInfo').onclick = ()=>{
  const n = $id('name').value.trim(), s = $id('surname').value.trim(), a = $id('age').value.trim();
  if(!n || !s || !a){ alert('Lütfen ad (ilk2), soyad (ilk2) ve yaşı giriniz.'); return; }
  const e=$id('email').value.trim(), p=$id('phone').value.trim();
  if(!e || !p){ alert('Lütfen e-posta ve telefon bilgilerinizi giriniz.'); return; }
  participant.email=e; participant.phone=p;
  participant.name = n.slice(0,2); participant.surname = s.slice(0,2); participant.age = a;
  participant.race = $id('race').value.trim();
  participant.motherTongue = $id('motherTongue').value.trim();
  participant.gender = $id('gender').value;
  
  const four = (participant.name.padEnd(2).slice(0,2) + participant.surname.padEnd(2).slice(0,2)).toUpperCase().replace(/[^A-Z]/g,'X');
  const rand5 = Math.floor(10000 + Math.random()*90000);
  participant.code = (participant.projectCode ? participant.projectCode + '_' : '') + four + '_' + rand5;
  $id('codeInfo').innerText = 'Katılımcı kodu: ' + participant.code;
  $id('infoCard').classList.add('hidden');
  renderHand();
  $id('handUseCard').classList.remove('hidden');
};

/* ---------- Returning participant code flow ---------- */
$id('toStaiDirectBtn').onclick = ()=>{
  const code = $id('previousCode').value.trim();
  if(!code){ alert('Lütfen önceki katılımcı kodunu giriniz.'); return; }
  participant.code = code;
  try{
    const raw = localStorage.getItem('participant.' + code);
    if(raw){ participant = {...participant, ...JSON.parse(raw)}; }
  }catch(e){ console.warn('local load err', e); }
  $id('enterCodeCard').classList.add('hidden');
  renderStai();
  $id('staiCard').classList.remove('hidden');
};

/* ---------- Hand -> STAI ---------- */
$id('toStaiBtn').onclick = ()=>{
  const rows = document.querySelectorAll('#handUseQuestions .hand-grid-row');
  for(const r of rows) if(r.querySelectorAll('input:checked').length !== 2){ alert('Her işlem için tam olarak 2 kutucuk işaretleyiniz.'); return; }
  participant.handUse = Array.from(rows).map(r=>({ q: r.dataset.q, left: r.querySelectorAll('.left:checked').length, right: r.querySelectorAll('.right:checked').length }));
  try{ if(participant.code) localStorage.setItem('participant.' + participant.code, JSON.stringify({ projectCode: participant.projectCode, handUse: participant.handUse, motherTongue: participant.motherTongue || '', race: participant.race || '' })); }catch(e){}
  $id('handUseCard').classList.add('hidden');
  renderStai();
  $id('staiCard').classList.remove('hidden');
};

/* ---------- STAI -> Hearing ---------- */
$id('toHearingBtn').onclick = ()=>{
  if(document.querySelectorAll('#staiQuestions input:checked').length < staiQuestions.length){ alert('Lütfen tüm STAI sorularını yanıtlayınız.'); return; }
  participant.staiAnswers = {};
  document.querySelectorAll('#staiQuestions input:checked').forEach(i=> participant.staiAnswers[i.name] = i.value);
  $id('staiCard').classList.add('hidden');
  $id('hearingCard').classList.remove('hidden');
};

/* ---------- Hearing: two channels ---------- */
function ensureCtx(){ if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
function stopLeft(){ try{ if(leftOsc) leftOsc.stop(); }catch(e){} leftOsc=null; leftGain=null; }
function stopRight(){ try{ if(rightOsc) rightOsc.stop(); }catch(e){} rightOsc=null; rightGain=null; }

async function startLeft(){
  ensureCtx(); stopRight(); stopLeft();
  if (audioCtx.state === 'suspended') await audioCtx.resume();
  leftOsc = audioCtx.createOscillator(); leftGain = audioCtx.createGain();
  const panner = audioCtx.createStereoPanner(); 
  panner.pan.value = -1; leftOsc.frequency.value = 1500; 
  leftGain.gain.value = Number($id('leftSlider').value);
  leftOsc.connect(leftGain); leftGain.connect(panner); panner.connect(audioCtx.destination); 
  leftOsc.start();
}
async function startRight(){
  ensureCtx(); stopLeft(); stopRight();
  if (audioCtx.state === 'suspended') await audioCtx.resume();
  rightOsc = audioCtx.createOscillator(); rightGain = audioCtx.createGain();
  const panner = audioCtx.createStereoPanner(); 
  panner.pan.value = 1; rightOsc.frequency.value = 1500; 
  rightGain.gain.value = Number($id('rightSlider').value);
  rightOsc.connect(rightGain); rightGain.connect(panner); panner.connect(audioCtx.destination); 
  rightOsc.start();
}
 
$id('playLeft').onclick = ()=>{ if(leftOsc) stopLeft(); else startLeft(); setTimeout(()=>stopLeft(),1200); };
$id('playRight').onclick = ()=>{ if(rightOsc) stopRight(); else startRight(); setTimeout(()=>stopRight(),1200); };

$id('toSessionIntro').onclick = ()=>{
  stopLeft(); stopRight();
  participant.leftLevel = $id('leftSlider').value; participant.rightLevel = $id('rightSlider').value;
  results.push({ session: 'hearing_level', trial: 0, stim: '1500Hz', response: '', responseTime: '', leftLevel: participant.leftLevel, rightLevel: participant.rightLevel, age: participant.age || '', gender: participant.gender || '', race: participant.race || '', motherTongue: participant.motherTongue || '', handUseAnswers: JSON.stringify(participant.handUse || {}), staiAnswers: JSON.stringify(participant.staiAnswers || {}), code: participant.code || '' });
  sessionOrder = ['training','NF', ...shuffle(['FR','FL'])];
  currentSessionIndex = 0;
  $id('hearingCard').classList.add('hidden');
  showSessionIntro();
};

/* ---------- session intro & trials ---------- */
const mainPlaylist = [ "LBA-RKA.wav","LDA-RGA.wav","LPA-RBA.wav","LKA-RDA.wav","LBA-RBA.wav","LTA-RGA.wav","LBA-RDA.wav","LGA-RPA.wav","LDA-RKA.wav","LPA-RTA.wav","LKA-RKA.wav","LBA-RGA.wav","LKA-RPA.wav","LTA-RDA.wav","LGA-RKA.wav","LPA-RDA.wav","LGA-RGA.wav","LBA-RTA.wav","LGA-RDA.wav","LKA-RTA.wav","LDA-RPA.wav","LTA-RKA.wav","LPA-RPA.wav","LDA-RBA.wav","LGA-RTA.wav","LPA-RKA.wav","LTA-RBA.wav","LKA-RGA.wav","LTA-RTA.wav","LBA-RPA.wav","LDA-RTA.wav","LGA-RBA.wav","LTA-RPA.wav","LDA-RDA.wav","LKA-RBA.wav","LPA-RGA.wav" ];
const trainingPlaylist = [ "LBA-RBA.wav","LDA-RDA.wav","LGA-RGA.wav","LKA-RKA.wav","LPA-RPA.wav","LTA-RTA.wav","LBA-RDA.wav","LDA-RGA.wav","LGA-RKA.wav","LKA-RTA.wav" ];

function showSessionIntro(){
  const s = sessionOrder[currentSessionIndex];
  $id('sessionTitle').innerText = 'Oturum: ' + s;
  $id('sessionInstr').innerHTML = (s === 'training') ? 'Eğitim oturumuna hoşgeldiniz. Yanıt vermeye çalışmadan heceleri dinleyin.' : (s === 'NF' ? 'En iyi duyduğunuz heceyi seçiniz.' : (s === 'FR' ? 'SAĞ kulağınıza odaklanınız.' : 'SOL kulağınıza odaklanınız.'));
  $id('sessionIntro').classList.remove('hidden');
}

$id('sessionStartBtn').onclick = async ()=>{
  $id('sessionIntro').classList.add('hidden');
  try{ await $id('stimAudio').play().catch(()=>{}); }catch(e){}
  setTimeout(()=> { currentTrial = -1; $id('trialCard').classList.remove('hidden'); nextTrial(); }, 200);
};

function nextTrial(){
  clearTimeout(trialTimeout);
  const sType = sessionOrder[currentSessionIndex];
  const playlist = (sType === 'training') ? trainingPlaylist : mainPlaylist;
  currentTrial++;
  if(currentTrial >= playlist.length){
    $id('trialCard').classList.add('hidden'); currentSessionIndex++;
    if(currentSessionIndex < sessionOrder.length) showSessionIntro(); else endExperiment();
    return;
  }
  playStim(playlist[currentTrial]);
}

async function playStim(stim){
  isResponseAllowed = false;
  try{
    $id('stimAudio').src = './sounds/yeni/erkek/' + stim;
    await $id('stimAudio').play();
    responseStart = Date.now(); 
    setTimeout(()=> isResponseAllowed = true, 500); 
    trialTimeout = setTimeout(()=>{ 
        if(sessionOrder[currentSessionIndex] !== 'training') saveTrial(stim, 'no_response', '', Date.now()-responseStart); 
        nextTrial(); 
    }, 4000);
  }catch(e){ setTimeout(nextTrial, 200); }
}

function saveTrial(stim, response, responseTime, rt){
  results.push({ session: sessionOrder[currentSessionIndex], trial: currentTrial+1, stim, response, responseTime: rt, leftLevel: participant.leftLevel, rightLevel: participant.rightLevel, age: participant.age, gender: participant.gender, race: participant.race, motherTongue: participant.motherTongue, handUseAnswers: JSON.stringify(participant.handUse), staiAnswers: JSON.stringify(participant.staiAnswers), code: participant.code });
}

document.querySelectorAll('.respBtn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    if(!isResponseAllowed) return;
    isResponseAllowed = false; clearTimeout(trialTimeout);
    const rt = Date.now() - responseStart;
    if(sessionOrder[currentSessionIndex] !== 'training'){ saveTrial((sessionOrder[currentSessionIndex] === 'training' ? trainingPlaylist : mainPlaylist)[currentTrial], btn.dataset.val, rt, rt); }
    btn.classList.add('respBtn-active');
    setTimeout(()=> { btn.classList.remove('respBtn-active'); nextTrial(); }, 2500); 
  });
});

function makeCsv(){
  let csv = 'KATILIMCI BİLGİLERİ\nKod,Proje,Yaş,Cinsiyet,Anadil,DoğumYeri,Eposta,Telefon,SolSeviye,SağSeviye\n';
  csv += `${participant.code},${participant.projectCode},${participant.age},${participant.gender},${participant.motherTongue},${participant.race},${participant.email},${participant.phone},${participant.leftLevel},${participant.rightLevel}\n\n`;
  csv += 'EL KULLANIMI\n' + JSON.stringify(participant.handUse) + '\n\n';
  csv += 'STAI YANITLARI\n' + JSON.stringify(participant.staiAnswers) + '\n\n';
  csv += 'DİKOTİK SONUÇLAR\nSession,Trial,Stimulus,Response,ResponseTime\n';
  results.forEach(r=>{ csv += `${r.session},${r.trial},${r.stim},${r.response},${r.responseTime}\n`; });
  return csv;
}

async function sendEmail(partial=false){
  const csv = makeCsv();
  try{
    if(!window.emailjs){
      const s = document.createElement('script'); s.src = 'https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js';
      await new Promise(res=>{ s.onload = res; document.head.appendChild(s); });
      emailjs.init($id('emailjs-user').content);
    }
    await emailjs.send($id('emailjs-service').content, $id('emailjs-template').content, { subject: participant.code + (partial ? ' (partial)' : ''), message: csv });
    $id('doneLog').innerText = 'Veriler başarıyla gönderildi.';
  }catch(e){ $id('doneLog').innerText = 'E-posta gönderilemedi.'; }
}

async function endExperiment(){
  $id('trialCard').classList.add('hidden'); $id('endCard').classList.remove('hidden');
  await sendEmail(false);
}

document.addEventListener('click', function initAudioContext() {
    ensureCtx(); if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
}, {once: true});
  
});
</script>
</body>
</html>
