<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dikotik Dinleme Çalışması</title>

  <meta name="emailjs-user"    content="FLn2zMqKDGso3ePoO">
  <meta name="emailjs-service" content="service_a8bnfmk">
  <meta name="emailjs-template"content="template_7elc4wi">

  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:12px;color:#111;max-width:300px; margin-left: auto; margin-right: auto;}
    h1{font-size:20px;margin-bottom:8px}
    .hidden{display:none}
    .card{padding:12px;border:1px solid #ddd;border-radius:8px;margin-bottom:12px}
    input[type=text], input[type=number], input[type=email], input[type=tel], select{padding:8px;margin:6px 0;width:100% ;box-sizing:border-box}
    label{display:block;margin-top:10px;font-weight:bold;}
    .respRow{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:center;margin-top:15px;}
    .respBtn{
      font-size:1.2rem;
      padding:14px 24px;
      margin:6px;
      min-width:120px;
      border-radius:10px;
      border:1px solid #ccc;
      background-color:#eee;
      cursor:pointer;
    }
    .bigBtn{
        font-size:1rem;
        padding:10px 15px;
        margin:5px;
        min-width:100px;
        border-radius:5px;
        border:1px solid #ccc;
        background-color:#e0e0e0;
        cursor:pointer;
    }
    .hand-grid-row{display:grid;grid-template-columns:1fr 1fr;gap:5px;align-items:center;margin-bottom:10px;border-bottom:1px dashed #eee;padding-bottom:5px;}
    .hand-grid-row label{font-weight:normal;margin-top:0;}
    .hand-grid-row div{text-align:center;}
    .left-option, .right-option{margin:0 5px;}
  </style>
</head>
<body>

<div id="participantCard" class="card">
  <h1>Dikotik Dinleme Çalışması</h1>
  <label for="projectCode">Proje Kodu:</label>
  <select id="projectCode">
    <option value="">Lütfen Proje Kodunu Seçiniz</option>
    <option value="OykuTez">OykuTez - Yüksek Lisans Tezi</option>
    <option value="OtherProject">Diğer Proje</option>
  </select>
  <button id="toPreScreenBtn" class="bigBtn" style="margin-top: 15px;">Devam Et</button>
</div>

<div id="consentCard" class="card hidden">
    <h3>Aydınlatılmış Onam Formu</h3>
    <div id="consentTextContainer" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-bottom: 15px; text-align: left; background-color: #f9f9f9; border-radius: 4px;">
        <p>Lütfen bekleyiniz, onam metni yükleniyor...</p>
    </div>
    <div style="margin-top:10px; display: flex; justify-content: space-between;">
        <button id="rejectConsentBtn" class="bigBtn" style="background-color: #f44336; color: white;">Kabul Etmiyorum</button>
        <button id="acceptConsentBtn" class="bigBtn" style="background-color: #4CAF50; color: white;">Okudum, Anladım, Onaylıyorum</button>
    </div>
</div>

<div id="rejectionCard" class="card hidden">
    <h3>Katılım Reddedildi</h3>
    <p>Aydınlatılmış Onam Formunu onaylamadığınız için çalışmamıza katılmayı kabul etmediniz. Fikrinizi değiştirmeniz durumunda size verilen linke tekrar tıklayarak ve onay vererek çalışmamıza katılabilirsiniz. Desteğiniz için teşekkür ederiz.</p>
</div>

<div id="preScreenCard" class="card hidden">
    <h1>Katılım Durumu</h1>
    <label for="hasParticipated">Daha Önce Katıldınız Mı?</label>
    <select id="hasParticipated">
        <option value="">Lütfen Seçiniz</option>
        <option value="first_full">İlk defa katılıyorum ve tam katılacağım.</option>
        <option value="first_half">İlk defa katıldım ancak yarım bıraktım (STAI'dan devam edeceğim).</option>
        <option value="second_full" class="oykutez-only">İkinci kez katılıyorum ve tam katılacağım (OykuTez Projesi)</option>
        <option value="second_half" class="oykutez-only">İkinci kez katıldım ancak yarım bıraktım (STAI'dan devam edeceğim) (OykuTez Projesi)</option>
    </select>
    
    <div id="prevCodeInput" class="hidden">
        <label for="prevCode">Önceki Katılımcı Kodunuz:</label>
        <input type="text" id="prevCode" placeholder="Kodunuzu buraya giriniz">
    </div>

    <button id="toNextStepBtn" class="bigBtn" style="margin-top: 15px;">Devam Et</button>
</div>

<div id="infoCard" class="card hidden">
    <h1>Katılımcı Bilgileri</h1>
    <label for="name">Adınız:</label>
    <input type="text" id="name" placeholder="Ad">
    
    <label for="surname">Soyadınız:</label>
    <input type="text" id="surname" placeholder="Soyad">

    <label for="age">Yaşınız:</label>
    <input type="number" id="age" placeholder="Yaş">

    <label for="gender">Cinsiyet:</label>
    <select id="gender">
        <option value="">Seçiniz</option>
        <option value="Kadin">Kadın</option>
        <option value="Erkek">Erkek</option>
        <option value="Diger">Diğer</option>
    </select>

    <label for="race">Irk/Köken:</label>
    <input type="text" id="race" placeholder="Örn: Kafkas, Asyalı, Akdenizli">

    <label for="motherTongue">Ana Dil:</label>
    <input type="text" id="motherTongue" placeholder="Örn: Türkçe, İngilizce">
    
    <label for="email">E-posta Adresiniz (Sadece hatırlatma amaçlıdır):</label>
    <input type="email" id="email" placeholder="ornek@mail.com">

    <label for="phone">Telefon Numaranız (Sadece hatırlatma amaçlıdır):</label>
    <input type="tel" id="phone" placeholder="5xx xxx xx xx">
    
    <div style="margin-top: 20px;">
        <button id="toHandednessBtnNew" class="bigBtn">El Kullanımı Testine Geç</button>
    </div>
</div>

<div id="handUseCard" class="card hidden">
    <h1>Edinburgh El Kullanımı Envanteri</h1>
    <p>Aşağıdaki eylemleri yaparken hangi elinizi tercih ettiğinizi belirtiniz. Her bir işlem için **iki kutucuk** işaretleyiniz: Sol El (S), Sağ El (R).</p>
    
    <div style="font-weight:bold;display:grid;grid-template-columns:1fr 1fr;gap:5px;text-align:center;margin-bottom:5px;">
        <p>Sol El (S)</p>
        <p>Sağ El (R)</p>
    </div>
    
    <div id="handUseQuestions"></div>

    <button id="toHearingBtn" class="bigBtn" style="margin-top: 15px;">Kaydet ve Devam Et</button>
</div>


<div id="staiTxiCard" class="card hidden">
    <h1>Sürekli Kaygı Envanteri</h1>
    <p>Aşağıdaki cümleler genellikle **nasıl hissettiğinizi** belirtir. Size uygun olan seçeneği işaretleyiniz.</p>
    
    <div id="staiQuestions"></div>
    
    <div style="display:flex; justify-content:space-between; margin-top:15px;">
        <button id="backToParticipantBtn" class="bigBtn" style="background-color: #f0f0f0;">Geri</button>
        <button id="toHearingBtnFinal" class="bigBtn" style="background-color: #66bb6a; color: white;">İşitme Testine Geç</button>
    </div>
</div>

<div id="hearingCard" class="card hidden">
    <h1>İşitme Kontrolü</h1>
    <p>Lütfen kulaklıklarınızı taktığınızdan emin olun. Ses seviyesini rahatça duyabileceğiniz bir seviyeye ayarlayın.</p>
    
    <p>Sağ Kulaktan duyduğunuz sesi aşağıdaki kaydırıcı ile ayarlayın:</p>
    <input type="range" id="rightLevel" min="0" max="100" value="50">
    <span id="rightLevelDisplay">50</span>

    <p>Sol Kulaktan duyduğunuz sesi aşağıdaki kaydırıcı ile ayarlayın:</p>
    <input type="range" id="leftLevel" min="0" max="100" value="50">
    <span id="leftLevelDisplay">50</span>
    
    <button id="toDichoticBtn" class="bigBtn" style="margin-top: 15px;">Dikotik Dinleme Testine Başla</button>
</div>

<div id="dichoticCard" class="card hidden">
    <h1>Dikotik Dinleme Testi</h1>
    <p>Her denemede hem sağ hem de sol kulağınıza aynı anda farklı heceler duyacaksınız.</p>
    <p>**Duyduğunuz iki heceden hangisi daha nettiyse** aşağıdaki butona basarak onu seçin. Eğer ikisi de net değilse "İkisi De Değil"i seçin.</p>

    <p>Deneme: <span id="trialCounter">0</span> / <span id="trialTotal">0</span></p>
    <div id="stimulusArea" style="height:50px;"></div>
    
    <div id="responseButtons" class="respRow"></div>
</div>

<div id="endCard" class="card hidden">
    <h1>Çalışma Tamamlandı</h1>
    <p id="doneLog">Verileriniz kaydedildi. Katılımınız için teşekkür ederiz!</p>
    <p id="codeInfo" style="font-weight: bold;"></p>
</div>

<script src="https://cdn.jsdelivr.net/npm/emailjs-com@2/dist/email.min.js"></script>
<script>
    // Global değişkenler
    let participant = { projectCode: '' }, results = [], currentFlow = 'full';
    const totalTrials = 60; 
    let trialIndex = 0;
    let stimuli = [];
    const removedOptions = [];

    // Helper fonksiyon
    const $id = id => document.getElementById(id);

    // email.js başlatma (sayfa yüklenir yüklenmez çalışır)
    (function() {
        try {
            emailjs.init($id('participantCard').dataset.emailjsUser || document.querySelector('meta[name="emailjs-user"]').content);
        } catch (e) {
            console.error("EmailJS başlatılamadı:", e);
        }
    })();

    // Sabit Tanımlar
    const STIMULI_MAP = {
        1: "BA", 2: "DA", 3: "GA", 4: "KA", 5: "PA", 6: "TA"
    };

    const HAND_USE_QUESTIONS = [
        "Yazma", "Çizim", "Atma", "Makas", "Diş Fırçalama", 
        "Bıçak (ekmek vs keserken)", "Kaşık", "Kibrit", "Kutu açma"
    ];

    const STAI_TXI_QUESTIONS = [
        "Kendimi gergin hissediyorum", "Kolayca yoruluyorum", "Kolayca ağlıyorum", "Keşke daha mutlu olabilseydim", 
        "Hemen hemen her zaman memnunum", "Uykusuzluk çekiyorum", "Öyle düşünülmesinden bile tiksindiğim düşünceler aklıma geliyor", 
        "Çok sık hayal kırıklığına uğrarım", "Benden bekleneni yapabileceğimden şüpheliyim", "Oldukça iyi hissediyorum", 
        "Bir şey beni rahatsız etmediğinde bile gerginlik hissediyorum", "Endişelenmekten kaçınırım", "Düş kırıklığı beni o kadar üzer ki unutamam", 
        "Sakin bir insanım", "Kendimi güvende hissediyorum", "Çabuk yoruluyorum", "Yabancılarla konuşmakta güçlük çekmiyorum", 
        "Çabuk heyecanlanırım", "Kolayca endişelenirim", "Bunalımlı düşüncelerim var"
    ];

    const CONSENT_TEXTS = {
        // Proje koduna göre metinler (Lütfen içeriği güncelleyiniz)
        "OykuTez": `
            <h4>Yüksek Lisans Tez Projesi Aydınlatılmış Onam Metni</h4>
            <p>Merhaba, bu çalışma Ege Üniversitesi'nde yürütülen bir yüksek lisans tez çalışmasıdır. Katılımınız tamamen gönüllülük esasına dayanmaktadır.</p>
            <p>Çalışma yaklaşık 20 dakika sürecektir. Çalışma sırasında kişisel bilgileriniz gizli tutulacak ve sadece katılımcı kodu üzerinden analiz edilecektir. Çalışmanın herhangi bir aşamasında dilediğiniz zaman, herhangi bir sebep göstermeksizin ayrılma hakkına sahipsiniz.</p>
            <p>Lütfen testlere başlamadan önce kulaklığınızın takılı olduğundan ve ses seviyesinin rahatınız için uygun olduğundan emin olunuz.</p>
        `,
        "OtherProject": `
            <h4>Diğer Projeler İçin Onay Metni</h4>
            <p>Bu projeye katılımınızın gönüllü olduğunu, dilediğiniz zaman ayrılma hakkınızın saklı olduğunu ve verilerinizin gizli tutulacağını onaylıyor musunuz?</p>
        `,
        "default": `
            <h4>Genel Onay Metni</h4>
            <p>Seçilen proje koduna özel bir metin bulunmamaktadır. Çalışmanın gönüllülük esasına dayandığını ve verilerinizin gizli tutulacağını onaylıyor musunuz?</p>
        `
    };

    // Fonksiyonlar
    function loadConsentText(projectCode) {
        const textContainer = $id('consentTextContainer');
        const text = CONSENT_TEXTS[projectCode] || CONSENT_TEXTS.default; 
        textContainer.innerHTML = text;
    }

    function makeCode() {
        const pCode = $id('projectCode').value;
        if (!pCode) {
            alert("Lütfen bir proje kodu seçiniz.");
            return false;
        }
        participant.projectCode = pCode;
        return true;
    }

    function generateParticipantCode(name, surname, age, gender, race, motherTongue, projectCode) {
        const initials = (name.charAt(0) + surname.charAt(0)).toUpperCase();
        const ageCode = String(age).padStart(2, '0');
        const genderCode = gender.charAt(0).toUpperCase();
        const raceCode = race.charAt(0).toUpperCase();
        const langCode = motherTongue.charAt(0).toUpperCase();
        const timestamp = Date.now() % 100000;
        
        participant.code = `${projectCode}_${initials}${ageCode}${genderCode}${raceCode}${langCode}_${timestamp}`;
        $id('codeInfo').innerText = "Katılımcı Kodunuz: " + participant.code;
    }

    // Geri Butonları
    $id('backToParticipantBtn').onclick = () => {
        $id('staiTxiCard').classList.add('hidden');
        
        // Eğer akış 'full_cont' veya 'dichotic_only' ise (yani devam ediyorsa), 
        // Ön Sorgulama ekranına geri dön.
        if (currentFlow === 'full_cont' || currentFlow === 'dichotic_only') {
            $id('preScreenCard').classList.remove('hidden');
            
            // Bu akışta, Ön Sorgulama ekranına dönerken,
            // Proje Kodu ve Katılım Durumu bilgisini tekrar seçmesi gerekir.
            $id('hasParticipated').value = '';
            $id('prevCodeInput').classList.add('hidden');

        } else {
            // Eğer akış 'full' ise (yani ilk kez tam katılım), 
            // Katılımcı Bilgileri ekranına geri dön.
            $id('infoCard').classList.remove('hidden');
        }
    };


    // Akış Kontrol Butonları

    // 1. Proje Kodu seçimi sonrası -> Aydınlatılmış Onam VEYA Ön Sorgulama (NİHAİ DÜZELTME)
    $id('toPreScreenBtn').onclick=()=>{
        if(!makeCode()) return;
        
        // *** KRİTİK GİZLEME BLOKU ***: Tüm kartları zorla gizle
        $id('participantCard').classList.add('hidden'); 
        $id('preScreenCard').classList.add('hidden');  
        $id('infoCard').classList.add('hidden');      // infoCard'u zorla gizle
        $id('consentCard').classList.add('hidden');   
        $id('rejectionCard').classList.add('hidden'); 
        
        const isOykuTez = participant.projectCode === 'OykuTez';
        
        if (isOykuTez) {
            // OykuTez ise Önce Aydınlatılmış Onam
            $id('consentCard').classList.remove('hidden');
            loadConsentText(participant.projectCode); 
        } else {
            // Diğer projeler ise direkt Ön Sorgulama
            $id('preScreenCard').classList.remove('hidden'); 
        }
        
        // OykuTez kısıtlamasını yöneten kod
        const selectElement = $id('hasParticipated');
        
        // Önceki çağrıda kaldırılan seçenekleri geri ekle
        while (removedOptions.length > 0) {
            selectElement.appendChild(removedOptions.shift());
        }

        // OykuTez değilse, 3. ve 4. seçenekleri kaldır
        if (!isOykuTez) {
            const oykutezOptions = selectElement.querySelectorAll('.oykutez-only');
            oykutezOptions.forEach(option => {
                if (option.parentNode === selectElement) {
                    removedOptions.push(option);
                    selectElement.removeChild(option);
                }
            });
        }

        // Ekran açılırken seçimi sıfırla
        selectElement.value = '';
        $id('prevCodeInput').classList.add('hidden');
        
        // E-posta/Telefon alanlarını göster/gizle
        $id('email').parentNode.style.display = isOykuTez ? 'block' : 'none'; 
        $id('phone').parentNode.style.display = isOykuTez ? 'block' : 'none'; 
    };

    // Onaylama Butonu
    $id('acceptConsentBtn').onclick = () => {
        $id('consentCard').classList.add('hidden');
        $id('infoCard').classList.add('hidden'); // infoCard'u gizle

        // Onaylandıktan sonra Ön Sorgulama ekranına geç.
        $id('preScreenCard').classList.remove('hidden'); 
    };

    // Reddetme Butonu
    $id('rejectConsentBtn').onclick = () => {
        $id('consentCard').classList.add('hidden');
        // Reddedildiğinde sadece Reddetme Mesajı kartını göster ve akışı bitir.
        $id('rejectionCard').classList.remove('hidden'); 
    };

    // 2. Blok: Ön Sorgulama Devam Butonu (NİHAİ DÜZELTME)
    $id('toNextStepBtn').onclick=()=>{
        const hasParticipated = $id('hasParticipated').value;
        if (!hasParticipated) { alert("Lütfen katılım durumunuzu belirtiniz."); return; }
        
        // Kısıtlama kontrolü
        const isOykuTez = participant.projectCode === 'OykuTez';
        if (!isOykuTez) {
            if (hasParticipated !== 'first_full' && hasParticipated !== 'first_half') {
                alert("Seçtiğiniz proje kodu için sadece 'İlk defa katılıyorum...' veya 'İlk defa katıldım ancak yarım bıraktım' seçenekleri geçerlidir.");
                $id('preScreenCard').classList.remove('hidden'); 
                return;
            }
        }
        
        $id('preScreenCard').classList.add('hidden'); // Ön Sorgulama ekranını gizle

        if (hasParticipated === 'first_full') {
            // AKIŞ 1: İlk kez tam katılım (Bilgi Girişi'nden başla)
            currentFlow = 'full';
            $id('infoCard').classList.remove('hidden'); // KRİTİK: Bilgi Girişi ekranını AÇ
        } else {
            const prevCode = $id('prevCode').value.trim();
            if (!prevCode) { alert("Lütfen bir önceki katılımcı kodunuzu giriniz."); $id('preScreenCard').classList.remove('hidden'); return; }
            
            participant.prevCode = prevCode;
            
            if (hasParticipated === 'first_half') {
                // AKIŞ 2: İlk katılımı yarım bıraktı (STAI'dan devam etmeli)
                participant.code = prevCode.replace("_1st_HALF", "") + "_1st_CONT"; 
                currentFlow = 'full_cont';
                $id('staiTxiCard').classList.remove('hidden'); // STAI'ye atla
                renderStai(); 
                
            } else if (hasParticipated === 'second_full') {
                // AKIŞ 3: İkinci kez tam katılım (Sadece Dikotik Dinleme, İşitme Testi'nden başla)
                participant.code = prevCode + "_2nd_FULL"; 
                currentFlow = 'dichotic_only';
                $id('hearingCard').classList.remove('hidden'); 
                
            } else if (hasParticipated === 'second_half') {
                // AKIŞ 4: İkinci kez katılıp yarım bıraktı (STAI'dan devam etmeli)
                participant.code = prevCode.replace("_2nd_HALF", "") + "_2nd_CONT"; 
                currentFlow = 'dichotic_only';
                $id('staiTxiCard').classList.remove('hidden'); // STAI'ye atla
                renderStai(); 
            }
            $id('prevCodeInfo').innerText = "Kullanılan kod: " + participant.code;
        }
    };

    // Önceki Kodu Giriş Alanını Yönet
    $id('hasParticipated').onchange = (e) => {
        const val = e.target.value;
        if (val === 'first_half' || val === 'second_full' || val === 'second_half') {
            $id('prevCodeInput').classList.remove('hidden');
        } else {
            $id('prevCodeInput').classList.add('hidden');
        }
    };

    // 3. Blok: Bilgi Girişi sonrası -> EL KULLANIMI TESTİ (NİHAİ DÜZELTME)
    $id('toHandednessBtnNew').onclick=()=>{
        // Yalnızca 'full' akışındakiler bu ekranı görmelidir.
        if (currentFlow !== 'full') return; 

        const n=$id('name').value.trim(), s=$id('surname').value.trim(), a=$id('age').value.trim(), g=$id('gender').value.trim(), r=$id('race').value.trim(), m=$id('motherTongue').value.trim();
        const e = $id('email').value.trim();
        const p = $id('phone').value.trim();
        
        // Zorunlu alan kontrolü
        if (!n || !s || !a || !r || !m || !g) { alert("Lütfen tüm zorunlu katılımcı bilgilerini doldurunuz."); return; }
        
        // KRİTİK KONTROL: OykuTez ise e-posta VEYA telefon zorunlu
        if (participant.projectCode === 'OykuTez' && (!e && !p)) {
            alert("Lütfen hatırlatma amacıyla e-posta VEYA telefon numaranızı giriniz."); 
            return;
        }

        // Yeni bilgileri kaydet
        Object.assign(participant, {age:a, gender:g, race:r, motherTongue:m, email:e, phone:p, name:n, surname:s});
        
        // Yeni kod oluştur (sadece 'full' akışında)
        generateParticipantCode(n, s, a, g, r, m, participant.projectCode);

        $id('infoCard').classList.add('hidden');
        $id('handUseCard').classList.remove('hidden'); // El Kullanımı Testine geçiş
        renderHand();
    };

    // 4. El Kullanımı sonrası -> STAI'dan önce devam/çıkış sorgusu (NİHAİ DÜZELTME)
    $id('toHearingBtn').onclick=()=>{ 
        let ok=true;const groups=document.querySelectorAll('#handUseQuestions .hand-grid-row');
        for(const g of groups){const c=g.querySelectorAll('input:checked').length;if(c!==2){ok=false;alert("Her işlem için tam olarak 2 kutucuk işaretleyiniz.");break;}}
        if(!ok)return;const ans={};groups.forEach(g=>{const q=g.dataset.questionId,l=g.querySelectorAll('.left-option:checked').length,r=g.querySelectorAll('.right-option:checked').length;ans[q]={left:l,right:r};});participant.handUseAnswers=ans;

        $id('handUseCard').classList.add('hidden');
        
        // Yarıda bırakma opsiyonu SADECE bu noktada sunulur.
        const confirmContinue = confirm(
            "El Kullanımı Testi tamamlandı. STAI ve Dikotik Dinleme testlerine şimdi devam etmek istiyor musunuz?\n\n" +
            "İPTAL derseniz, bu kodu (" + participant.code + ") not alıp çıkış yapınız. Devam etmek için TAMAM'a basınız."
        );

        if (confirmContinue) {
            $id('staiTxiCard').classList.remove('hidden'); // STAI'ye devam
            renderStai();
        } else {
            // Yarıda bırakma durumunda kodu _HALF soneki ile sonlandırıyoruz.
            if (participant.code.endsWith("_1st_CONT")) participant.code = participant.code.replace("_1st_CONT", "_1st_HALF");
            else if (participant.code.endsWith("_2nd_CONT")) participant.code = participant.code.replace("_2nd_CONT", "_2nd_HALF");
            else if (currentFlow === 'full') participant.code += "_1st_HALF"; // İlk kez katılıp burada bıraktı

            // Yarıda bırakılan veriyi kaydet ve mail gönder
            sendEmail();

            alert("Lütfen katılımcı kodunuzu (" + participant.code + ") kaydettiğinizden emin olunuz. Bu kodu kullanarak daha sonra devam edebilirsiniz.");
            $id('endCard').classList.remove('hidden');
            $id('doneLog').innerText = "Deney yarıda bırakıldı. Lütfen bu kodu kaydedin: " + participant.code;
        }
    };


    // Diğer Fonksiyonlar (Aynı Kalıyor)

    function renderHand() {
        const container = $id('handUseQuestions');
        container.innerHTML = '';
        HAND_USE_QUESTIONS.forEach((q, i) => {
            const div = document.createElement('div');
            div.className = 'hand-grid-row';
            div.dataset.questionId = i + 1;
            div.innerHTML = `
                <label>${q}</label>
                <div>
                    <input type="radio" id="q${i+1}_s" name="q${i+1}_s_r" value="sol" class="left-option">
                    <label for="q${i+1}_s">S</label>
                    <input type="radio" id="q${i+1}_r" name="q${i+1}_s_r" value="sag" class="right-option">
                    <label for="q${i+1}_r">R</label>
                </div>
            `;
            container.appendChild(div);
        });
        
        // Eğer önceki cevaplar varsa yükle
        if (participant.handUseAnswers) {
            Object.keys(participant.handUseAnswers).forEach(qId => {
                const ans = participant.handUseAnswers[qId];
                if (ans.left > 0) $id(`q${qId}_s`).checked = true;
                if (ans.right > 0) $id(`q${qId}_r`).checked = true;
            });
        }
    }

    function renderStai() {
        const container = $id('staiQuestions');
        container.innerHTML = '';
        
        const scale = ["Hiç", "Biraz", "Çok", "Tamamen"];
        
        // Başlık satırı
        const header = document.createElement('div');
        header.style.textAlign = 'right';
        header.innerHTML = scale.map(s => `<span style="display:inline-block; width:45px;">${s}</span>`).join('');
        container.appendChild(header);

        STAI_TXI_QUESTIONS.forEach((q, i) => {
            const div = document.createElement('div');
            div.style.marginBottom = '15px';
            div.innerHTML = `
                <p style="margin-bottom:5px;">${i + 1}. ${q}</p>
                <div style="display:flex; justify-content:flex-end;">
                    ${scale.map((s, idx) => `
                        <div style="width:45px; text-align:center;">
                            <input type="radio" id="txi_q${i+1}_${idx+1}" name="txi_q${i+1}" value="${idx+1}" required>
                        </div>
                    `).join('')}
                </div>
            `;
            container.appendChild(div);
        });
        
        // Eğer önceki cevaplar varsa yükle
        if (participant.staiAnswers) {
            STAI_TXI_QUESTIONS.forEach((q, i) => {
                const qId = i + 1;
                const answer = participant.staiAnswers[qId];
                if (answer) {
                    const radio = $id(`txi_q${qId}_${answer}`);
                    if (radio) radio.checked = true;
                }
            });
        }
    }

    $id('toHearingBtnFinal').onclick = () => {
        const groups = document.querySelectorAll('#staiQuestions input[type="radio"]');
        const totalQuestions = STAI_TXI_QUESTIONS.length;
        const answeredQuestions = new Set();
        const answers = {};

        groups.forEach(input => {
            if (input.checked) {
                const qId = input.name.split('_')[1];
                answeredQuestions.add(qId);
                answers[qId] = parseInt(input.value);
            }
        });

        if (answeredQuestions.size !== totalQuestions) {
            alert(`Lütfen tüm STAI sorularını cevaplayınız. Eksik soru: ${totalQuestions - answeredQuestions.size}`);
            return;
        }

        participant.staiAnswers = answers;

        $id('staiTxiCard').classList.add('hidden');
        $id('hearingCard').classList.remove('hidden');

        // Eğer ikinci akış ise (dichotic_only), bu testten sonra direkt dikotik dinlemeye geçilir.
        if (currentFlow === 'dichotic_only') {
             // İkinci akışta STAI'dan sonra direkt Dichotic'e geçmesi gerekir, İşitme Testi daha önce yapılmıştır.
             // Ancak işitme testi seviyelerini tekrar kontrol etmek için bu ekranı gösteriyoruz.
        }
    };


    // İşitme Kontrolü
    $id('rightLevel').oninput = (e) => {
        $id('rightLevelDisplay').innerText = e.target.value;
    };
    $id('leftLevel').oninput = (e) => {
        $id('leftLevelDisplay').innerText = e.target.value;
    };
    $id('toDichoticBtn').onclick = () => {
        participant.rightLevel = $id('rightLevel').value;
        participant.leftLevel = $id('leftLevel').value;

        $id('hearingCard').classList.add('hidden');
        $id('dichoticCard').classList.remove('hidden');

        startDichoticTest();
    };

    function generateStimuli() {
        const allPairs = [];
        // Tüm olası 6 hece çiftini oluştur: BA, DA, GA, KA, PA, TA
        for (let r = 1; r <= 6; r++) {
            for (let l = 1; l <= 6; l++) {
                // R=L durumu (aynı heceler) elenir.
                if (r !== l) {
                    allPairs.push({ right: r, left: l });
                }
            }
        }
        
        // Her çiftten birer kopya
        let initialStimuli = allPairs; 
        // Testi 60 denemeye tamamlamak için, 30 çiftten oluşan setten bir kopya daha eklenir (Toplam 60 deneme)
        initialStimuli = initialStimuli.concat(allPairs); 

        // Rastgele karıştırma (Fisher-Yates)
        for (let i = initialStimuli.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [initialStimuli[i], initialStimuli[j]] = [initialStimuli[j], initialStimuli[i]];
        }
        
        return initialStimuli;
    }

    function startDichoticTest() {
        stimuli = generateStimuli();
        $id('trialTotal').innerText = stimuli.length;
        trialIndex = 0;
        
        renderResponseButtons();
        nextTrial();
    }

    function renderResponseButtons() {
        const container = $id('responseButtons');
        container.innerHTML = '';

        // Sabit hece setini kullanarak butonları oluştur
        const buttons = Object.values(STIMULI_MAP).map(syllable => {
            return `<button class="respBtn" data-response="${syllable}">${syllable}</button>`;
        });
        
        // Ekstra "İkisi De Değil" butonu
        buttons.push(`<button class="respBtn" data-response="none">İkisi De Değil</button>`);

        container.innerHTML = buttons.join('');

        // Tüm butonlara event listener ekle
        document.querySelectorAll('#responseButtons .respBtn').forEach(button => {
            button.onclick = handleResponse;
        });
    }

    function playStimulus(rightSyllableIndex, leftSyllableIndex) {
        // Stimulus oynatma mantığı (JS-Audio API veya özel bir kütüphane gerektirir)
        // Burada sadece simülasyon yapılıyor, gerçek ses dosyaları kullanılmıyor.
        console.log(`Stimulus Oynatılıyor: Sağ Kulak: ${STIMULI_MAP[rightSyllableIndex]}, Sol Kulak: ${STIMULI_MAP[leftSyllableIndex]}`);
        $id('stimulusArea').innerText = `[Ses Oynatılıyor: ${STIMULI_MAP[rightSyllableIndex]} / ${STIMULI_MAP[leftSyllableIndex]}]`;
        
        // Gerçek uygulamada buraya ses oynatma kodu gelecektir
    }

    function nextTrial() {
        if (trialIndex >= stimuli.length) {
            endDichoticTest();
            return;
        }
        
        const currentStim = stimuli[trialIndex];
        $id('trialCounter').innerText = trialIndex + 1;
        
        // Stimulus oynatılıyor
        playStimulus(currentStim.right, currentStim.left);
        
        // Bir sonraki denemeye geçmeden önce kullanıcı cevabını bekleyin
        document.querySelectorAll('#responseButtons .respBtn').forEach(btn => btn.disabled = false);
    }

    function handleResponse(e) {
        // Cevap butonları devre dışı bırakılır
        document.querySelectorAll('#responseButtons .respBtn').forEach(btn => btn.disabled = true);

        const response = e.target.dataset.response;
        const currentStim = stimuli[trialIndex];
        
        // Veriyi kaydet
        results.push({
            session: "dichotic",
            trial: trialIndex + 1,
            stim: `${STIMULI_MAP[currentStim.right]}-${STIMULI_MAP[currentStim.left]}`,
            response: response,
            rightLevel: participant.rightLevel,
            leftLevel: participant.leftLevel,
            age: participant.age,
            gender: participant.gender,
            race: participant.race,
            motherTongue: participant.motherTongue,
            projectCode: participant.projectCode,
            prevCode: participant.prevCode,
            staiAnswers: JSON.stringify(participant.staiAnswers) || ""
        });
        
        trialIndex++;
        
        // Kısa bir gecikme sonrası sonraki denemeye geç
        setTimeout(nextTrial, 500); // 500ms bekleme
    }

    function endDichoticTest() {
        $id('dichoticCard').classList.add('hidden');
        $id('endCard').classList.remove('hidden');
        $id('doneLog').innerText = "Test tamamlandı. Verileriniz sunucuya gönderiliyor...";
        
        // E-posta gönderimi
        sendEmail();
    }
    
    // E-posta ve CSV Fonksiyonları (Aynı kalır)

    function sendEmail(){
        const templateParams = {
            from_name: participant.code,
            to_name: "Araştırmacı",
            message: `Yeni bir katılımcıdan veri geldi.\nKod: ${participant.code}\nDurum: ${currentFlow}\n\nLütfen ekteki CSV dosyasını kontrol ediniz.`,
            csv_data: makeCsv(),
            subject: `YENİ DENEY VERİSİ - ${participant.code}`
        };
        
        try{
            const serviceId = $id('participantCard').dataset.emailjsService || document.querySelector('meta[name="emailjs-service"]').content;
            const templateId = $id('participantCard').dataset.emailjsTemplate || document.querySelector('meta[name="emailjs-template"]').content;

            emailjs.send(serviceId, templateId, templateParams)
            .then(function(resp) {
                $id('doneLog').innerText="Verileriniz kaydedildi. Katılımınız için teşekkür ederiz!";
                console.log('SUCCESS!', resp.status, resp.text);
            }, function(error) {
                $id('doneLog').innerText="Verileriniz kaydedildi, ancak e-posta gönderimi başarısız oldu. Lütfen internet bağlantınızı kontrol ediniz. (Hata: "+JSON.stringify(error)+")";
                console.log('FAILED...', error);
            });
        }catch(err){
            alert("E-posta servisi kurulamadı: "+JSON.stringify(err));
        }
    }

    function makeCsv(){
        // Tüm verileri birleştir
        const allData = [
            {
                session: "info",
                trial: 0,
                stim: "",
                response: "",
                rightLevel: participant.rightLevel || "",
                leftLevel: participant.leftLevel || "",
                age: participant.age || "",
                gender: participant.gender || "",
                race: participant.race || "",
                motherTongue: participant.motherTongue || "",
                email: participant.email || "", 
                phone: participant.phone || "",
                projectCode: participant.projectCode || "", 
                prevCode: participant.prevCode || "",
                staiAnswers: JSON.stringify(participant.staiAnswers) || ""
            },
        ].concat(results.map(r => ({
            ...r,
            staiAnswers: JSON.stringify(participant.staiAnswers) || "",
            rightLevel: participant.rightLevel || "",
            leftLevel: participant.leftLevel || "",
            age: participant.age || "",
            gender: participant.gender || "",
            race: participant.race || "",
            motherTongue: participant.motherTongue || "",
            email: participant.email || "", 
            phone: participant.phone || "",
            projectCode: participant.projectCode || "",
            prevCode: participant.prevCode || ""
        })));

        const header = ["session", "trial", "stim", "response", "rightLevel", "leftLevel", "age", "gender", "race", "motherTongue", "email", "phone", "projectCode", "prevCode", "staiAnswers"].join(',');
        const csv = allData.map(row => 
            [
                row.session, row.trial, row.stim, row.response, 
                row.rightLevel, row.leftLevel, row.age, row.gender, 
                row.race, row.motherTongue, row.email, row.phone, 
                row.projectCode, row.prevCode, row.staiAnswers
            ].map(val => `"${String(val).replace(/"/g, '""')}"`).join(',')
        ).join('\n');
        
        return header + '\n' + csv;
    }

</script>
</body>
</html>
