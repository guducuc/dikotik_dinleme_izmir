<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dikotik Dinleme İzmir</title>

<style>
body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:12px;color:#111;max-width:360px;margin:auto;}
h1{font-size:20px;margin-bottom:8px}
.hidden{display:none}
.card{padding:12px;border:1px solid #ddd;border-radius:8px;margin-bottom:12px}
input,select{padding:8px;margin:6px 0;width:100%;box-sizing:border-box}
.bigBtn{font-size:1.1rem;padding:12px 20px;margin:6px;border-radius:8px;border:1px solid #444;background:#eaeaea;cursor:pointer;}
.respBtn{font-size:1.2rem;padding:14px 24px;margin:6px;min-width:110px;border-radius:10px;border:1px solid #444;background:#f2f2f2;cursor:pointer;}
.respBtn-active{background-color:#bdbdbd;}
#consentText{max-height:240px;overflow-y:auto;border:1px solid #ccc;padding:8px;border-radius:6px;margin-bottom:10px;font-size:14px;line-height:1.4}
</style>
</head>
<body>
<h1>Dikotik Dinleme İzmir</h1>

<!-- Proje Kodu -->
<div id="projectCard" class="card">
  <h3>Proje Kodu Seçimi</h3>
  <select id="projectCode">
    <option value="">Proje Kodunuzu Seçin</option>
    <option value="OykuTez">OykuTez</option>
    <option value="Izmir">Izmir</option>
    <option value="Esporcu">Esporcu</option>
    <option value="Sporcu">Sporcu</option>
  </select>
  <button id="toParticipationBtn" class="bigBtn">Devam</button>
</div>

<!-- Katılım Durumu -->
<div id="participationCard" class="card hidden">
  <h3>Katılım Durumu</h3>
  <div id="participationOptions"></div>
  <button id="toNextStepBtn" class="bigBtn">Devam</button>
</div>

<!-- Kod Girişi -->
<div id="enterCodeCard" class="card hidden">
  <h3>Katılımcı Kodu</h3>
  <p>Lütfen önceki oturumda size verilen katılımcı kodunu giriniz.</p>
  <input id="previousCode" placeholder="Örnek: ABC_12345">
  <button id="toStaiDirectBtn" class="bigBtn">Devam</button>
</div>

<!-- Onam -->
<div id="consentCard" class="card hidden">
  <h3>Aydınlatılmış Onam</h3>
  <div id="consentText">
    <p><b>Sayın Katılımcı,</b><br>
    Bu çalışma, işitsel algı ve dikkat süreçlerini incelemek amacıyla yapılmaktadır.
    Katılımınız gönüllülük esasına dayanır ve veriler anonim olarak saklanır.</p>
    <p>Dilediğiniz zaman çalışmadan çekilme hakkınız vardır.</p>
  </div>
  <label><input type="checkbox" id="consentAgree"> Okudum ve onaylıyorum</label>
  <div>
    <button id="toParticipantBtn" class="bigBtn">Devam</button>
  </div>
</div>

<!-- Katılımcı Bilgileri -->
<div id="participantCard" class="card hidden">
  <h3>Katılımcı Bilgileri</h3>
  <input id="name" placeholder="Ad">
  <input id="surname" placeholder="Soyad">
  <input id="age" type="number" placeholder="Yaş">
  <input id="email" type="email" placeholder="E-posta">
  <button id="toHandBtn" class="bigBtn">Devam</button>
</div>

<!-- El Kullanımı -->
<div id="handUseCard" class="card hidden">
  <h3>El Kullanımı Testi</h3>
  <div id="handUseQuestions"></div>
  <button id="toStaiBtn" class="bigBtn">Devam</button>
</div>

<!-- STAI -->
<div id="staiCard" class="card hidden">
  <h3>STAI-TXI Formu</h3>
  <div id="staiQuestions"></div>
  <button id="toHearingBtn" class="bigBtn">Devam</button>
</div>

<!-- İşitme -->
<div id="hearingCard" class="card hidden">
  <h3>İşitme Kontrolü</h3>
  <p>Sesleri duyduğunuzdan emin olun.</p>
  <input type="range" id="volumeControl" min="0" max="1" step="0.01" value="0.5">
  <button id="playTone" class="bigBtn">Ses Testi</button>
  <button id="toSessionIntro" class="bigBtn">Devam</button>
</div>

<!-- Oturum Girişi -->
<div id="sessionIntro" class="card hidden">
  <h3 id="sessionTitle"></h3>
  <p id="sessionInstr"></p>
  <button id="sessionStartBtn" class="bigBtn">Başla</button>
</div>

<!-- Deneme -->
<div id="trialCard" class="card hidden">
  <h3 id="trialStatus"></h3>
  <audio id="stimAudio"></audio>
  <div class="respRow">
    <button class="respBtn" data-val="BA">BA</button>
    <button class="respBtn" data-val="DA">DA</button>
    <button class="respBtn" data-val="GA">GA</button>
    <button class="respBtn" data-val="KA">KA</button>
    <button class="respBtn" data-val="PA">PA</button>
    <button class="respBtn" data-val="TA">TA</button>
  </div>
</div>

<!-- Bitiş -->
<div id="endCard" class="card hidden">
  <h3>Deney Tamamlandı</h3>
  <p id="doneLog"></p>
</div>

<script>
document.addEventListener("DOMContentLoaded", ()=>{
const $id = i=>document.getElementById(i);
let participant={}, sessionOrder=[], currentSession=0, currentTrial=0, results=[];
let audioCtx,osc;

/* Katılım Durumu Dinamik Seçenekler */
function renderParticipationOptions(code){
 const c=$id("participationOptions");
 c.innerHTML=(code==="OykuTez")
  ? `<label><input type="radio" name="part" value="1"> İlk kez katılıyorum</label><br>
     <label><input type="radio" name="part" value="2"> Bir kez katıldım ama tamamlayamadım</label><br>
     <label><input type="radio" name="part" value="3"> İkinci kez katılıyorum</label><br>
     <label><input type="radio" name="part" value="4"> İki kez katıldım ancak tamamlayamadım</label>`
  : `<label><input type="radio" name="part" value="1"> İlk kez katılıyorum</label><br>
     <label><input type="radio" name="part" value="2"> Daha önce katıldım / tamamlayamadım</label>`;
}

/* Proje Seçimi */
$id("toParticipationBtn").onclick=()=>{
 const v=$id("projectCode").value;
 if(!v){alert("Lütfen proje kodu seçin.");return;}
 participant.projectCode=v;
 $id("projectCard").classList.add("hidden");
 $id("participationCard").classList.remove("hidden");
 renderParticipationOptions(v);
};

/* Katılım sonrası yönlendirme */
$id("toNextStepBtn").onclick=()=>{
 const c=document.querySelector('input[name="part"]:checked');
 if(!c){alert("Seçim yapın.");return;}
 const v=c.value;
 if(v==="1"){
   $id("participationCard").classList.add("hidden");
   $id("consentCard").classList.remove("hidden");
 } else {
   $id("participationCard").classList.add("hidden");
   $id("enterCodeCard").classList.remove("hidden");
 }
};

/* Onam */
$id("toParticipantBtn").onclick=()=>{
 if(!$id("consentAgree").checked){alert("Onam kutusunu işaretleyin.");return;}
 $id("consentCard").classList.add("hidden");
 $id("participantCard").classList.remove("hidden");
};

/* Önceki Kod Girişi */
$id("toStaiDirectBtn").onclick=()=>{
 const code=$id("previousCode").value.trim();
 if(!code){alert("Kod girin.");return;}
 participant.code=code;
 $id("enterCodeCard").classList.add("hidden");
 startStai();
};

/* Katılımcı Bilgisi */
$id("toHandBtn").onclick=()=>{
 const n=$id("name").value.trim();
 if(!n){alert("Ad girin.");return;}
 participant.name=n;
 participant.code=participant.projectCode+"_"+n+"_"+Math.floor(Math.random()*9999);
 $id("participantCard").classList.add("hidden");
 $id("handUseCard").classList.remove("hidden");
};

/* El Kullanımı → STAI */
$id("toStaiBtn").onclick=()=>{ $id("handUseCard").classList.add("hidden"); startStai(); };

/* STAI Soruları */
function startStai(){
 renderStai();
 $id("staiCard").classList.remove("hidden");
}

function renderStai(){
 const qs=[
"Şu anda sakinim","Kendimi emniyette hissediyorum","Şu anda sinirlerim gergin",
"Pişmanlık duygusu içindeyim","Şu anda huzur içindeyim","Şu anda hiç keyfim yok",
"Başıma geleceklerden endişe ediyorum","Kendimi dinlenmiş hissediyorum","Şu anda kaygılıyım",
"Kendimi rahat hissediyorum","Kendime güvenim var","Şu anda asabım bozuk","Çok sinirliyim",
"Sinirlerimin çok gergin olduğunu hissediyorum","Kendimi rahatlamış hissediyorum",
"Şu anda halimden memnunum","Şu anda endişeliyim","Heyecandan kendimi şaşkına dönmüş hissediyorum",
"Şu anda sevinçliyim","Şu anda keyfim yerinde"];
 $id("staiQuestions").innerHTML=qs.map((q,i)=>`<div><p>${i+1}. ${q}</p>
 <label><input type="radio" name="q${i}" value="1">Hiç</label>
 <label><input type="radio" name="q${i}" value="2">Biraz</label>
 <label><input type="radio" name="q${i}" value="3">Çok</label>
 <label><input type="radio" name="q${i}" value="4">Tamamıyla</label></div>`).join("<hr>");
}

$id("toHearingBtn").onclick=()=>{
 const ans=document.querySelectorAll('#staiQuestions input:checked').length;
 if(ans<20){alert("Tüm STAI sorularını yanıtlayın.");return;}
 $id("staiCard").classList.add("hidden");
 $id("hearingCard").classList.remove("hidden");
};

/* İşitme Testi */
$id("playTone").onclick=()=>{
 if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
 if(osc){osc.stop();osc=null;return;}
 osc=audioCtx.createOscillator();
 const g=audioCtx.createGain();
 g.gain.value=+$id("volumeControl").value;
 osc.frequency.value=1500;
 osc.connect(g).connect(audioCtx.destination);
 osc.start();
 setTimeout(()=>{osc.stop();osc=null;},1000);
};

$id("toSessionIntro").onclick=()=>{
 $id("hearingCard").classList.add("hidden");
 sessionOrder = ['training', 'NF', ...shuffle(['FR', 'FL'])]
 currentSession=0;
 showSessionIntro();
};

/* Oturum Bilgisi */
function showSessionIntro(){
 const s=sessionOrder[currentSession];
 const t={NF:"Normal odak",FR:"Sağ odak",FL:"Sol odak"}[s];
 $id("sessionTitle").innerText="Oturum: "+s;
 $id("sessionInstr").innerText=t;
 $id("sessionIntro").classList.remove("hidden");
}

$id("sessionStartBtn").onclick=()=>{
 $id("sessionIntro").classList.add("hidden");
 startSession();
};

/* Deneme ve Sesler */
const mainPlaylist=["LBA-RKA.wav","LDA-RGA.wav","LPA-RBA.wav"];
const stimAudio=$id("stimAudio");
stimAudio.onended=()=>nextTrial();

function startSession(){
 currentTrial=0;
 $id("trialCard").classList.remove("hidden");
 playTrial();
}

function playTrial(){
 if(currentTrial>=mainPlaylist.length){
   $id("trialCard").classList.add("hidden");
   currentSession++;
   if(currentSession<sessionOrder.length) showSessionIntro();
   else endExp();
   return;
 }
 const stim=mainPlaylist[currentTrial];
 $id("trialStatus").innerText=`${sessionOrder[currentSession]} - Deneme ${currentTrial+1}/${mainPlaylist.length}`;
 stimAudio.src="./resources/sounds/erkek/"+stim;
 stimAudio.play().catch(e=>console.log("Audio play error:",e));
}

function nextTrial(){ currentTrial++; setTimeout(playTrial,1500); }

document.querySelectorAll('.respBtn').forEach(btn=>{
 btn.onclick=()=>{
  results.push({session:sessionOrder[currentSession],trial:currentTrial,response:btn.dataset.val});
 };
});

/* Bitiş */
function endExp(){
 $id("endCard").classList.remove("hidden");
 $id("doneLog").innerText="Katılımcı kodu: "+participant.code;
}
});
</script>
</body>
</html>
