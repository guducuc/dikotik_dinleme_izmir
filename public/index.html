<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dikotik Dinleme Izmir</title>

  <meta name="emailjs-user"    content="FLn2zMqKDGso3ePoO">
  <meta name="emailjs-service" content="service_a8bnfmk">
  <meta name="emailjs-template"content="template_7elc4wi">

  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:12px;color:#111;max-width:340px;margin:auto;}
    h1{font-size:20px;margin-bottom:8px}
    .hidden{display:none}
    .card{padding:12px;border:1px solid #ddd;border-radius:8px;margin-bottom:12px}
    input[type=text], input[type=number], input[type=email], select{padding:8px;margin:6px 0;width:100%;box-sizing:border-box}
    .bigBtn{font-size:1.1rem;padding:12px 20px;margin:6px;border-radius:8px;border:1px solid #444;background:#eaeaea;cursor:pointer;}
    .small{font-size:13px;color:#666}
    .stai-options{display:flex;gap:10px;margin-top:4px;flex-wrap:wrap;}
    .respRow{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;}
    .respBtn{font-size:1.2rem;padding:14px 24px;margin:6px;min-width:110px;border-radius:10px;border:1px solid #444;background:#f2f2f2;cursor:pointer;transition:background-color 0.2s;}
    .respBtn-active{background-color:#bdbdbd;}
    .hand-grid-header{display:flex;justify-content:space-between;margin-bottom:6px;font-weight:600}
    .hand-grid-row{display:flex;align-items:center;justify-content:space-between;border-top:1px solid #eee;padding:4px 0}
    .hand-grid-row span{flex:2}
    .hand-grid-row .col{flex:1;display:flex;justify-content:center;gap:10px}
    #consentText{max-height:240px;overflow-y:auto;border:1px solid #ccc;padding:8px;border-radius:6px;margin-bottom:10px;font-size:14px;line-height:1.4}
  </style>
</head>
<body>
<h1>Dikotik Dinleme İzmir</h1>

<!-- 1️⃣ PROJE KODU SEÇİMİ -->
<div id="projectCard" class="card">
  <h3>Proje Kodu Seçimi</h3>
  <select id="projectCode">
    <option value="">Proje Kodunuzu Seçin</option>
    <option value="OykuTez">OykuTez</option>
    <option value="Izmir">Izmir</option>
    <option value="Esporcu">Esporcu</option>
    <option value="Sporcu">Sporcu</option>
    <option value="Diger">Diğer</option>
  </select>
  <div style="margin-top:8px"><button id="toParticipationBtn" class="bigBtn">Devam</button></div>
</div>

<!-- 2️⃣ KATILIM DURUMU -->
<div id="participationCard" class="card hidden">
  <h3>Katılım Durumu</h3>
  <div id="participationOptions"></div>
  <div style="margin-top:8px"><button id="toNextStepBtn" class="bigBtn">Devam</button></div>
</div>

<!-- 3️⃣ KATILIMCI KODU GİRİŞİ -->
<div id="enterCodeCard" class="card hidden">
  <h3>Katılımcı Kodu</h3>
  <p class="small">Lütfen önceki oturumda size verilen katılımcı kodunu giriniz.</p>
  <input id="previousCode" placeholder="Örnek: ABCD_12345">
  <div style="margin-top:8px"><button id="toStaiDirectBtn" class="bigBtn">Devam</button></div>
</div>

<!-- 4️⃣ KATILIMCI BİLGİLERİ -->
<div id="participantCard" class="card hidden">
  <h3>Katılımcı Bilgileri</h3>
  <input id="name" placeholder="Adınız">
  <input id="surname" placeholder="Soyadınız">
  <input id="age" type="number" placeholder="Yaşınız">
  <input id="race" placeholder="Doğum Yeri / Köken">
  <input id="motherTongue" placeholder="Anadiliniz">
  <input id="email" type="email" placeholder="E-posta adresiniz">
  <input id="phone" type="text" placeholder="Telefon numaranız">
  <select id="gender">
    <option value="">Cinsiyetinizi Seçiniz</option>
    <option value="Kadın">Kadın</option>
    <option value="Erkek">Erkek</option>
    <option value="Diğer">Diğer</option>
  </select>
  <div style="margin-top:8px"><button id="toConsentBtn" class="bigBtn">Devam</button></div>
</div>

<!-- 5️⃣ AYDINLATILMIŞ ONAM -->
<div id="consentCard" class="card hidden">
  <h3>Aydınlatılmış Onam Formu</h3>
  <div id="consentText">
    <p><b>Sayın Katılımcı,</b><br>Bu çalışma, işitsel algı ve dikkat süreçlerinin araştırılması amacıyla yürütülmektedir.
    Katılımınız gönüllülük esasına dayanır. Tüm veriler anonim olarak saklanacaktır.
    Dilediğiniz zaman çalışmadan ayrılabilirsiniz.</p>
    <p>Bu formu onaylayarak araştırmaya katılmayı kabul etmiş olursunuz.</p>
  </div>
  <label><input type="checkbox" id="consentAgree"> Okudum ve onaylıyorum</label>
  <div style="margin-top:8px">
    <button id="backToInfoBtn" class="bigBtn">Geri</button>
    <button id="toHandBtn" class="bigBtn">Devam</button>
  </div>
</div>

<!-- 6️⃣ EL KULLANIMI TESTİ -->
<div id="handUseCard" class="card hidden">
  <h3>El Kullanımı Testi</h3>
  <div id="handUseQuestions"></div>
  <div style="margin-top:8px"><button id="toStaiBtn" class="bigBtn">Devam</button></div>
</div>

<!-- 7️⃣ STAI FORMU -->
<div id="staiCard" class="card hidden">
  <h3>STAI-TXI Formu</h3>
  <div id="staiQuestions"></div>
  <div style="margin-top:8px"><button id="toHearingBtn" class="bigBtn">Devam</button></div>
</div>

<!-- 8️⃣ İŞİTME TESTİ -->
<div id="hearingCard" class="card hidden">
  <h3>İşitme Kontrolü</h3>
  <p>1500 Hz sesleri duyabildiğinizden emin olun.</p>
  <div><strong>Sağ Kulak</strong><br><input type="range" id="rightSlider" min="0" max="1" step="0.01" value="0.5"><button id="playRight" class="bigBtn">Oynat</button></div>
  <div><strong>Sol Kulak</strong><br><input type="range" id="leftSlider" min="0" max="1" step="0.01" value="0.5"><button id="playLeft" class="bigBtn">Oynat</button></div>
  <div style="margin-top:8px"><button id="toSessionIntro" class="bigBtn">Devam</button></div>
</div>

<!-- 9️⃣ DİKOTİK TESTİ, SON EKRAN ve TÜM ORİJİNAL JS -->
<script>
document.addEventListener("DOMContentLoaded", ()=>{

const $id = id => document.getElementById(id);

/* ---------- State ---------- */
let participant = { projectCode: "" };
let results = [], sessionOrder = [], currentSessionIndex = 0, currentTrial = -1;
let audioCtx = null, rightOsc=null,leftOsc=null,rightGain=null,leftGain=null;
let rightLevel = 0.5, leftLevel = 0.5, trialTimeout = null, isResponseAllowed = false;

/* ---------- Helpers ---------- */
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }

/* ---------- Render / Small UI helpers ---------- */
function renderParticipationOptions(code){
  const c = $id("participationOptions");
  c.innerHTML = "";
  if(code === "OykuTez"){
    c.innerHTML = `
      <label><input type="radio" name="participation" value="1"> İlk kez katılıyorum</label><br>
      <label><input type="radio" name="participation" value="2"> Bir kez katıldım ama tamamlayamadım</label><br>
      <label><input type="radio" name="participation" value="3"> İkinci kez katılıyorum</label><br>
      <label><input type="radio" name="participation" value="4"> İki kez katıldım ancak tamamlayamadım</label>`;
  } else {
    c.innerHTML = `
      <label><input type="radio" name="participation" value="1"> İlk kez katılıyorum</label><br>
      <label><input type="radio" name="participation" value="2"> Daha önce katıldım / tamamlayamadım</label>`;
  }
}

/* ---------- HAND & STAI renderers (basit) ---------- */
function renderHand(){
  const c = $id("handUseQuestions");
  const q = ["Yazmak","Çizmek","Taş atmak","Makas kullanmak","Diş fırçası kullanmak","Bıçak kullanmak","Kaşık kullanmak","Süpürge (üst el)","Kibrit çakmak","Kutunun kapağını açmak"];
  c.innerHTML = '<div class="hand-grid-header"><div style="flex:2"></div><div style="flex:1;text-align:center">Sol</div><div style="flex:1;text-align:center">Sağ</div></div>';
  q.forEach((txt,i)=>{
    c.innerHTML += `<div class="hand-grid-row" data-q="${i+1}"><span>${i+1}. ${txt}</span>
      <div class="col"><input type="checkbox" class="left"><input type="checkbox" class="left"></div>
      <div class="col"><input type="checkbox" class="right"><input type="checkbox" class="right"></div>
    </div>`;
  });
}

function renderStai(){
  const questions = ["Şu anda sakinim","Kendimi emniyette hissediyorum","Şu anda sinirlerim gergin","Pişmanlık duygusu içindeyim","Şu anda huzur içindeyim","Şu anda hiç keyfim yok","Başıma geleceklerden endişe ediyorum","Kendimi dinlenmiş hissediyorum","Şu anda kaygılıyım","Kendimi rahat hissediyorum","Kendime güvenim var","Şu anda asabım bozuk","Çok sinirliyim","Sinirlerimin çok gergin olduğunu hissediyorum","Kendimi rahatlamış hissediyorum","Şu anda halimden memnunum","Şu anda endişeliyim","Heyecandan kendimi şaşkına dönmüş hissediyorum","Şu anda sevinçliyim","Şu anda keyfim yerinde"];
  const c = $id("staiQuestions");
  c.innerHTML = "";
  questions.forEach((txt,i)=>{
    c.innerHTML += `<div class="question-group"><p>${i+1}. ${txt}</p>
      <div class="stai-options">
        <label><input type="radio" name="staiQ${i+1}" value="1">Hiç</label>
        <label><input type="radio" name="staiQ${i+1}" value="2">Biraz</label>
        <label><input type="radio" name="staiQ${i+1}" value="3">Çok</label>
        <label><input type="radio" name="staiQ${i+1}" value="4">Tamamıyla</label>
      </div></div>`;
  });
}

/* ---------- Audio tone helpers (hearing test) ---------- */
function ensureCtx(){ if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
function startTone(ch){
  ensureCtx();
  if(ch==='right' && !rightOsc){
    rightOsc = audioCtx.createOscillator(); rightGain = audioCtx.createGain();
    rightOsc.frequency.value = 1500; rightGain.gain.value = Number(rightLevel);
    const m = audioCtx.createChannelMerger(2); rightOsc.connect(rightGain); rightGain.connect(m,0,1); m.connect(audioCtx.destination); rightOsc.start();
  }
  if(ch==='left' && !leftOsc){
    leftOsc = audioCtx.createOscillator(); leftGain = audioCtx.createGain();
    leftOsc.frequency.value = 1500; leftGain.gain.value = Number(leftLevel);
    const m = audioCtx.createChannelMerger(2); leftOsc.connect(leftGain); leftGain.connect(m,0,0); m.connect(audioCtx.destination); leftOsc.start();
  }
}
function stopTone(ch){ try{ if(ch==='right'&&rightOsc){ rightOsc.stop(); rightOsc=null; rightGain=null; } if(ch==='left'&&leftOsc){ leftOsc.stop(); leftOsc=null; leftGain=null; } }catch(e){} }

/* ---------- Flow: project -> participation ---------- */
$id("toParticipationBtn").onclick = ()=>{
  const code = $id("projectCode").value;
  if(!code){ alert("Lütfen proje kodunu seçiniz."); return; }
  participant.projectCode = code;
  $id("projectCard").classList.add("hidden");
  $id("participationCard").classList.remove("hidden");
  renderParticipationOptions(code);
};

/* --------------- IMPORTANT: PARTICIPATION -> next --------------- */
$id("toNextStepBtn").onclick = ()=>{
  const checked = document.querySelector('input[name="participation"]:checked');
  if(!checked){ alert("Lütfen bir seçenek seçiniz."); return; }
  const sel = checked.value;

  if(sel === "1"){
    // Eğer 1 ise: önce ONAM gösterilecek (tüm projeler için)
    $id("participationCard").classList.add("hidden");
    $id("consentCard").classList.remove("hidden");
    // Onam sonrası kullanıcı katılımcı bilgilerini dolduracak:
    // (consent -> consentContinue handler)
  } else {
    // 2/3/4: önce katılımcı kodu istenecek (kod gir -> STAI akışı)
    $id("participationCard").classList.add("hidden");
    $id("enterCodeCard").classList.remove("hidden");
  }
};

/* ---------- Enter previous code -> start STAI only ---------- */
$id("toStaiDirectBtn").onclick = ()=>{
  const prev = $id("previousCode").value.trim();
  if(!prev){ alert("Lütfen önceki katılımcı kodunuzu giriniz."); return; }
  participant.code = prev;
  // proceed to STAI -> hearing -> dichotic
  startStaiOnly();
};

/* ---------- Consent flow ---------- */
/* User saw consent (from participation=1). After agreeing, show participant info. */
$id("toHandBtn").onclick = ()=>{ /* NOTE: this button in some HTMLs used for other flow; we don't use it here */ };

/* We'll add a new explicit handler for consent "Devam" button:
   - If consent checkbox checked -> hide consent and show participant info
*/
$id("toHandBtn").onclick = null; // ensure not bound elsewhere

// Bind consent continue:
$id("toHandBtn").addEventListener ? $id("toHandBtn").addEventListener("click", ()=>{}) : null; 
// But to keep consistent with your markup, we'll use the toHandBtn on consent as "Devam" — override logic below:

// Replace the "toHandBtn" behavior with: consent -> participantInfo
$id("toHandBtn").onclick = ()=>{
  // In this unified script "toHandBtn" is used for consent continue when consentCard is visible.
  if($id("consentCard").classList.contains("hidden")) return; // safety
  if(!$id("consentAgree").checked){ alert("Lütfen onam kutusunu işaretleyiniz."); return; }
  // Hide consent, then show participant info (we want: consent first, then info)
  $id("consentCard").classList.add("hidden");
  $id("participantCard").classList.remove("hidden");
};

/* ---------- Participant info -> after fill (then hand use) ---------- */
$id("toConsentBtn").onclick = ()=>{
  // This button now means "Devam" from participant info to next (hand test)
  // Validate required fields
  const fields = ['name','surname','age','gender'];
  for(const f of fields){
    if(!$id(f) || !$id(f).value.trim()){ alert("Lütfen tüm zorunlu alanları doldurunuz."); return; }
  }
  // save participant data
  participant.name = $id("name").value.trim();
  participant.surname = $id("surname").value.trim();
  participant.age = $id("age").value.trim();
  participant.gender = $id("gender").value.trim();
  participant.race = $id("race").value.trim();
  participant.motherTongue = $id("motherTongue").value.trim();
  participant.email = $id("email").value.trim();
  participant.phone = $id("phone").value.trim();

  // generate code if not exists (for new participants)
  if(!participant.code){
    const initials = (participant.name.slice(0,2)+participant.surname.slice(0,2)).toUpperCase().replace(/[^A-Z]/g,'X');
    const rand = Math.floor(10000 + Math.random()*90000);
    participant.code = `${participant.projectCode}_${initials}_${rand}`;
    $id('codeInfo') && ($id('codeInfo').innerText = "Katılımcı kodu: " + participant.code);
  }

  // go to hand use test
  $id("participantCard").classList.add("hidden");
  $id("handUseCard").classList.remove("hidden");
  renderHand();
};

/* ---------- Hand use -> confirm -> STAI ---------- */
$id("toStaiBtn").onclick = ()=>{
  const rows = document.querySelectorAll('#handUseQuestions .hand-grid-row');
  for(const r of rows){
    if(r.querySelectorAll('input:checked').length !== 2){
      alert("Her satır için 2 kutucuk işaretleyiniz."); return;
    }
  }
  // save hand preferences
  participant.handUse = Array.from(rows).map(r=>({
    q: r.dataset.q,
    left: r.querySelectorAll('.left:checked').length,
    right: r.querySelectorAll('.right:checked').length
  }));
  // move to STAI
  $id("handUseCard").classList.add("hidden");
  renderStai();
  $id("staiCard").classList.remove("hidden");
};

/* ---------- STAI -> Hearing ---------- */
$id("toHearingBtn").onclick = ()=>{
  const answered = document.querySelectorAll('#staiQuestions input:checked').length;
  const total = document.querySelectorAll('#staiQuestions input[type=radio]').length / 4;
  if(answered < total){ alert("Lütfen tüm STAI sorularını yanıtlayınız."); return; }
  // store STAI answers
  const ans = {};
  document.querySelectorAll('#staiQuestions input:checked').forEach(i => ans[i.name] = i.value);
  participant.staiAnswers = ans;

  $id("staiCard").classList.add("hidden");
  $id("hearingCard").classList.remove("hidden");
};

/* ---------- Hearing -> Session intro ---------- */
/* audio helpers (play/stop) */
$id("playRight").onclick = ()=>{ if(rightOsc){ stopTone('right'); } else { stopTone('left'); startTone('right'); } };
$id("playLeft").onclick  = ()=>{ if(leftOsc){ stopTone('left'); } else { stopTone('right'); startTone('left'); } };
$id("rightSlider").oninput = e => { rightLevel = e.target.value; if(rightGain) rightGain.gain.value = Number(rightLevel); };
$id("leftSlider").oninput  = e => { leftLevel = e.target.value; if(leftGain) leftGain.gain.value = Number(leftLevel); };

$id("toSessionIntro").onclick = ()=>{
  stopTone('right'); stopTone('left');
  participant.rightLevel = rightLevel; participant.leftLevel = leftLevel;
  results.push({ session: "hearing_level", stim: "1500Hz", response: `right=${rightLevel},left=${leftLevel}`, code: participant.code });
  $id("hearingCard").classList.add("hidden");
  // set session order and start
  sessionOrder = ['training', 'NF', ...shuffle(['FR','FL'])];
  currentSessionIndex = 0;
  showSessionIntro();
};

/* ---------- Minimal session/trial code (keeps original behavior) ---------- */
const mainPlaylist=[ "LBA-RKA.wav","LDA-RGA.wav","LPA-RBA.wav","LKA-RDA.wav","LBA-RBA.wav","LTA-RGA.wav","LBA-RDA.wav","LGA-RPA.wav","LDA-RKA.wav","LPA-RTA.wav","LKA-RKA.wav","LBA-RGA.wav","LKA-RPA.wav","LTA-RDA.wav","LGA-RKA.wav","LPA-RDA.wav","LGA-RGA.wav","LBA-RTA.wav","LGA-RDA.wav","LKA-RTA.wav","LDA-RPA.wav","LTA-RKA.wav","LPA-RPA.wav","LDA-RBA.wav","LGA-RTA.wav","LPA-RKA.wav","LTA-RBA.wav","LKA-RGA.wav","LTA-RTA.wav","LBA-RPA.wav","LDA-RTA.wav","LGA-RBA.wav","LTA-RPA.wav","LDA-RDA.wav","LKA-RBA.wav","LPA-RGA.wav" ];
const trainingPlaylist=[ "LBA-RBA.wav","LDA-RDA.wav","LGA-RGA.wav","LKA-RKA.wav","LPA-RPA.wav","LTA-RTA.wav","LBA-RDA.wav","LDA-RGA.wav","LGA-RKA.wav","LKA-RTA.wav" ];
const instr = {
  training: "Eğitim oturumu (yanıtlar kaydedilmeyecek).",
  NF: "Normal odak: en iyi duyduğunuz heceyi seçin.",
  FR: "Sağ kulağa odaklanın ve sağdan duyduğunuz heceyi seçin.",
  FL: "Sol kulağa odaklanın ve soldan duyduğunuz heceyi seçin."
};

function showSessionIntro(){
  const s = sessionOrder[currentSessionIndex];
  $id('sessionTitle').innerText = "Oturum: " + s;
  $id('sessionInstr').innerHTML = instr[s];
  $id('sessionIntro').classList.remove('hidden');
}
async function unlockAudio(){
  try{ const a = document.querySelector('#stimAudio') || new Audio(); if(a) { a.src = ''; } } catch(e){}
}
$id('sessionStartBtn') && ($id('sessionStartBtn').onclick = ()=>{
  $id('sessionIntro').classList.add('hidden');
  setTimeout(()=>{ $id('waitScreen') && $id('waitScreen').classList.remove('hidden'); setTimeout(()=>{ $id('waitScreen') && $id('waitScreen').classList.add('hidden'); startSession(); }, 1000); }, 200);
});

function startSession(){ currentTrial = -1; $id('trialCard').classList.remove('hidden'); nextTrial(); }
function nextTrial(){
  clearTimeout(trialTimeout);
  const sessionType = sessionOrder[currentSessionIndex];
  const playlist = (sessionType === 'training') ? trainingPlaylist : mainPlaylist;
  currentTrial++;
  if(currentTrial >= playlist.length){
    $id('trialCard').classList.add('hidden');
    currentSessionIndex++;
    if(currentSessionIndex < sessionOrder.length){ showSessionIntro(); } else { endExperiment(); }
    return;
  }
  const stim = playlist[currentTrial];
  $id('trialStatus').innerText = `Deneme ${currentTrial+1}/${playlist.length} (${sessionType})`;
  playStim(stim);
}

function playStim(stim){
  const a = $id('stimAudio');
  isResponseAllowed = false;
  a.src = (window.location.origin || '') + '/sounds/erkek/' + stim; // adapt path if needed
  a.play().catch(()=>{ /* ignore autoplay errors */});
  a.onplaying = ()=>{ setTimeout(()=>{ isResponseAllowed = true; }, 500); };
  trialTimeout = setTimeout(()=>{
    if(sessionOrder[currentSessionIndex] !== 'training'){
      results.push({ session: sessionOrder[currentSessionIndex], trial: currentTrial+1, stim, response: "no_response", code: participant.code });
    }
    nextTrial();
  }, 4000);
}

/* response buttons */
document.querySelectorAll('.respBtn').forEach(btn=>{
  btn.onclick = ()=>{
    if(!isResponseAllowed) return;
    isResponseAllowed = false;
    clearTimeout(trialTimeout);
    const resp = btn.dataset.val;
    const sessionType = sessionOrder[currentSessionIndex];
    const playlist = (sessionType === 'training') ? trainingPlaylist : mainPlaylist;
    const stim = playlist[currentTrial];

    if(sessionType !== 'training'){
      results.push({
        session: sessionType,
        trial: currentTrial+1,
        stim: stim,
        response: resp,
        code: participant.code
      });
    }
    btn.classList.add('respBtn-active');
    setTimeout(()=> btn.classList.remove('respBtn-active'), 500);
    setTimeout(()=> nextTrial(), 2500);
  };
});

/* ---------- end experiment ---------- */
function endExperiment(){
  $id('endCard').classList.remove('hidden');
  $id('doneLog') && ($id('doneLog').innerText = "Deney tamamlandı. Katılımcı kodu: " + (participant.code || ''));
}

/* ---------- startStaiOnly: for returning participants who enter code ---------- */
function startStaiOnly(){
  // hide enter code UI and start from STAI
  $id("enterCodeCard").classList.add("hidden");
  // If you have stored data for that code in backend you could fetch and prefill here.
  // For now, we just proceed to STAI
  renderStai();
  $id("staiCard").classList.remove("hidden");
}

/* ---------- initialize basic UI elements ---------- */
renderStai(); // prepare stai markup (used in both flows)

}); // DOMContentLoaded end
</script>
</body>
</html>
