<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dikotik Dinleme İzmir</title>

  <meta name="emailjs-user"    content="FLn2zMqKDGso3ePoO">
  <meta name="emailjs-service" content="service_a8bnfmk">
  <meta name="emailjs-template"content="template_7elc4wi">

  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:12px;color:#111;max-width:340px;margin:auto;}
    h1{font-size:20px;margin-bottom:8px}
    .hidden{display:none}
    .card{padding:12px;border:1px solid #ddd;border-radius:8px;margin-bottom:12px}
    input[type=text], input[type=number], input[type=email], select{padding:8px;margin:6px 0;width:100%;box-sizing:border-box}
    .bigBtn{font-size:1.1rem;padding:12px 20px;margin:6px;border-radius:8px;border:1px solid #444;background:#eaeaea;cursor:pointer;}
    .small{font-size:13px;color:#666}
    .stai-options{display:flex;gap:10px;margin-top:4px;flex-wrap:wrap;}
    .respRow{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;}
    .respBtn{font-size:1.2rem;padding:14px 24px;margin:6px;min-width:110px;border-radius:10px;border:1px solid #444;background:#f2f2f2;cursor:pointer;transition:background-color 0.2s;}
    .respBtn-active{background-color:#bdbdbd;}
    .hand-grid-header{display:flex;justify-content:space-between;margin-bottom:6px;font-weight:600}
    .hand-grid-row{display:flex;align-items:center;justify-content:space-between;border-top:1px solid #eee;padding:4px 0}
    .hand-grid-row span{flex:2}
    .hand-grid-row .col{flex:1;display:flex;justify-content:center;gap:10px}
    #consentText{max-height:240px;overflow-y:auto;border:1px solid #ccc;padding:8px;border-radius:6px;margin-bottom:10px;font-size:14px;line-height:1.4}
  </style>
</head>
<body>
<h1>Dikotik Dinleme İzmir</h1>

<div id="projectCard" class="card">
  <h3>Proje Kodu Seçimi</h3>
  <select id="projectCode">
    <option value="">Proje Kodunuzu Seçin</option>
    <option value="OykuTez">OykuTez</option>
    <option value="Izmir">Izmir</option>
    <option value="Esporcu">Esporcu</option>
    <option value="Sporcu">Sporcu</option>
    <option value="Diger">Diğer</option>
  </select>
  <div style="margin-top:8px"><button id="toParticipationBtn" class="bigBtn">Devam</button></div>
</div>

<div id="participationCard" class="card hidden">
  <h3>Katılım Durumu</h3>
  <div id="participationOptions"></div>
  <div style="margin-top:8px; display: flex; justify-content: space-between;">
    <button id="backToProjectCodeBtn" class="bigBtn">Geri</button>
    <button id="toNextStepBtn" class="bigBtn">Devam</button>
  </div>
</div>

<div id="enterCodeCard" class="card hidden">
  <h3>Katılımcı Kodu</h3>
  <p class="small">Lütfen önceki oturumda size verilen katılımcı kodunu giriniz.</p>
  <input id="previousCode" placeholder="Örnek: ABCD_12345">
  <div style="margin-top:8px; display: flex; justify-content: space-between;">
    <button id="backToParticipationBtn_code" class="bigBtn">Geri</button>
    <button id="toHandDirectBtn" class="bigBtn">Devam</button>
  </div>
</div>

<div id="participantCard" class="card hidden">
  <h3>Katılımcı Bilgileri</h3>
  <input id="name" placeholder="Adınız">
  <input id="surname" placeholder="Soyadınız">
  <input id="age" type="number" placeholder="Yaşınız">
  <input id="race" placeholder="Doğum Yeri / Köken">
  <input id="motherTongue" placeholder="Anadiliniz">
  <input id="email" type="email" placeholder="E-posta adresiniz">
  <input id="phone" type="text" placeholder="Telefon numaranız">
  <select id="gender">
    <option value="">Cinsiyetinizi Seçiniz</option>
    <option value="Kadın">Kadın</option>
    <option value="Erkek">Erkek</option>
    <option value="Diğer">Diğer</option>
  </select>
  <div style="margin-top:8px; display: flex; justify-content: space-between;">
    <button id="backToConsentBtn" class="bigBtn">Geri</button>
    <button id="toHandBtn" class="bigBtn">Devam</button>
  </div>
  <div id="codeInfo" class="small" style="margin-top:8px"></div>
</div>

<div id="consentCard" class="card hidden">
  <h3>Aydınlatılmış Onam Formu</h3>
  <div id="consentText">
    <p><b>Sayın Katılımcı,</b><br>Bu çalışma, işitsel algı ve dikkat süreçlerinin araştırılması amacıyla yürütülmektedir.
    Katılımınız gönüllülük esasına dayanır. Tüm veriler anonim olarak saklanacaktır.
    Dilediğiniz zaman çalışmadan ayrılabilirsiniz.</p>
    <p>Bu formu onaylayarak araştırmaya katılmayı kabul etmiş olursunuz.</p>
  </div>
  <label><input type="checkbox" id="consentAgree"> Okudum ve onaylıyorum</label>
  <div style="margin-top:8px; display: flex; justify-content: space-between;">
    <button id="backToParticipationBtn_consent" class="bigBtn">Geri</button>
    <button id="toParticipantInfoBtn" class="bigBtn">Devam</button>
  </div>
</div>

<div id="handUseCard" class="card hidden">
  <h3>El Kullanımı Testi</h3>
  <div id="handUseQuestions"></div>
  <div style="margin-top:8px; display: flex; justify-content: space-between;">
    <button id="backToParticipantInfoBtn" class="bigBtn">Geri</button>
    <button id="toStaiBtn" class="bigBtn">Devam</button>
  </div>
</div>

<div id="staiCard" class="card hidden">
  <h3>STAI-TXI Formu</h3>
  <div id="staiQuestions"></div>
  <div style="margin-top:8px; display: flex; justify-content: space-between;">
    <button id="backToHandBtn" class="bigBtn">Geri</button>
    <button id="toHearingBtn" class="bigBtn">Devam</button>
  </div>
</div>

<div id="hearingCard" class="card hidden">
  <h3>İşitme Kontrolü</h3>
  <p>1500 Hz sesleri duyabildiğinizden emin olun.</p>
  <div><strong>Sağ Kulak</strong><br><input type="range" id="rightSlider" min="0" max="1" step="0.01" value="0.5"><button id="playRight" class="bigBtn">Oynat</button></div>
  <div><strong>Sol Kulak</strong><br><input type="range" id="leftSlider" min="0" max="1" step="0.01" value="0.5"><button id="playLeft" class="bigBtn">Oynat</button></div>
  <div style="margin-top:8px; display: flex; justify-content: space-between;">
    <button id="backToStaiBtn_hearing" class="bigBtn">Geri</button>
    <button id="toSessionIntro" class="bigBtn">Devam</button>
  </div>
</div>

<div id="sessionIntro" class="card hidden">
    <h3 id="sessionTitle"></h3>
    <p id="sessionInstr"></p>
    <div style="margin-top:10px"><button id="sessionStartBtn" class="bigBtn">Devam</button></div>
</div>

<div id="waitScreen" class="card hidden"><h3>Test birazdan başlıyor...lütfen kulaklık ses seviyesini değiştirmeyin</h3></div>

<div id="trialCard" class="card hidden">
    <div id="trialStatus" class="small" style="margin-bottom:8px"></div>
    <audio id="stimAudio" controls style="display:none" preload="auto"></audio> 
    <div class="respRow">
        <button class="respBtn" data-val="BA">BA</button>
        <button class="respBtn" data-val="DA">DA</button>
        <button class="respBtn" data-val="GA">GA</button>
        <button class="respBtn" data-val="KA">KA</button>
        <button class="respBtn" data-val="PA">PA</button>
        <button class="respBtn" data-val="TA">TA</button>
    </div>
</div>

<div id="endCard" class="card hidden">
    <h3>Deney tamamlandı ✅</h3>
    <div id="doneLog" class="small"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", ()=>{

const $id = id => document.getElementById(id);

/* ---------- CONFIG (EKLENDİ) ---------- */
const CONFIG = {
    // Ses dosyalarının bulunduğu dizin yolu
    AUDIO_PATH: '/sounds/erkek/', 
    EMAILJS_USER: document.querySelector('meta[name="emailjs-user"]').content,
    EMAILJS_SERVICE: document.querySelector('meta[name="emailjs-service"]').content,
    EMAILJS_TEMPLATES: {
        'OykuTez': "template_r6sddff", 
        'Diger': document.querySelector('meta[name="emailjs-template"]').content 
    }
};

/* ---------- State ---------- */
let participant = { projectCode: "" };
let results = [], sessionOrder = [], currentSessionIndex = 0, currentTrial = -1;
let audioCtx = null, rightOsc=null,leftOsc=null,rightGain=null,leftGain=null;
let rightLevel = 0.5, leftLevel = 0.5, trialTimeout = null, isResponseAllowed = false;

/* ---------- Constants ---------- */
const mainPlaylist=[ "LBA-RKA.wav","LDA-RGA.wav","LPA-RBA.wav","LKA-RDA.wav","LBA-RBA.wav","LTA-RGA.wav","LBA-RDA.wav","LGA-RPA.wav","LDA-RKA.wav","LPA-RTA.wav","LKA-RKA.wav","LBA-RGA.wav","LKA-RPA.wav","LTA-RDA.wav","LGA-RKA.wav","LPA-RDA.wav","LGA-RGA.wav","LBA-RTA.wav","LGA-RDA.wav","LKA-RTA.wav","LDA-RPA.wav","LTA-RKA.wav","LPA-RPA.wav","LDA-RBA.wav","LGA-RTA.wav","LPA-RKA.wav","LTA-RBA.wav","LKA-RGA.wav","LTA-RTA.wav","LBA-RPA.wav","LDA-RTA.wav","LGA-RBA.wav","LTA-RPA.wav","LDA-RDA.wav","LKA-RBA.wav","LPA-RGA.wav" ];
const trainingPlaylist=[ "LBA-RBA.wav","LDA-RDA.wav","LGA-RGA.wav","LKA-RKA.wav","LPA-RPA.wav","LTA-RTA.wav","LBA-RDA.wav","LDA-RGA.wav","LGA-RKA.wav","LKA-RTA.wav" ];
const instr = {
  training: "Eğitim oturumu (yanıtlar kaydedilmeyecek).",
  NF: "Normal odak: en iyi duyduğunuz heceyi seçin.",
  FR: "Sağ kulağa odaklanın ve sağdan duyduğunuz heceyi seçin.",
  FL: "Sol kulağa odaklanın ve soldan duyduğunuz heceyi seçin."
};

/* ---------- Helpers ---------- */
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }
function trToEn(s){return s.replace(/Ğ/g,"G").replace(/ğ/g,"g").replace(/İ/g,"I").replace(/ı/g,"i").replace(/Ş/g,"S").replace(/ş/g,"s").replace(/Ü/g,"U").replace(/ü/g,"u").replace(/Ö/g,"O").replace(/ö/g,"o").replace(/Ç/g,"C").replace(/ç/g,"c").replace(/ /g,'');}

/* ---------- Render / Small UI helpers ---------- */
function renderParticipationOptions(code){
  const c = $id("participationOptions");
  c.innerHTML = "";
  if(code === "OykuTez"){
    c.innerHTML = `
      <label><input type="radio" name="participation" value="first_full"> İlk kez katılıyorum (Tam)</label><br>
      <label><input type="radio" name="participation" value="first_half"> Bir kez katıldım ama tamamlayamadım (Yarım)</label><br>
      <label><input type="radio" name="participation" value="second_full"> İkinci kez katılıyorum (Tam)</label><br>
      <label><input type="radio" name="participation" value="second_half"> İkinci kez katıldım ancak tamamlayamadım (Yarım)</label>`;
  } else {
    c.innerHTML = `
      <label><input type="radio" name="participation" value="first_full"> İlk kez katılıyorum</label><br>
      <label><input type="radio" name="participation" value="first_half"> Daha önce katıldım / tamamlayamadım</label>`;
  }
}

/* ---------- HAND & STAI renderers ---------- */
function renderHand(){
  const c = $id("handUseQuestions");
  const q = ["Yazmak","Çizmek","Taş atmak","Makas kullanmak","Diş fırçası kullanmak","Bıçak kullanmak","Kaşık kullanmak","Süpürge (üst el)","Kibrit çakmak","Kutunun kapağını açmak"];
  c.innerHTML = '<div class="hand-grid-header"><div style="flex:2"></div><div style="flex:1;text-align:center">Sol</div><div style="flex:1;text-align:center">Sağ</div></div>';
  q.forEach((txt,i)=>{
    c.innerHTML += `<div class="hand-grid-row" data-q="${i+1}"><span>${i+1}. ${txt}</span>
      <div class="col"><input type="checkbox" class="left"><input type="checkbox" class="left"></div>
      <div class="col"><input type="checkbox" class="right"><input type="checkbox" class="right"></div>
    </div>`;
  });
}

function renderStai(){
  const questions = ["Şu anda sakinim","Kendimi emniyette hissediyorum","Şu anda sinirlerim gergin","Pişmanlık duygusu içindeyim","Şu anda huzur içindeyim","Şu anda hiç keyfim yok","Başıma geleceklerden endişe ediyorum","Kendimi dinlenmiş hissediyorum","Şu anda kaygılıyım","Kendimi rahat hissediyorum","Kendime güvenim var","Şu anda asabım bozuk","Çok sinirliyim","Sinirlerimin çok gergin olduğunu hissediyorum","Kendimi rahatlamış hissediyorum","Şu anda halimden memnunum","Şu anda endişeliyim","Heyecandan kendimi şaşkına dönmüş hissediyorum","Şu anda sevinçliyim","Şu anda keyfim yerinde"];
  const c = $id("staiQuestions");
  c.innerHTML = "";
  questions.forEach((txt,i)=>{
    c.innerHTML += `<div class="question-group"><p>${i+1}. ${txt}</p>
      <div class="stai-options">
        <label><input type="radio" name="staiQ${i+1}" value="1">Hiç</label>
        <label><input type="radio" name="staiQ${i+1}" value="2">Biraz</label>
        <label><input type="radio" name="staiQ${i+1}" value="3">Çok</label>
        <label><input type="radio" name="staiQ${i+1}" value="4">Tamamıyla</label>
      </div></div>`;
  });
}

/* ---------- Audio tone helpers (hearing test) ---------- */
function ensureCtx(){ if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
function startTone(ch){
  ensureCtx();
  if(ch==='right' && !rightOsc){
    rightOsc = audioCtx.createOscillator(); rightGain = audioCtx.createGain();
    rightOsc.frequency.value = 1500; rightGain.gain.value = Number(rightLevel);
    const m = audioCtx.createChannelMerger(2); rightOsc.connect(rightGain); rightGain.connect(m,0,1); m.connect(audioCtx.destination); rightOsc.start();
  }
  if(ch==='left' && !leftOsc){
    leftOsc = audioCtx.createOscillator(); leftGain = audioCtx.createGain();
    leftOsc.frequency.value = 1500; leftGain.gain.value = Number(leftLevel);
    const m = audioCtx.createChannelMerger(2); leftOsc.connect(leftGain); leftGain.connect(m,0,0); m.connect(audioCtx.destination); leftOsc.start();
  }
}
function stopTone(ch){ try{ if(ch==='right'&&rightOsc){ rightOsc.stop(); rightOsc=null; rightGain=null; } if(ch==='left'&&leftOsc){ leftOsc.stop(); leftOsc=null; leftGain=null; } }catch(e){} }

/* ---------- Flow: project -> participation ---------- */
$id("toParticipationBtn").onclick = ()=>{
  const code = $id("projectCode").value;
  if(!code){ alert("Lütfen proje kodunu seçiniz."); return; }
  participant.projectCode = code;
  $id("projectCard").classList.add("hidden");
  $id("participationCard").classList.remove("hidden");
  renderParticipationOptions(code);
};

/* Back Buttons */
$id("backToProjectCodeBtn").onclick = () => { $id("participationCard").classList.add("hidden"); $id("projectCard").classList.remove("hidden"); };
$id("backToParticipationBtn_code").onclick = () => { $id("enterCodeCard").classList.add("hidden"); $id("participationCard").classList.remove("hidden"); };
$id("backToParticipationBtn_consent").onclick = () => { $id("consentCard").classList.add("hidden"); $id("participationCard").classList.remove("hidden"); };
$id("backToConsentBtn").onclick = () => { $id("participantCard").classList.add("hidden"); $id("consentCard").classList.remove("hidden"); };
$id("backToParticipantInfoBtn").onclick = () => { $id("handUseCard").classList.add("hidden"); $id("participantCard").classList.remove("hidden"); };
$id("backToHandBtn").onclick = () => { $id("staiCard").classList.add("hidden"); $id("handUseCard").classList.remove("hidden"); };
$id("backToStaiBtn_hearing").onclick = () => { $id("hearingCard").classList.add("hidden"); $id("staiCard").classList.remove("hidden"); };

/* --------------- PARTICIPATION -> next --------------- */
$id("toNextStepBtn").onclick = ()=>{
  const checked = document.querySelector('input[name="participation"]:checked');
  if(!checked){ alert("Lütfen bir seçenek seçiniz."); return; }
  participant.participationStatus = checked.value;
  const sel = checked.value;

  $id("participationCard").classList.add("hidden");

  if(sel === "first_full"){
    $id("consentCard").classList.remove("hidden");
  } else {
    $id("enterCodeCard").classList.remove("hidden");
  }
};

/* ---------- Consent flow ---------- */
$id("toParticipantInfoBtn").onclick = ()=>{
  if(!$id("consentAgree").checked){ alert("Lütfen onam kutusunu işaretleyiniz."); return; }
  $id("consentCard").classList.add("hidden");
  $id("participantCard").classList.remove("hidden");
};

/* ---------- Participant info -> after fill (then hand use) ---------- */
$id("toHandBtn").onclick = ()=>{
  const fields = ['name','surname','age','gender','email'];
  for(const f of fields){
    if(!$id(f) || !$id(f).value.trim()){ alert("Lütfen tüm zorunlu alanları doldurunuz."); return; }
  }
  
  participant.name = $id("name").value.trim();
  participant.surname = $id("surname").value.trim();
  participant.age = $id("age").value.trim();
  participant.gender = $id("gender").value.trim();
  participant.race = $id("race").value.trim();
  participant.motherTongue = $id("motherTongue").value.trim();
  participant.email = $id("email").value.trim();
  participant.phone = $id("phone").value.trim();

  if(!participant.code){
    const initials = (participant.name.slice(0,2)+participant.surname.slice(0,2)).toUpperCase().replace(/[^A-Z]/g,'X');
    const rand = Math.floor(10000 + Math.random()*90000);
    participant.code = `${participant.projectCode}_${initials}_${rand}`;
    $id('codeInfo') && ($id('codeInfo').innerText = "Katılımcı kodu: " + participant.code);
  }

  $id("participantCard").classList.add("hidden");
  $id("handUseCard").classList.remove("hidden");
  renderHand();
};

/* ---------- Enter previous code -> start Hand Only (or STAI for second_full) ---------- */
$id("toHandDirectBtn").onclick = ()=>{
  const prev = $id("previousCode").value.trim();
  if(!prev){ alert("Lütfen önceki katılımcı kodunuzu giriniz."); return; }
  participant.code = prev;
  participant.prevCode = prev;

  $id("enterCodeCard").classList.add("hidden");
  
  // Önceki katılımcılar için doğrudan El Kullanım Testine git
  renderHand();
  $id("handUseCard").classList.remove("hidden");
};

/* ---------- Hand use -> confirm -> STAI ---------- */
$id("toStaiBtn").onclick = ()=>{
  const rows = document.querySelectorAll('#handUseQuestions .hand-grid-row');
  for(const r of rows){
    if(r.querySelectorAll('input:checked').length !== 2){
      alert("Her satır için tam olarak 2 kutucuk işaretleyiniz."); return;
    }
  }
  participant.handUse = Array.from(rows).map(r=>({
    q: r.dataset.q,
    left: r.querySelectorAll('.left:checked').length,
    right: r.querySelectorAll('.right:checked').length
  }));
  
  $id("handUseCard").classList.add("hidden");
  renderStai();
  $id("staiCard").classList.remove("hidden");
};

/* ---------- STAI -> Hearing ---------- */
$id("toHearingBtn").onclick = ()=>{
  const answered = document.querySelectorAll('#staiQuestions input:checked').length;
  const total = document.querySelectorAll('#staiQuestions input[type=radio]').length / 4;
  if(answered < total){ alert("Lütfen tüm STAI sorularını yanıtlayınız."); return; }
  
  const ans = {};
  document.querySelectorAll('#staiQuestions input:checked').forEach(i => ans[i.name] = i.value);
  participant.staiAnswers = ans;

  $id("staiCard").classList.add("hidden");
  $id("hearingCard").classList.remove("hidden");
};

/* ---------- Hearing -> Session intro ---------- */
/* audio helpers (play/stop) */
$id("playRight").onclick = ()=>{ if(rightOsc){ stopTone('right'); } else { stopTone('left'); startTone('right'); } };
$id("playLeft").onclick  = ()=>{ if(leftOsc){ stopTone('left'); } else { stopTone('right'); startTone('left'); } };
$id("rightSlider").oninput = e => { rightLevel = e.target.value; if(rightGain) rightGain.gain.value = Number(rightLevel); };
$id("leftSlider").oninput  = e => { leftLevel = e.target.value; if(leftGain) leftGain.gain.value = Number(leftLevel); };

$id("toSessionIntro").onclick = ()=>{
  stopTone('right'); stopTone('left');
  participant.rightLevel = rightLevel; participant.leftLevel = leftLevel;
  results.push({ session: "hearing_level", stim: "1500Hz", response: `right=${rightLevel},left=${leftLevel}`, code: participant.code });
  $id("hearingCard").classList.add("hidden");
  
  sessionOrder = ['training', 'NF', ...shuffle(['FR','FL'])];
  currentSessionIndex = 0;
  showSessionIntro();
};

/* ---------- Session/Trial Logic (Ses Çalma Düzenlendi) ---------- */

function showSessionIntro(){
  const s = sessionOrder[currentSessionIndex];
  $id('sessionTitle').innerText = "Oturum: " + s;
  $id('sessionInstr').innerHTML = instr[s];
  $id('sessionIntro').classList.remove('hidden');
}

$id('sessionStartBtn').onclick = ()=>{
  $id('sessionIntro').classList.add('hidden');
  $id('waitScreen').classList.remove('hidden');
  setTimeout(()=>{ $id('waitScreen').classList.add('hidden'); startSession(); }, 1000); 
};

function startSession(){ currentTrial = -1; $id('trialCard').classList.remove('hidden'); nextTrial(); }

function nextTrial(){
  clearTimeout(trialTimeout);
  const sessionType = sessionOrder[currentSessionIndex];
  const playlist = (sessionType === 'training') ? trainingPlaylist : mainPlaylist;
  currentTrial++;
  if(currentTrial >= playlist.length){
    $id('trialCard').classList.add('hidden');
    currentSessionIndex++;
    if(currentSessionIndex < sessionOrder.length){ showSessionIntro(); } else { endExperiment(); }
    return;
  }
  const stim = playlist[currentTrial];
  $id('trialStatus').innerText = `Deneme ${currentTrial+1}/${playlist.length} (${sessionType})`;
  playStim(stim);
}

function playStim(stim){
  const a = $id('stimAudio');
  isResponseAllowed = false;
  
  // HATA GİDERİLDİ: CONFIG.AUDIO_PATH kullanılarak ses yolu tanımlanıyor
  a.src = CONFIG.AUDIO_PATH + stim; 
  
  a.play().catch(()=>{ 
    // Sesin çalmaması durumunda kullanıcı etkileşimini tekrar isteyebilir.
    // Şimdilik sadece uyarı veriliyor.
    console.warn("Autoplay failed. User interaction may be required."); 
  });

  a.onplaying = ()=>{ setTimeout(()=>{ isResponseAllowed = true; }, 500); };
  trialTimeout = setTimeout(()=>{
    if(sessionOrder[currentSessionIndex] !== 'training'){
      results.push({ 
        session: sessionOrder[currentSessionIndex], 
        trial: currentTrial+1, 
        stim, 
        response: "no_response", 
        code: participant.code 
      });
    }
    nextTrial();
  }, 4000);
}

/* response buttons */
document.querySelectorAll('.respBtn').forEach(btn=>{
  btn.onclick = ()=>{
    if(!isResponseAllowed) return;
    isResponseAllowed = false;
    clearTimeout(trialTimeout);
    const resp = btn.dataset.val;
    const sessionType = sessionOrder[currentSessionIndex];
    const playlist = (sessionType === 'training') ? trainingPlaylist : mainPlaylist;
    const stim = playlist[currentTrial];

    if(sessionType !== 'training'){
      results.push({
        session: sessionType,
        trial: currentTrial+1,
        stim: stim,
        response: resp,
        code: participant.code
      });
    }
    btn.classList.add('respBtn-active');
    setTimeout(()=> btn.classList.remove('respBtn-active'), 500);
    setTimeout(()=> nextTrial(), 2500);
  };
});

/* ---------- end experiment / email logic (EKLENDİ) ---------- */
async function sendEmail(){
    const csv = makeCsv();
    if(!csv) return;
    
    const projectCode = participant.projectCode || 'Diger';
    const templateID = CONFIG.EMAILJS_TEMPLATES[projectCode] || CONFIG.EMAILJS_TEMPLATES['Diger'];

    try{
        emailjs.init(CONFIG.EMAILJS_USER);
        const resp=await emailjs.send(CONFIG.EMAILJS_SERVICE, templateID, {
            subject:participant.code,
            message:csv
        });
        $id('doneLog').innerText="Verileriniz başarıyla kaydedildi. Katılımınız için teşekkürler. E-posta gönderim durumu: "+JSON.stringify(resp);
    }catch(err){
        $id('doneLog').innerText="Verileriniz kaydedildi, ancak e-posta gönderilemedi: "+JSON.stringify(err);
    }
}

function makeCsv(){
    const allData = [
        {
            session: "info",
            trial: 0,
            participationStatus: participant.participationStatus || "",
            prevCode: participant.prevCode || "",
            rightLevel: participant.rightLevel || "",
            leftLevel: participant.leftLevel || "",
            age: participant.age || "",
            gender: participant.gender || "",
            race: participant.race || "",
            motherTongue: participant.motherTongue || "",
            projectCode: participant.projectCode || "",
            staiAnswers: JSON.stringify(participant.staiAnswers || {}),
            handUse: JSON.stringify(participant.handUse || {}),
            email: participant.email || "",
            phone: participant.phone || "",
            code: participant.code || ""
        },
        ...results
    ];
    const keys = ["session", "trial", "participationStatus", "prevCode", "rightLevel", "leftLevel", "age", "gender", "race", "motherTongue", "projectCode", "staiAnswers", "handUse", "email", "phone", "code", "stim", "response"];
    const header = keys.join(',');
    const rows = allData.map(r => {
        return keys.map(k => {
            const v = (r[k] === null || r[k] === undefined) ? "" : String(r[k]).replace(/,/g, ';').replace(/"/g, '""');
            return `"${v}"`;
        }).join(',');
    });
    return [header, ...rows].join('\n');
}

function endExperiment(){
  $id('endCard').classList.remove('hidden');
  sendEmail(); 
}

/* ---------- initialize basic UI elements ---------- */
renderStai(); // prepare stai markup (used in both flows)

}); // DOMContentLoaded end
</script>
</body>
</html>
