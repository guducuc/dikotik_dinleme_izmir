<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dikotik Dinleme — Tam Sürüm</title>

<meta name="emailjs-user"    content="FLn2zMqKDGso3ePoO">
<meta name="emailjs-service" content="service_a8bnfmk">
<meta name="emailjs-template" content="template_r6sddff">

<style>
  body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:12px;color:#111;max-width:480px;margin:auto}
  h1{font-size:20px;margin-bottom:10px}
  .card{padding:12px;border:1px solid #ddd;border-radius:8px;margin-bottom:12px}
  .hidden{display:none}
  input,select,textarea{padding:8px;margin:6px 0;width:100%;box-sizing:border-box}

  /* Radyo/Checkbox hizalama */
  input[type="radio"], input[type="checkbox"] { width: auto; margin-right: 6px; }
  #participationOptions label, .question-group label { display: block; margin-bottom: 8px; font-size: 14px; }

  .bigBtn{font-size:1rem;padding:10px 14px;border-radius:8px;border:1px solid #444;background:#eaeaea;cursor:pointer; width:100%; margin-top:5px;}
  .btnGreen{background:#2ecc71;color:white;border:none}
  .btnRed{background:#e74c3c;color:white;border:none}
  
  .respRow{ display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; padding: 0 12px; }
  .respBtn{ padding:10px 14px; border-radius:8px; border:1px solid #444; background:#f2f2f2; cursor:pointer; text-align: center; }
  .respBtn-active{background:#bdbdbd}
  .stai-options{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
  .stai-options label { margin-right: 15px; display: inline-block; } 
  .hand-grid-header{display:flex;justify-content:space-between;margin-bottom:6px;font-weight:600}
  .hand-grid-row{display:flex;align-items:center;justify-content:space-between;border-top:1px solid #eee;padding:6px 0}
  .hand-grid-row span{flex:2}
  .hand-grid-row .col{flex:1;display:flex;justify-content:center;gap:8px}
  .small{font-size:13px;color:#666}
  .question-group{margin-bottom:15px; border-bottom: 1px solid #eee; padding-bottom: 10px;}
  .question-title{font-weight: 600; font-size: 14px; margin-bottom: 8px; display: block;}
  
  .modal{position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:none}
  .modal-content{background:#fff;margin:5% auto;padding:20px;border-radius:10px;max-width:600px;max-height:80vh;overflow-y:auto}
  .close{float:right;font-size:24px;font-weight:bold;cursor:pointer;color:#888}
</style>
</head>
<body>
<h1>Dikotik Dinleme</h1>

<div id="projectCard" class="card">
  <h3>Proje Kodu Seçimi</h3>
  <select id="projectCode">
    <option value="">Proje kodu seçiniz</option>
    <option value="OykuTez">Öykü Tez</option>
    <option value="Izmir">İzmir</option>
    <option value="Esporcu">Esporcu</option>
    <option value="Sporcu">Sporcu</option>
    <option value="OCM">OCM (Koku Duyusu)</option>
  </select>
  <div style="margin-top:8px"><button id="toParticipationBtn" class="bigBtn">Devam</button></div>
</div>

<div id="participationCard" class="card hidden">
  <h3>Katılım Durumu</h3>
  <div id="participationOptions" class="small"></div>
  <div style="margin-top:8px"><button id="toNextStepBtn" class="bigBtn">Devam</button></div>
</div>

<div id="consentCard" class="card hidden">
  <h3>Aydınlatılmış Onam</h3>
  <div id="consentText" style="border:1px solid #ddd;padding:12px;border-radius:6px;max-height:250px;overflow:auto; background: #fff; font-size: 13px; line-height: 1.5;"></div>
  <div style="display:flex;gap:8px;margin-top:10px">
    <button id="consentAccept" class="bigBtn btnGreen">Okudum, onaylıyorum</button>
    <button id="consentDecline" class="bigBtn btnRed">Kabul etmiyorum</button>
  </div>
  <div id="consentDeclinedMsg" class="small hidden" style="margin-top:10px;color:#c0392b; font-weight: bold;">
    Katılım kabul edilmedi. Deney sonlandırıldı.
  </div>
</div>

<div id="consentModal" class="modal">
  <div class="modal-content">
    <span id="closeConsentModal" class="close">&times;</span>
    <div id="modalConsentBody" style="font-size: 13px; line-height: 1.4;"></div>
  </div>
</div>

<div id="infoCard" class="card hidden">
  <h3>Katılımcı Bilgileri</h3>
  <div class="small">Ad ve soyad için ilk 2 harf yeterli (gizlilik).</div>
  <input id="name" placeholder="Ad (ilk 2 harf)">
  <input id="surname" placeholder="Soyad (ilk 2 harf)">
  <input id="age" type="number" placeholder="Yaş">
  <input id="email" type="email" placeholder="E-posta adresiniz">
  <input id="phone" type="tel" placeholder="Telefon numaranız">
  <input id="race" placeholder="Doğum yeri / Irk">
  <input id="motherTongue" placeholder="Anadiliniz">
  <select id="gender"><option value="">Cinsiyet</option><option>Kadın</option><option>Erkek</option><option>Diğer</option></select>
  <div id="codeInfo" class="small" style="margin-top:6px;color:#2c3e50"></div>
  <div style="margin-top:8px"><button id="toNextFromInfo" class="bigBtn">Devam</button></div>
</div>

<div id="esporcuFormCard" class="card hidden">
  <h3>Esporcu Bilgi Formu</h3>
  
  <div class="question-group">
    <span class="question-title">Eğitim Durumunuz *</span>
    <label><input type="radio" name="eduStatus" value="Ortaokul"> Ortaokul</label>
    <label><input type="radio" name="eduStatus" value="Lise"> Lise</label>
    <label><input type="radio" name="eduStatus" value="Üniversite"> Üniversite</label>
    <label><input type="radio" name="eduStatus" value="Yüksek Lisans"> Yüksek Lisans</label>
    <label><input type="radio" name="eduStatus" value="Doktora"> Doktora</label>
  </div>

  <div class="question-group">
    <span class="question-title">Kaç yıldır oyun oynuyorsunuz? *</span>
    <input id="playYears" type="number" placeholder="Yanıtınız">
  </div>

  <div class="question-group">
    <span class="question-title">Günde kaç saat oyun oynuyorsunuz? *</span>
    <input id="dailyHours" type="number" placeholder="Yanıtınız">
  </div>

  <div class="question-group">
    <span class="question-title">Oyun oynadığınız platform hangisi? *</span>
    <label><input type="radio" name="platform" value="Bilgisayar"> Bilgisayar</label>
    <label><input type="radio" name="platform" value="Mobil"> Mobil</label>
    <label><input type="radio" name="platform" value="Playstation"> Playstation</label>
    <label><input type="radio" name="platform" value="Diğer"> Diğer</label>
  </div>

  <div class="question-group">
    <span class="question-title">Oynadığınız oyun türünü seçiniz *</span>
    <label><input type="radio" name="gameType" value="FPS"> FPS</label>
    <label><input type="radio" name="gameType" value="SPOR"> SPOR</label>
    <label><input type="radio" name="gameType" value="MMORPG"> MMORPG</label>
    <label><input type="radio" name="gameType" value="MOBA"> MOBA</label>
    <label><input type="radio" name="gameType" value="RPG"> RPG</label>
    <label><input type="radio" name="gameType" value="RTS"> RTS (Real Time Strategy)</label>
    <label><input type="radio" name="gameType" value="TBS"> TBS (Turn Based Strategy)</label>
    <label><input type="radio" name="gameType" value="Diğer"> Diğer</label>
  </div>

  <div class="question-group">
    <span class="question-title">Oynadığınız oyunun (en çok saat ayırdığınız) adını yazınız *</span>
    <input id="topGameName" placeholder="Yanıtınız">
  </div>

  <div class="question-group">
    <span class="question-title">En Yüksek Rütbeniz (Rank / Seviye) *</span>
    <p class="small">Oynadığınız oyun sezonlu ise en son başarılı olduğunuz sezona göre yazabilirsiniz.</p>
    <input id="topRank" placeholder="Yanıtınız">
  </div>

  <button id="toHandFromEsporcu" class="bigBtn">Devam</button>
</div>

<div id="enterCodeCard" class="card hidden">
  <h3>Önceki Katılımcı Kodu</h3>
  <input id="previousCode" placeholder="OY_AB_12345">
  <div style="margin-top:8px"><button id="toStaiDirectBtn" class="bigBtn">Devam</button></div>
</div>

<div id="handUseCard" class="card hidden">
  <h3>El Kullanımı Testi</h3>
  <p class="small">Lütfen her satır için toplam 2 kutucuk işaretlemeyi unutmayın!</p>
  <div id="handUseQuestions"></div>
  <div style="margin-top:8px"><button id="toStaiBtn" class="bigBtn">Devam</button></div>
</div>

<div id="staiCard" class="card hidden">
  <h3>STAI-TXI Formu</h3>
  <div id="staiQuestions"></div>
  <div style="margin-top:8px"><button id="toHearingBtn" class="bigBtn">Devam</button></div>
</div>

<div id="hearingCard" class="card hidden">
  <h3>İşitme Kontrolü</h3>
  <div style="margin-top:8px">
    <label><b>Sol Kulak</b></label>
    <input type="range" id="leftSlider" min="0" max="1" step="0.01" value="0.5"><button id="playLeft" class="bigBtn">Sol Oynat</button>
  </div>
  <div style="margin-top:12px">
    <label><b>Sağ Kulak</b></label>
    <input type="range" id="rightSlider" min="0" max="1" step="0.01" value="0.5"><button id="playRight" class="bigBtn">Sağ Oynat</button>
  </div>
  <div style="margin-top:12px"><button id="toSessionIntro" class="bigBtn">Devam</button></div>
</div>

<div id="sessionIntro" class="card hidden">
  <h3 id="sessionTitle"></h3>
  <p id="sessionInstr"></p>
  <div style="margin-top:8px"><button id="sessionStartBtn" class="bigBtn">Başla</button></div>
</div>

<div id="trialCard" class="card hidden">
  <div id="trialStatus" class="small"></div>
  <audio id="stimAudio" preload="auto"></audio>
  <div class="respRow">
    <button class="respBtn" data-val="BA">BA</button><button class="respBtn" data-val="DA">DA</button>
    <button class="respBtn" data-val="GA">GA</button><button class="respBtn" data-val="KA">KA</button>
    <button class="respBtn" data-val="PA">PA</button><button class="respBtn" data-val="TA">TA</button>
  </div>
</div>

<div id="endCard" class="card hidden"><h3>Deney tamamlandı ✅</h3><div id="doneLog" class="small"></div></div>

<script>
document.addEventListener('DOMContentLoaded', ()=>{

const $id = id => document.getElementById(id);
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] } return arr; }

let participant = {}, results = [], sessionOrder = [], currentSessionIndex = 0, currentTrial = -1;
/* --- ORIJINAL DEĞİŞKENLER (index-19.html'den) --- */
let audioCtx=null, leftOsc=null, rightOsc=null, leftGain=null, rightGain=null;
let isResponseAllowed=false, trialTimeout=null, responseStart=0;

/* ---------- ONAM SÖZLÜĞÜ (OCM DAHİL) ---------- */
const CONSENT_TEXTS = {
  "Sport": `
    <div style="text-align: center; font-weight: bold;">DOKUZ EYLÜL ÜNİVERSİTESİ<br>“GİRİŞİMSEL OLMAYAN KLİNİK ARAŞTIRMALAR” İÇİN BİLGİLENDİRİLMİŞ GÖNÜLLÜ OLUR FORMU</div>
    <br><p><b>Araştırmanın Adı:</b> Basketbolcu ve Elektronik Sporcularda İşitsel Dikkat ve Beyin Asimetrisinin Değerlendirilmesi</p>
    <p><b>Sorumlu:</b> Dr. Öğr. Üyesi Emre Eskicioğlu. <b>Yardımcılar:</b> Doç. Dr. Egemen MANCI, Doç. Dr. Çağdaş Güdücü</p>
    <hr><p>Bu çalışma geleneksel sporcular ile esporcuların beyin asimetrisini incelemeyi amaçlar. Katılım gönüllüdür.</p>
    <p><b>BEYAN:</b> Dr. Öğr. Üyesi Emre Eskicioğlu tarafından bilgilendirildim. 0555 740 0187 numaralı telefondan ulaşabileceğimi biliyorum. [cite_start]Gönüllülük içerisinde katılmayı kabul ediyorum[cite: 1].</p>
  `,
  "OCM": `
    <div style="text-align: center; font-weight: bold;">DOKUZ EYLÜL ÜNİVERSİTESİ<br>"GİRİŞİMSEL OLMAYAN KLİNİK ARAŞTIRMALAR" İÇİN BİLGİLENDİRİLMİŞ GÖNÜLLÜ OLUR FORMU</div>
    <br><p><b>Araştırmanın Adı:</b> Koku Duyusunun İşitsel Beyin Asimetrisi Üzerine Etkisinin Değerlendirilmesi</p>
    <p><b>Sorumlu Araştırıcı:</b> Emre Eskicioğlu</p>
    <p><b>Yardımcı Araştırmacılar:</b> Abdullah Suat Kavun, Beril Demirbilek, Neziha Burçin Tokgöz</p>
    <hr>
    <p>Bu araştırma, koku alma duyusu ile beynin işitsel bölgeleri arasındaki asimetrik aktivite ilişkisini değerlendirmeyi amaçlar. Toplam 30 sağlıklı gönüllü katılacaktır.</p>
    <p><b>Süreç:</b> İlk olarak dikotik dinleme testi uygulanacaktır. Ardından size dört farklı kokudan (gül, karanfil, limon ve okaliptüs) oluşan koku çubukları verilecektir. Sizden bu kokuları 12 hafta boyunca, günde iki kez koklamanız istenecektir. Süreç sonunda test yeniden yapılacaktır.</p>
    <p><b>Riskler:</b> Düşük risk grubundadır. Çok nadir durumlarda koku hassasiyeti veya alerjik reaksiyon görülebilir.</p>
    <p><b>BEYAN:</b> Tıbbi bir araştırma yapılacağı belirtilerek bilgiler bana aktarıldı. Herhangi bir sağlık sorununda 0555 740 01 87'den araştırmacıya ulaşabileceğimi biliyorum. [cite_start]Kendi rızamla katılmayı kabul ediyorum [cite: 76-147].</p>
  `,
  "OykuTez": `<h3>WEB Tabanlı Türkçe Dikotik Dinleme Testi Güvenirliği</h3><p>Uygulama süreci 2 hafta planlanmaktadır.</p>`,
  "Default": `<h3>Aydınlatılmış Onam</h3><p>Bu çalışma işitsel algı süreçlerini incelemeyi amaçlar. Katılım gönüllüdür.</p>`
};
CONSENT_TEXTS["Sporcu"] = CONSENT_TEXTS["Sport"];
CONSENT_TEXTS["Esporcu"] = CONSENT_TEXTS["Sport"];
CONSENT_TEXTS["Izmir"] = CONSENT_TEXTS["Default"];

/* ---------- FLOW MANTIĞI ---------- */
$id('toParticipationBtn').onclick = ()=>{
  const proj = $id('projectCode').value;
  if(!proj){ alert('Proje kodu seçiniz.'); return; }
  participant.projectCode = proj;
  $id('projectCard').classList.add('hidden'); $id('participationCard').classList.remove('hidden');
  renderParticipationOptions(proj);
};

function renderParticipationOptions(project){
  const el = $id('participationOptions'); el.innerHTML = '';
  const needsSecond = (project === 'OykuTez' || project === 'OCM');
  el.innerHTML = `<label><input type="radio" name="participation" value="1"> İlk kez katılıyorum</label>
    <label><input type="radio" name="participation" value="2"> Bir kez katıldım ama tamamlayamadım</label>` +
    (needsSecond ? `<label><input type="radio" name="participation" value="3"> İkinci kez katılıyorum</label>` : '');
}

$id('toNextStepBtn').onclick = ()=>{
  const sel = document.querySelector('input[name="participation"]:checked');
  if(!sel){ alert('Seçenek seçiniz.'); return; }
  participant.participation = sel.value;
  $id('participationCard').classList.add('hidden');
  if(sel.value === '1'){
    const txt = CONSENT_TEXTS[participant.projectCode] || CONSENT_TEXTS["Default"];
    $id('consentText').innerHTML = txt; $id('modalConsentBody').innerHTML = txt;
    $id('consentCard').classList.remove('hidden');
  } else { $id('enterCodeCard').classList.remove('hidden'); }
};

$id('consentAccept').onclick = ()=>{ $id('consentCard').classList.add('hidden'); $id('infoCard').classList.remove('hidden'); };
$id('consentDecline').onclick = ()=>{ $id('consentDeclinedMsg').classList.remove('hidden'); $id('consentAccept').disabled = true; };

/* --- ONAM MODAL KONTROLÜ --- */
$id('consentText').insertAdjacentHTML('beforebegin', '<button id="openConsentPopup" class="bigBtn" style="margin-bottom:10px; width: 100%;">Onam Formunu Tam Ekran Görüntüle</button>');
$id('openConsentPopup').onclick=()=>{ $id('consentModal').style.display='block'; };
$id('closeConsentModal').onclick=()=>{ $id('consentModal').style.display='none'; };
window.onclick=e=>{ if(e.target==$id('consentModal')) $id('consentModal').style.display='none'; };

/* --- KATILIMCI BİLGİLERİ -> ESPORCU FORMU VEYA EL KULLANIMI --- */
$id('toNextFromInfo').onclick = ()=>{
  const n = $id('name').value.trim(), s = $id('surname').value.trim(), a = $id('age').value.trim();
  if(!n || !s || !a){ alert('Ad, Soyad ve Yaş zorunludur.'); return; }
  participant.name = n.slice(0,2); participant.surname = s.slice(0,2); participant.age = a;
  participant.email = $id('email').value; participant.phone = $id('phone').value;
  participant.race = $id('race').value; participant.motherTongue = $id('motherTongue').value; participant.gender = $id('gender').value;
  
  participant.code = participant.projectCode + '_' + (n+s).toUpperCase().slice(0,4).padEnd(4,'X') + '_' + Math.floor(10000+Math.random()*90000);
  $id('codeInfo').innerText = 'Kod: ' + participant.code;
  $id('infoCard').classList.add('hidden');

  if(participant.projectCode === 'Esporcu') {
    $id('esporcuFormCard').classList.remove('hidden');
  } else {
    renderHand(); $id('handUseCard').classList.remove('hidden');
  }
};

/* --- ESPORCU FORMU VERİ TOPLAMA --- */
$id('toHandFromEsporcu').onclick = ()=>{
  const edu = document.querySelector('input[name="eduStatus"]:checked');
  const plat = document.querySelector('input[name="platform"]:checked');
  const type = document.querySelector('input[name="gameType"]:checked');
  const years = $id('playYears').value;
  const hours = $id('dailyHours').value;
  const game = $id('topGameName').value;
  const rank = $id('topRank').value;

  if(!edu || !plat || !type || !years || !hours || !game || !rank){ alert('Lütfen tüm yıldızlı alanları doldurunuz.'); return; }

  participant.esporData = { education: edu.value, platform: plat.value, genre: type.value, yearsPlaying: years, dailyHours: hours, topGame: game, highestRank: rank };
  
  $id('esporcuFormCard').classList.add('hidden');
  renderHand(); $id('handUseCard').classList.remove('hidden');
};

/* --- EL KULLANIMI --- */
function renderHand(){
  const c = $id('handUseQuestions'); c.innerHTML = '<div class="hand-grid-header"><span></span><div class="col">Sol</div><div class="col">Sağ</div></div>';
  ["Yazmak","Çizmek","Taş Atmak","Makas","Fırça","Bıçak","Kaşık","Süpürge","Kibrit","Kapak"].forEach((q,i)=>{
    c.innerHTML += `<div class="hand-grid-row"><span>${q}</span><div class="col"><input type="checkbox" class="left"><input type="checkbox" class="left"></div><div class="col"><input type="checkbox" class="right"><input type="checkbox" class="right"></div></div>`;
  });
}

$id('toStaiBtn').onclick = ()=>{
  const rows = document.querySelectorAll('#handUseQuestions .hand-grid-row');
  for(const r of rows) if(r.querySelectorAll('input:checked').length !== 2){ alert('Her satıra 2 işaret!'); return; }
  participant.handUse = Array.from(rows).map((r,i)=>({q:i+1, left:r.querySelectorAll('.left:checked').length, right:r.querySelectorAll('.right:checked').length}));
  $id('handUseCard').classList.add('hidden'); renderStai(); $id('staiCard').classList.remove('hidden');
};

/* --- STAI FORMU (ORİJİNAL SORU/YANIT YAPISI) --- */
function renderStai(){
  const c = $id('staiQuestions'); c.innerHTML = '';
  const staiQuestions = ["Şu anda sakinim","Kendimi emniyette hissediyorum","Şu anda sinirlerim gergin","Pişmanlık duygusu içindeyim","Şu anda huzur içindeyim","Şu anda hiç keyfim yok","Başıma geleceklerden endişe ediyorum","Kendimi dinlenmiş hissediyorum","Şu anda kaygılıyım","Kendimi rahat hissediyorum","Kendime güvenim var","Şu anda asabım bozuk","Çok sinirliyim","Sinirlerimin çok gergin olduğunu hissediyorum","Kendimi rahatlamış hissediyorum","Şu anda halimden memnunum","Şu anda endişeliyim","Heyecandan kendimi şaşkına dönmüş hissediyorum","Şu anda sevinçliyim","Şu anda keyfim yerinde"];
  
  staiQuestions.forEach((q,i)=>{
    c.innerHTML += `<div class="question-group"><p>${i+1}. ${q}</p>
      <div class="stai-options">
        <label><input type="radio" name="staiQ${i+1}" value="1">Hiç</label>
        <label><input type="radio" name="staiQ${i+1}" value="2">Biraz</label>
        <label><input type="radio" name="staiQ${i+1}" value="3">Çok</label>
        <label><input type="radio" name="staiQ${i+1}" value="4">Tamamıyla</label>
      </div></div>`;
  });
}

$id('toHearingBtn').onclick = async ()=>{
  if(document.querySelectorAll('#staiQuestions input:checked').length < 20){ alert('Tüm soruları yanıtlayın.'); return; }
  // AudioContext RESUME (Zorunlu, yoksa takılır)
  ensureCtx(); if(audioCtx.state === 'suspended') await audioCtx.resume();
  
  participant.staiAnswers = {};
  document.querySelectorAll('#staiQuestions input:checked').forEach(i=> participant.staiAnswers[i.name]=i.value);
  $id('staiCard').classList.add('hidden'); $id('hearingCard').classList.remove('hidden');
};

/* --- SES MANTIĞI (index-19.html BİREBİR KOPYASI) --- */
function ensureCtx(){ if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
function stopLeft(){ try{ if(leftOsc) leftOsc.stop(); }catch(e){} leftOsc=null; leftGain=null; }
function stopRight(){ try{ if(rightOsc) rightOsc.stop(); }catch(e){} rightOsc=null; rightGain=null; }

async function startLeft(){
  ensureCtx(); stopRight(); stopLeft();
  if (audioCtx.state === 'suspended') await audioCtx.resume();
  
  leftOsc = audioCtx.createOscillator(); 
  leftGain = audioCtx.createGain();
  const panner = audioCtx.createStereoPanner(); 
  panner.pan.value = -1;

  leftOsc.frequency.value = 1500; 
  leftGain.gain.value = Number($id('leftSlider').value);

  leftOsc.connect(leftGain);
  leftGain.connect(panner); 
  panner.connect(audioCtx.destination); 

  leftOsc.start();
}

async function startRight(){
  ensureCtx(); stopLeft(); stopRight();
  if (audioCtx.state === 'suspended') await audioCtx.resume();
  
  rightOsc = audioCtx.createOscillator(); 
  rightGain = audioCtx.createGain();
  const panner = audioCtx.createStereoPanner(); 
  panner.pan.value = 1;

  rightOsc.frequency.value = 1500; 
  rightGain.gain.value = Number($id('rightSlider').value);

  rightOsc.connect(rightGain);
  rightGain.connect(panner); 
  panner.connect(audioCtx.destination); 

  rightOsc.start();
}

/* BUTONLARIN GLOBAL TOGGLE MANTIĞI */
$id('playLeft').onclick = ()=>{ if(leftOsc) stopLeft(); else startLeft(); setTimeout(()=>stopLeft(),1200); };
$id('playRight').onclick = ()=>{ if(rightOsc) stopRight(); else startRight(); setTimeout(()=>stopRight(),1200); };

$id('toSessionIntro').onclick = async ()=>{
  ensureCtx(); if(audioCtx.state === 'suspended') await audioCtx.resume();
  stopLeft(); stopRight();
  
  participant.leftLevel = $id('leftSlider').value; participant.rightLevel = $id('rightSlider').value;
  results.push({ session: 'hearing_level', trial: 0, stim: '1500Hz', response: '', responseTime: '', leftLevel: participant.leftLevel, rightLevel: participant.rightLevel });
  
  sessionOrder = ['training','NF', ...shuffle(['FR','FL'])];
  $id('hearingCard').classList.add('hidden'); showSessionIntro();
};

function showSessionIntro(){
  const s = sessionOrder[currentSessionIndex];
  $id('sessionTitle').innerText = 'Oturum: ' + s;
  const i = {training:'Eğitim: Sadece dinleyin.', NF:'En iyi duyduğunuzu seçin.', FR:'SAĞ kulağa odaklanın.', FL:'SOL kulağa odaklanın.'};
  $id('sessionInstr').innerText = i[s];
  $id('sessionIntro').classList.remove('hidden');
}

$id('sessionStartBtn').onclick = async ()=>{
  ensureCtx(); if(audioCtx.state === 'suspended') await audioCtx.resume();
  $id('sessionIntro').classList.add('hidden');
  try{ const a = $id('stimAudio'); a.src=''; await a.play().catch(()=>{}); }catch(e){}
  setTimeout(()=> { currentTrial = -1; $id('trialCard').classList.remove('hidden'); nextTrial(); }, 200);
};

/* --- TRIAL LOOP --- */
const trainingPlaylist = ["LBA-RBA.wav","LDA-RDA.wav","LGA-RGA.wav","LKA-RKA.wav","LPA-RPA.wav","LTA-RTA.wav","LBA-RDA.wav","LDA-RGA.wav","LGA-RKA.wav","LKA-RTA.wav"];
const mainPlaylist = ["LBA-RKA.wav","LDA-RGA.wav","LPA-RBA.wav","LKA-RDA.wav","LBA-RBA.wav","LTA-RGA.wav","LBA-RDA.wav","LGA-RPA.wav","LDA-RKA.wav","LPA-RTA.wav","LKA-RKA.wav","LBA-RGA.wav","LKA-RPA.wav","LTA-RDA.wav","LGA-RKA.wav","LPA-RDA.wav","LGA-RGA.wav","LBA-RTA.wav","LGA-RDA.wav","LKA-RTA.wav","LDA-RPA.wav","LTA-RKA.wav","LPA-RPA.wav","LDA-RBA.wav","LGA-RTA.wav","LPA-RKA.wav","LTA-RBA.wav","LKA-RGA.wav","LTA-RTA.wav","LBA-RPA.wav","LDA-RTA.wav","LGA-RBA.wav","LTA-RPA.wav","LDA-RDA.wav","LKA-RBA.wav","LPA-RGA.wav"];

function nextTrial(){
  clearTimeout(trialTimeout);
  const list = (sessionOrder[currentSessionIndex]==='training') ? trainingPlaylist : mainPlaylist;
  currentTrial++;
  if(currentTrial >= list.length){
    $id('trialCard').classList.add('hidden'); currentSessionIndex++;
    if(currentSessionIndex < sessionOrder.length) showSessionIntro(); else endExperiment();
    return;
  }
  playStim(list[currentTrial]);
}

async function playStim(stim){
  isResponseAllowed = false;
  $id('stimAudio').src = './sounds/yeni/erkek/' + stim;
  try {
    await $id('stimAudio').play();
    responseStart = Date.now();
    setTimeout(()=> isResponseAllowed = true, 500);
    trialTimeout = setTimeout(()=>{ if(sessionOrder[currentSessionIndex]!=='training') saveTrial(stim, 'no_response', 4000); nextTrial(); }, 4000);
  } catch(e){ nextTrial(); }
}

function saveTrial(stim, resp, rt){
  results.push({session: sessionOrder[currentSessionIndex], trial: currentTrial+1, stim, response: resp, responseTime: rt, code: participant.code, 
    leftLevel: participant.leftLevel, rightLevel: participant.rightLevel, age: participant.age, gender: participant.gender, 
    race: participant.race, motherTongue: participant.motherTongue, handUseAnswers: JSON.stringify(participant.handUse), 
    staiAnswers: JSON.stringify(participant.staiAnswers)});
}

document.querySelectorAll('.respBtn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    if(!isResponseAllowed) return;
    isResponseAllowed = false; clearTimeout(trialTimeout);
    const rt = Date.now() - responseStart;
    if(sessionOrder[currentSessionIndex]!=='training') saveTrial((sessionOrder[currentSessionIndex]==='training'?trainingPlaylist:mainPlaylist)[currentTrial], btn.dataset.val, rt, rt);
    
    // BUTON ANİMASYON DÜZELTMESİ (AYRI TIMEOUT)
    btn.classList.add('respBtn-active');
    setTimeout(()=> btn.classList.remove('respBtn-active'), 300); // Sadece rengi 300ms sonra geri al
    setTimeout(()=> nextTrial(), 2500); // Deneme geçişini 2500ms sonra yap
  });
});

/* --- BİTİŞ & CSV --- */
function makeCsv(){
  let csv = 'KATILIMCI BİLGİLERİ\nKod,Proje,Yaş,Cinsiyet,Eposta,Telefon,Anadil,SolLvl,SağLvl\n';
  csv += `${participant.code},${participant.projectCode},${participant.age},${participant.gender},${participant.email},${participant.phone},${participant.motherTongue},${participant.leftLevel},${participant.rightLevel}\n\n`;
  if(participant.esporData) csv += 'ESPORCU VERİLERİ\n' + JSON.stringify(participant.esporData) + '\n\n';
  csv += 'EL KULLANIMI\n' + JSON.stringify(participant.handUse) + '\n\nSTAI YANITLARI\n' + JSON.stringify(participant.staiAnswers) + '\n\n';
  csv += 'DİKOTİK SONUÇLAR\nSession,Trial,Stimulus,Response,ResponseTime\n';
  results.forEach(r=>{ csv += `${r.session},${r.trial},${r.stim},${r.response},${r.responseTime}\n`; });
  return csv;
}

async function sendEmail(){
  const csv = makeCsv();
  try{
    if(!window.emailjs){
      const s = document.createElement('script'); s.src = 'https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js';
      await new Promise(res=>{ s.onload = res; });
      emailjs.init($id('emailjs-user').content);
    }
    await emailjs.send($id('emailjs-service').content, $id('emailjs-template').content, { subject: participant.code, message: csv });
    $id('doneLog').innerText = 'Veriler başarıyla gönderildi.';
  }catch(e){ $id('doneLog').innerText = 'E-posta gönderilemedi.'; }
}

async function endExperiment(){ $id('trialCard').classList.add('hidden'); $id('endCard').classList.remove('hidden'); await sendEmail(); }

document.addEventListener('click', function initAudioContext() {
    ensureCtx();
    if (audioCtx && audioCtx.state === 'suspended') { audioCtx.resume().catch(e => console.error(e)); }
    document.removeEventListener('click', initAudioContext);
}, {once: true});

});
</script>
</body>
</html>
