<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dikotik Dinleme — Sabit Akış</title>

<meta name="emailjs-user"    content="FLn2zMqKDGso3ePoO">
<meta name="emailjs-service" content="service_a8bnfmk">
<meta name="emailjs-template"content="template_7elc4wi">

<style>
  :root{--maxw:360px}
  body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:12px;color:#111;max-width:var(--maxw);margin-left:auto;margin-right:auto}
  h1{font-size:20px;margin-bottom:8px}
  .card{padding:12px;border:1px solid #ddd;border-radius:8px;margin-bottom:12px}
  .hidden{display:none}
  input,select{padding:8px;margin:6px 0;width:100%;box-sizing:border-box}
  .bigBtn{font-size:1.05rem;padding:10px 14px;border-radius:8px;border:1px solid #444;background:#eaeaea;cursor:pointer}
  .respRow{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:8px}
  .respBtn{padding:12px 18px;border-radius:8px;border:1px solid #444;background:#f2f2f2;cursor:pointer;min-width:90px}
  .respBtn-active{background:#bdbdbd}
  .stai-options{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
  .hand-grid-header{display:flex;justify-content:space-between;margin-bottom:6px;font-weight:600}
  .hand-grid-row{display:flex;align-items:center;justify-content:space-between;border-top:1px solid #eee;padding:6px 0}
  .hand-grid-row span{flex:2}
  .hand-grid-row .col{flex:1;display:flex;justify-content:center;gap:8px}
  .small{font-size:13px;color:#666}
  .question-group{margin-bottom:10px}
</style>
</head>
<body>
<h1>Dikotik Dinleme İzmir</h1>

<!-- 1) Katılımcı Bilgileri (ilk ekranda) -->
<div id="participantCard" class="card">
  <h3>Katılımcı Bilgileri</h3>
  <div class="small">Ad ve soyad için ilk 2 harf yeterli (gizlilik amacıyla).</div>
  <input id="name" placeholder="Ad (ilk 2 harf)">
  <input id="surname" placeholder="Soyad (ilk 2 harf)">
  <input id="age" type="number" placeholder="Yaş">
  <input id="race" placeholder="Doğum yeri / Irk">
  <input id="motherTongue" placeholder="Anadiliniz">
  <input id="email" type="email" placeholder="E-posta (opsiyonel)">
  <select id="gender">
    <option value="">Cinsiyetinizi seçiniz</option>
    <option value="Kadın">Kadın</option>
    <option value="Erkek">Erkek</option>
    <option value="Diğer">Diğer</option>
  </select>
  <select id="projectCode">
    <option value="">Proje Kodu Seçin</option>
    <option value="OykuTez">OykuTez</option>
    <option value="Izmir">Izmir</option>
    <option value="Esporcu">Esporcu</option>
    <option value="Sporcu">Sporcu</option>
  </select>
  <div style="margin-top:8px"><button id="toParticipationBtn" class="bigBtn">Devam</button></div>
  <div id="codeInfo" class="small" style="margin-top:8px"></div>
</div>

<!-- 2) Ön Sorgulama / Katılım Durumu -->
<div id="participationCard" class="card hidden">
  <h3>Ön Sorgulama / Katılım Durumu</h3>
  <div id="participationOptions" class="small"></div>
  <div style="margin-top:8px"><button id="toNextStepBtn" class="bigBtn">Devam</button></div>
</div>

<!-- 3) Onam (sadece ilk kez için) -->
<div id="consentCard" class="card hidden">
  <h3>Aydınlatılmış Onam</h3>
  <div id="consentText" contenteditable="true">
    <p>Bu çalışma işitsel algı ve dikkat süreçlerini incelemeyi amaçlamaktadır. Katılım gönüllülük esasına dayanmaktadır ve veriler anonim saklanacaktır.</p>
  </div>
  <label style="display:flex;gap:8px;align-items:center"><input type="checkbox" id="consentAgree"> Okudum ve onaylıyorum</label>
  <div style="margin-top:8px">
    <button id="backToInfoBtn" class="bigBtn">Geri</button>
    <button id="toHandBtnFromConsent" class="bigBtn">Devam</button>
  </div>
</div>

<!-- 4) Eski katılımcılar için kod girişi -->
<div id="enterCodeCard" class="card hidden">
  <h3>Önceki Katılımcı Kodu</h3>
  <div class="small">Daha önce katıldıysanız, lütfen katılımcı kodunuzu girin (el-tercihi ve dil bilgileri ile birleştirmek için).</div>
  <input id="previousCode" placeholder="Örnek: IZ_AB_12345">
  <div style="margin-top:8px"><button id="toStaiDirectBtn" class="bigBtn">Devam</button></div>
</div>

<!-- 5) El Kullanımı (STAI'dan ÖNCE) -->
<div id="handUseCard" class="card hidden">
  <h3>El Kullanımı Testi</h3>
  <p class="small">Her işlem için kullandığınız el(ler)i işaretleyin. (Her satır için tam 2 kutucuk olması beklenir.)</p>
  <div id="handUseQuestions"></div>
  <div style="margin-top:8px"><button id="toStaiBtn" class="bigBtn">Devam</button></div>
</div>

<!-- 6) STAI (20 soru) -->
<div id="staiCard" class="card hidden">
  <h3>STAI-TXI Formu</h3>
  <div id="staiQuestions"></div>
  <div style="margin-top:8px"><button id="toHearingBtn" class="bigBtn">Devam</button></div>
</div>

<!-- 7) İşitme Kontrolü (sol/sağ ayrı) -->
<div id="hearingCard" class="card hidden">
  <h3>İşitme Kontrolü</h3>
  <p class="small">Her iki kulak için 1500 Hz tonunu test edin. Birini çalarken diğeri sessize alınır.</p>

  <div>
    <label><b>Sol Kulak</b></label>
    <input type="range" id="leftSlider" min="0" max="1" step="0.01" value="0.5">
    <button id="playLeftTone" class="bigBtn">Sol Ses Testi</button>
  </div>

  <div style="margin-top:10px">
    <label><b>Sağ Kulak</b></label>
    <input type="range" id="rightSlider" min="0" max="1" step="0.01" value="0.5">
    <button id="playRightTone" class="bigBtn">Sağ Ses Testi</button>
  </div>

  <div style="margin-top:12px"><button id="toSessionIntro" class="bigBtn">Devam</button></div>
</div>

<!-- 8) Oturum Tanıtımı -->
<div id="sessionIntro" class="card hidden">
  <h3 id="sessionTitle"></h3>
  <p id="sessionInstr"></p>
  <div style="margin-top:8px"><button id="sessionStartBtn" class="bigBtn">Başla</button></div>
</div>

<!-- 9) Deneme -->
<div id="trialCard" class="card hidden">
  <div id="trialStatus" class="small" style="margin-bottom:8px"></div>
  <audio id="stimAudio" preload="auto"></audio>
  <div class="respRow">
    <button class="respBtn" data-val="BA">BA</button>
    <button class="respBtn" data-val="DA">DA</button>
    <button class="respBtn" data-val="GA">GA</button>
    <button class="respBtn" data-val="KA">KA</button>
    <button class="respBtn" data-val="PA">PA</button>
    <button class="respBtn" data-val="TA">TA</button>
  </div>
</div>

<!-- 10) Bitiş -->
<div id="endCard" class="card hidden">
  <h3>Deney tamamlandı ✅</h3>
  <div id="doneLog" class="small"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', ()=>{

  /* ---------- helpers & state ---------- */
  const $id = id => document.getElementById(id);
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }

  let participant = {}, results = [], sessionOrder = [], currentSessionIndex = 0, currentTrial = -1;
  let audioCtx=null,leftOsc=null,rightOsc=null,leftGain=null,rightGain=null;
  let isResponseAllowed=false, trialTimeout=null;

  /* ---------- Render STAI and Hand Use ---------- */
  const staiQuestions = [
    "Şu anda sakinim","Kendimi emniyette hissediyorum","Şu anda sinirlerim gergin",
    "Pişmanlık duygusu içindeyim","Şu anda huzur içindeyim","Şu anda hiç keyfim yok",
    "Başıma geleceklerden endişe ediyorum","Kendimi dinlenmiş hissediyorum","Şu anda kaygılıyım",
    "Kendimi rahat hissediyorum","Kendime güvenim var","Şu anda asabım bozuk","Çok sinirliyim",
    "Sinirlerimin çok gergin olduğunu hissediyorum","Kendimi rahatlamış hissediyorum",
    "Şu anda halimden memnunum","Şu anda endişeliyim","Heyecandan kendimi şaşkına dönmüş hissediyorum",
    "Şu anda sevinçliyim","Şu anda keyfim yerinde"
  ];

  function renderStai(){
    const c = $id('staiQuestions'); c.innerHTML = '';
    staiQuestions.forEach((q,i)=>{
      c.innerHTML += `<div class="question-group">
        <p>${i+1}. ${q}</p>
        <div class="stai-options">
          <label><input type="radio" name="staiQ${i+1}" value="1">Hiç</label>
          <label><input type="radio" name="staiQ${i+1}" value="2">Biraz</label>
          <label><input type="radio" name="staiQ${i+1}" value="3">Çok</label>
          <label><input type="radio" name="staiQ${i+1}" value="4">Tamamıyla</label>
        </div>
      </div>`;
    });
  }

  function renderHand(){
    const questions = ["Yazmak","Çizmek","Taş Atmak","Makas kullanmak","Diş fırçası kullanmak","Bıçak kullanmak","Kaşık kullanmak","Süpürge (üst el)","Kibrit çakmak","Kutunun kapağını açmak"];
    const c = $id('handUseQuestions'); c.innerHTML = `<div class="hand-grid-header"><div style="flex:2"></div><div style="flex:1;text-align:center">Sol</div><div style="flex:1;text-align:center">Sağ</div></div>`;
    questions.forEach((q,i)=>{
      c.innerHTML += `<div class="hand-grid-row" data-q="${i+1}"><span>${i+1}. ${q}</span>
        <div class="col"><input type="checkbox" class="left"><input type="checkbox" class="left"></div>
        <div class="col"><input type="checkbox" class="right"><input type="checkbox" class="right"></div>
      </div>`;
    });
  }

  /* ---------- Navigation handlers (preserve flow) ---------- */

  // From initial participant card -> participation options
  $id('toParticipationBtn').onclick = ()=>{
    const n = $id('name').value.trim(), s = $id('surname').value.trim(), a = $id('age').value.trim(), p = $id('projectCode').value;
    if(!n || !s || !a || !p){ alert('Lütfen ad (ilk 2), soyad (ilk 2), yaş ve proje kodunu doldurun.'); return; }
    participant.name = n.slice(0,2);
    participant.surname = s.slice(0,2);
    participant.age = a;
    participant.race = $id('race').value.trim();
    participant.motherTongue = $id('motherTongue').value.trim();
    participant.email = $id('email').value.trim();
    participant.gender = $id('gender').value;
    participant.projectCode = p;
    // hide current, show participation
    $id('participantCard').classList.add('hidden');
    $id('participationCard').classList.remove('hidden');
    renderParticipationOptions(p);
  };

  function renderParticipationOptions(project){
    const el = $id('participationOptions'); el.innerHTML = '';
    if(project === 'OykuTez'){
      el.innerHTML = `
        <label><input type="radio" name="participation" value="1"> İlk kez katılıyorum</label><br>
        <label><input type="radio" name="participation" value="2"> Bir kez katıldım ama tamamlayamadım</label><br>
        <label><input type="radio" name="participation" value="3"> İkinci kez katılıyorum</label><br>
        <label><input type="radio" name="participation" value="4"> İki kez katıldım ancak tamamlayamadım</label>
      `;
    } else {
      el.innerHTML = `
        <label><input type="radio" name="participation" value="1"> İlk kez katılıyorum</label><br>
        <label><input type="radio" name="participation" value="2"> Bir kez katıldım ama tamamlayamadım</label>
      `;
    }
  }

  $id('toNextStepBtn').onclick = ()=>{
    const sel = document.querySelector('input[name="participation"]:checked');
    if(!sel){ alert('Lütfen bir seçenek seçiniz.'); return; }
    const v = sel.value;
    if(v === '1'){ // first time
      $id('participationCard').classList.add('hidden');
      $id('consentCard').classList.remove('hidden');
    } else { // returning
      $id('participationCard').classList.add('hidden');
      $id('enterCodeCard').classList.remove('hidden');
    }
  };

  /* Consent */
  $id('backToInfoBtn').onclick = ()=>{ $id('consentCard').classList.add('hidden'); $id('participantCard').classList.remove('hidden'); };
  $id('toHandBtnFromConsent').onclick = ()=>{
    if(!$id('consentAgree').checked){ alert('Lütfen onam kutusunu onaylayınız.'); return; }
    $id('consentCard').classList.add('hidden');
    $id('handUseCard').classList.remove('hidden');
    renderHand();
  };

  /* If returning participant enters code */
  $id('toStaiDirectBtn').onclick = ()=>{
    const code = $id('previousCode').value.trim();
    if(!code){ alert('Lütfen katılımcı kodunu giriniz.'); return; }
    participant.code = code;
    // try to prefill handUse/motherTongue from localStorage (best-effort)
    try{
      const raw = localStorage.getItem('participant.' + code);
      if(raw){ const saved = JSON.parse(raw); participant = {...participant, ...saved}; }
    }catch(e){ console.warn(e); }
    $id('enterCodeCard').classList.add('hidden');
    renderStai();
    $id('staiCard').classList.remove('hidden');
  };

  /* Hand use -> STAI */
  $id('toStaiBtn').onclick = ()=>{
    // validate each row has exactly 2 checked (as your original required)
    const rows = document.querySelectorAll('#handUseQuestions .hand-grid-row');
    for(const r of rows){
      if(r.querySelectorAll('input:checked').length !== 2){ alert('Her işlem için tam olarak 2 kutucuk işaretleyiniz.'); return; }
    }
    // collect
    participant.handUse = Array.from(rows).map(r=>({
      q: r.dataset.q,
      left: r.querySelectorAll('.left:checked').length,
      right: r.querySelectorAll('.right:checked').length
    }));
    // store summary locally so returning sessions can be merged
    try{ if(participant.code) localStorage.setItem('participant.'+participant.code, JSON.stringify({ projectCode: participant.projectCode, handUse: participant.handUse, motherTongue: participant.motherTongue || '', race: participant.race || '' })); }catch(e){console.warn(e);}
    $id('handUseCard').classList.add('hidden');
    renderStai();
    $id('staiCard').classList.remove('hidden');
  };

  /* STAI -> Hearing */
  function renderStai(){ const c = $id('staiQuestions'); c.innerHTML=''; staiQuestions.forEach((q,i)=>{ c.innerHTML += `<div class="question-group"><p>${i+1}. ${q}</p><div class="stai-options"><label><input type="radio" name="staiQ${i+1}" value="1">Hiç</label><label><input type="radio" name="staiQ${i+1}" value="2">Biraz</label><label><input type="radio" name="staiQ${i+1}" value="3">Çok</label><label><input type="radio" name="staiQ${i+1}" value="4">Tamamıyla</label></div></div>`; }); }
  $id('toHearingBtn').onclick = ()=>{
    const answered = document.querySelectorAll('#staiQuestions input:checked').length;
    if(answered < staiQuestions.length){ alert('Lütfen tüm STAI sorularını yanıtlayınız.'); return; }
    // collect
    const ans = {};
    document.querySelectorAll('#staiQuestions input:checked').forEach(i=> ans[i.name] = i.value);
    participant.staiAnswers = ans;
    $id('staiCard').classList.add('hidden');
    $id('hearingCard').classList.remove('hidden');
  };

  /* ---------- Hearing: two ear logic ---------- */
  function ensureCtx(){ if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
  function stopLeft(){ try{ if(leftOsc) leftOsc.stop(); }catch(e){} leftOsc=null; leftGain=null; }
  function stopRight(){ try{ if(rightOsc) rightOsc.stop(); }catch(e){} rightOsc=null; rightGain=null; }

  function startLeft(){
    ensureCtx(); stopRight(); stopLeft();
    leftOsc = audioCtx.createOscillator(); leftGain = audioCtx.createGain();
    leftOsc.frequency.value = 1500; leftGain.gain.value = Number($id('leftSlider').value);
    const m = audioCtx.createChannelMerger(2);
    leftOsc.connect(leftGain); leftGain.connect(m,0,0); m.connect(audioCtx.destination);
    leftOsc.start();
  }
  function startRight(){
    ensureCtx(); stopLeft(); stopRight();
    rightOsc = audioCtx.createOscillator(); rightGain = audioCtx.createGain();
    rightOsc.frequency.value = 1500; rightGain.gain.value = Number($id('rightSlider').value);
    const m = audioCtx.createChannelMerger(2);
    rightOsc.connect(rightGain); rightGain.connect(m,0,1); m.connect(audioCtx.destination);
    rightOsc.start();
  }

  $id('playLeftTone').onclick = ()=>{ if(leftOsc) stopLeft(); else startLeft(); setTimeout(()=>stopLeft(),1200); };
  $id('playRightTone').onclick = ()=>{ if(rightOsc) stopRight(); else startRight(); setTimeout(()=>stopRight(),1200); };

  /* Hearing -> sessions */
  $id('toSessionIntro').onclick = ()=>{
    stopLeft(); stopRight();
    participant.leftLevel = $id('leftSlider').value;
    participant.rightLevel = $id('rightSlider').value;
    results.push({ session: 'hearing_level', stim: '1500Hz', leftLevel: participant.leftLevel, rightLevel: participant.rightLevel, code: participant.code || '' });
    $id('hearingCard').classList.add('hidden');
    // sessionOrder: training, NF, FR/FL randomized
    sessionOrder = ['training','NF', ...shuffle(['FR','FL'])];
    currentSessionIndex = 0;
    showSessionIntro();
  };

  /* ---------- session intro & start ---------- */
  const trainingPlaylist = [ "LBA-RBA.wav","LDA-RDA.wav","LGA-RGA.wav","LKA-RKA.wav","LPA-RPA.wav","LTA-RTA.wav","LBA-RDA.wav","LDA-RGA.wav","LGA-RKA.wav","LKA-RTA.wav" ];
  const mainPlaylist = [ "LBA-RKA.wav","LDA-RGA.wav","LPA-RBA.wav","LKA-RDA.wav","LBA-RBA.wav","LTA-RGA.wav","LBA-RDA.wav","LGA-RPA.wav","LDA-RKA.wav","LPA-RTA.wav","LKA-RKA.wav","LBA-RGA.wav","LKA-RPA.wav","LTA-RDA.wav","LGA-RKA.wav","LPA-RDA.wav","LGA-RGA.wav","LBA-RTA.wav","LGA-RDA.wav","LKA-RTA.wav","LDA-RPA.wav","LTA-RKA.wav","LPA-RPA.wav","LDA-RBA.wav","LGA-RTA.wav","LPA-RKA.wav","LTA-RBA.wav","LKA-RGA.wav","LTA-RTA.wav","LBA-RPA.wav","LDA-RTA.wav","LGA-RBA.wav","LTA-RPA.wav","LDA-RDA.wav","LKA-RBA.wav","LPA-RGA.wav" ];

  function showSessionIntro(){
    const s = sessionOrder[currentSessionIndex];
    const txt = { training: "Eğitim oturumu (yanıtlar kaydedilmeyecek).", NF: "Normal odak: en iyi duyduğunuz heceyi seçin.", FR: "Sağ kulağa odaklanın.", FL: "Sol kulağa odaklanın." }[s] || '';
    $id('sessionTitle').innerText = "Oturum: " + s;
    $id('sessionInstr').innerHTML = txt;
    $id('sessionIntro').classList.remove('hidden');
  }

  $id('sessionStartBtn').onclick = async ()=>{
    $id('sessionIntro').classList.add('hidden');
    try{ const a = $id('stimAudio'); a.src=''; await a.play().catch(()=>{}); }catch(e){}
    setTimeout(()=> startSession(), 200);
  };

  function startSession(){
    currentTrial = -1;
    $id('trialCard').classList.remove('hidden');
    nextTrial();
  }

  const stimAudio = $id('stimAudio');

  function nextTrial(){
    clearTimeout(trialTimeout);
    const sType = sessionOrder[currentSessionIndex];
    const playlist = (sType === 'training') ? trainingPlaylist : mainPlaylist;
    currentTrial++;
    if(currentTrial >= playlist.length){
      $id('trialCard').classList.add('hidden');
      currentSessionIndex++;
      if(currentSessionIndex < sessionOrder.length){ showSessionIntro(); }
      else { endExperiment(); }
      return;
    }
    const stim = playlist[currentTrial];
    $id('trialStatus').innerText = `Deneme ${currentTrial+1}/${playlist.length} (${sType})`;
    playStim(stim);
  }

  async function playStim(stim){
    isResponseAllowed = false;
    const candidates = [ './resources/sounds/erkek/'+stim, './sounds/erkek/'+stim, stim ];
    let played=false;
    for(const p of candidates){
      try{ stimAudio.src = p; await stimAudio.play(); played=true; break; }catch(e){}
    }
    if(!played){
      console.warn('Ses yok, geçiliyor', candidates); 
      if(sessionOrder[currentSessionIndex] !== 'training'){
        results.push({ session: sessionOrder[currentSessionIndex], trial: currentTrial+1, stim, response: 'no_response', code: participant.code || '' });
      }
      setTimeout(nextTrial, 200);
      return;
    }
    stimAudio.onplaying = ()=> setTimeout(()=> isResponseAllowed = true, 400);
    trialTimeout = setTimeout(()=>{
      if(sessionOrder[currentSessionIndex] !== 'training'){
        results.push({ session: sessionOrder[currentSessionIndex], trial: currentTrial+1, stim, response: 'no_response', code: participant.code || '' });
      }
      nextTrial();
    }, 4000);
  }

  /* response buttons */
  document.querySelectorAll('.respBtn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(!isResponseAllowed) return;
      isResponseAllowed = false;
      clearTimeout(trialTimeout);
      const resp = btn.dataset.val;
      const sType = sessionOrder[currentSessionIndex];
      const playlist = (sType === 'training') ? trainingPlaylist : mainPlaylist;
      const stim = playlist[currentTrial];
      if(sType !== 'training'){
        results.push({
          session: sType,
          trial: currentTrial+1,
          stim,
          response: resp,
          leftLevel: participant.leftLevel || '',
          rightLevel: participant.rightLevel || '',
          age: participant.age || '',
          gender: participant.gender || '',
          race: participant.race || '',
          motherTongue: participant.motherTongue || '',
          handUseAnswers: JSON.stringify(participant.handUse || {}),
          staiAnswers: JSON.stringify(participant.staiAnswers || {}),
          code: participant.code || ''
        });
      }
      btn.classList.add('respBtn-active');
      setTimeout(()=> btn.classList.remove('respBtn-active'), 300);
      setTimeout(()=> nextTrial(), 900);
    });
  });

  /* ---------- end, CSV & email ---------- */
  function makeCsv(){
    const keys = ["session","trial","stim","response","leftLevel","rightLevel","age","gender","race","motherTongue","handUseAnswers","staiAnswers","code"];
    const rows = [];
    // info row
    const info = {
      session: "info",
      trial: 0,
      stim: "",
      response: "",
      leftLevel: participant.leftLevel || "",
      rightLevel: participant.rightLevel || "",
      age: participant.age || "",
      gender: participant.gender || "",
      race: participant.race || "",
      motherTongue: participant.motherTongue || "",
      handUseAnswers: JSON.stringify(participant.handUse || {}),
      staiAnswers: JSON.stringify(participant.staiAnswers || {}),
      code: participant.code || ''
    };
    rows.push(info);
    results.forEach(r=> rows.push(r));
    const header = keys.join(',');
    const lines = rows.map(r => keys.map(k=>{
      const v = (r[k] === undefined || r[k] === null) ? '' : String(r[k]).replace(/"/g,'""');
      return `"${v}"`;
    }).join(','));
    return [header, ...lines].join('\n');
  }

  let emailBusy = false;
  async function sendEmail(partial=false){
    if(emailBusy) return;
    emailBusy = true;
    const csv = makeCsv();
    if(!csv){ emailBusy=false; return; }
    try{
      if(!window.emailjs){
        const s = document.createElement('script'); s.src = 'https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js';
        await new Promise((res,rej)=>{ s.onload=res; s.onerror=rej; document.head.appendChild(s); });
        emailjs.init(document.querySelector('meta[name="emailjs-user"]').content);
      }
      const service = document.querySelector('meta[name="emailjs-service"]').content;
      const template = document.querySelector('meta[name="emailjs-template"]').content;
      const subject = (participant.code || ('partial_'+new Date().toISOString()));
      await emailjs.send(service, template, { subject: subject + (partial ? ' (partial)' : ''), message: csv });
      $id('doneLog').innerText = (partial ? 'Ara veriler gönderildi.' : 'Veriler gönderildi.');
      // optionally clear local pending storage
    }catch(e){
      console.warn('email send failed', e);
      try{ localStorage.setItem('pending_csv_' + (participant.code||Date.now()), csv); $id('doneLog').innerText = 'E-posta başarısız, veriler localStorage\'a kaydedildi.'; }catch(err){console.warn(err);}
    } finally { emailBusy = false; }
  }

  async function endExperiment(){
    $id('endCard').classList.remove('hidden');
    await sendEmail(false);
  }

  /* Best-effort send on unload */
  let unloadTried=false;
  async function trySendOnUnload(){
    if(unloadTried) return; unloadTried=true;
    // Best-effort: try send partial (may be blocked by browser)
    try{ await sendEmail(true); }catch(e){}
  }
  window.addEventListener('pagehide', ()=>{ trySendOnUnload(); });
  window.addEventListener('beforeunload', ()=>{ trySendOnUnload(); });

  /* ---------- init (only show first screen) ---------- */
  // hide everything except participantCard (already visible by markup)
  // ensure other cards are hidden
  ['participationCard','consentCard','enterCodeCard','handUseCard','staiCard','hearingCard','sessionIntro','trialCard','endCard'].forEach(id=>{ const el=$id(id); if(el) el.classList.add('hidden'); });
  // STAI markup prepared
  renderStai();

  // expose renderHand earlier? Already defined.
  // show code info if participant code present
  if(participant.code) $id('codeInfo').innerText = 'Katılımcı kodu: ' + participant.code;

}); // DOMContentLoaded end
</script>
</body>
</html>
