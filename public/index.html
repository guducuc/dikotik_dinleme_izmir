<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dikotik Dinleme — Tam Sürüm</title>

<meta name="emailjs-user"    content="FLn2zMqKDGso3ePoO">
<meta name="emailjs-service" content="service_a8bnfmk">
<meta name="emailjs-template"content="template_r6sddff">

<style>
  body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:12px;color:#111;max-width:480px;margin:auto}
  h1{font-size:20px;margin-bottom:10px}
  .card{padding:12px;border:1px solid #ddd;border-radius:8px;margin-bottom:12px}
  .hidden{display:none}
  input,select,textarea{padding:8px;margin:6px 0;width:100%;box-sizing:border-box}

  /* FIX 2.1: Radyo/Checkbox kutucuklarının global %100 genişliğini geçersiz kılar */
  input[type="radio"], input[type="checkbox"] {
    width: auto; 
    margin-right: 6px; 
  }
  
  /* FIX 2.2: Katılım seçeneklerinin her birini yeni satırda ve düzgün hizalanmış gösterir */
  #participationOptions label {
      display: block;
      margin-bottom: 8px; 
  }

  .bigBtn{font-size:1rem;padding:10px 14px;border-radius:8px;border:1px solid #444;background:#eaeaea;cursor:pointer}
  .btnGreen{background:#2ecc71;color:white;border:none}
  .btnRed{background:#e74c3c;color:white;border:none}
  
  /* FIX 1: Yanıt butonlarını 2 sütunlu grid yapısı ile düzenler (2 kolon 3 satır) */
  .respRow{
    display: grid; 
    grid-template-columns: 1fr 1fr; /* İki eşit sütun */
    gap: 8px; /* Butonlar arası boşluk */
    margin-top: 8px;
    padding: 0 12px; 
  }

  .respBtn{
    padding:10px 14px;
    border-radius:8px;
    border:1px solid #444;
    background:#f2f2f2;
    cursor:pointer;
    text-align: center; /* Buton içeriğini ortala */
  }

  .respBtn-active{background:#bdbdbd}
  .stai-options{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
  .hand-grid-header{display:flex;justify-content:space-between;margin-bottom:6px;font-weight:600}
  .hand-grid-row{display:flex;align-items:center;justify-content:space-between;border-top:1px solid #eee;padding:6px 0}
  .hand-grid-row span{flex:2}
  .hand-grid-row .col{flex:1;display:flex;justify-content:center;gap:8px}
  .small{font-size:13px;color:#666}
  .question-group{margin-bottom:10px}
  .linklike{color:#007bff;cursor:pointer;text-decoration:underline}
</style>
</head>
<body>
<h1>Dikotik Dinleme</h1>

<div id="projectCard" class="card">
  <h3>Proje Kodu Seçimi</h3>
  <select id="projectCode">
    <option value="">Proje kodu seçiniz</option>
    <option value="OykuTez">Öykü Tez</option>
    <option value="Izmir">İzmir</option>
    <option value="Esporcu">Esporcu</option>
    <option value="Sporcu">Sporcu</option>
  </select>
  <div style="margin-top:8px"><button id="toParticipationBtn" class="bigBtn">Devam</button></div>
</div>

<div id="participationCard" class="card hidden">
  <h3>Katılım Durumu</h3>
  <div id="participationOptions" class="small"></div>
  <div style="margin-top:8px"><button id="toNextStepBtn" class="bigBtn">Devam</button></div>
</div>

<div id="consentCard" class="card hidden">
  <h3>Aydınlatılmış Onam</h3>
  <div id="consentText" style="border:1px solid #ddd;padding:8px;border-radius:6px;max-height:220px;overflow:auto">
    <p><b>Sayın katılımcı,</b></p>
    <p>Bu çalışma işitsel algı süreçlerini incelemeyi amaçlar. Katılım gönüllülük esasına dayanır; veriler anonim tutulacaktır. Dilediğiniz zaman çalışmadan çekilebilirsiniz.</p>
  </div>
  <div style="display:flex;gap:8px;margin-top:10px">
    <button id="consentAccept" class="bigBtn btnGreen">Okudum, onaylıyorum</button>
    <button id="consentDecline" class="bigBtn btnRed">Kabul etmiyorum</button>
  </div>
  <div id="consentDeclinedMsg" class="small hidden" style="margin-top:10px;color:#c0392b">
    Katılım kabul edilmedi. Deney sonlandırıldı.
  </div>

<div id="consentModal" class="modal hidden">
  <div class="modal-content">
    <span id="closeConsentModal" class="close">&times;</span>
    <h3>Aydınlatılmış Onam Formu (Tam Metin)</h3>
    <p>Araştırmanın Adı: WEB Tabanlı Türkçe Dikotik Dinleme Testi Test – Tekrar Test Güvenirliği<p>
<p>Sorumlu Araştırıcının Adı: Dr. Öğr. Üyesi Emre Eskicioğlu<p>
<p>Yardımcı Araştırmacının Adı: Öykü Akkay<p>
<p>Destekleyici: Doç. Dr. Çağdaş Güdücü<p>

<p>“WEB Tabanlı Türkçe Dikotik Dinleme Testi Test – Tekrar Test Güvenirliği” isimli araştırmada yer almak üzere davet edilmiş bulunmaktasınız. Bu çalışma bilimsel araştırma amaçlı olarak yapılmaktadır ve katılım gönüllülük esasına dayalıdır.<p>
<p>Bu araştırmaya katılıp katılmama kararını vermeden önce, araştırmanın neden ve nasıl yapılacağını bilmeniz gerekmektedir. Bu nedenle bu formun okunup anlaşılması büyük önem taşımaktadır. Eğer anlayamadığınız ve sizin için açık olmayan şeyler varsa, ya da fazla bilgi isterseniz size iletişim bilgileri verilen araştırmacıya sorabilirsiniz.<p>
<p>Araştırmanın amacı nedir; benden başka kaç kişi bu araştırmaya katılacak?<p>
<p>Bu araştırma, Türkçe heceler içeren web tabanlı olarak geliştirilen dikotik dinleme testinin test-tekrar test güvenirliğini değerlendirmektir. Normal şartlarda yalnızca laboratuvar ortamında uygulanabilen bu testin dijital ortama aktarılmasıyla daha geniş katılımcı gruplarına ulaşılması hedeflenmektedir. Bu tez araştırmasının en az 20 kişiye ulaştırılması hedeflenmektedir.<p>
<p>Bu araştırmaya katılırsam beni ne bekliyor?<p>
<p>Dikotik dinleme testi sırasında, bir kulaklık aracılığıyla her iki kulağınıza aynı veya farklı heceler sunulacaktır. Araştırma dizaynı; serbest dinleme, sağ kulağa dikkat yönlendirilen ve sol kulağa dikkat yönlendirilen olarak üç farklı oturumdan oluşmaktadır. Tüm oturumlarda duyduğunuz heceyi ekranda işaretlemeniz istenecektir. Serbest dinleme oturumunda en iyi duyduğunuz heceyi, sağ ve sol baskın oturumlarda ise dikkatin yönlendirildiği kulaktan duyduğunuz heceleri işaretlemeniz istenecektir. Oturum aralarında, bir sonraki seansı bildiren ve oturum detaylarını içeren bir sayfası ekrana gelecektir. İki hafta sonra aynı test tekrar uygulanarak test – tekrar test güvenirliği değerlendirilecektir. Veriler, nicel analiz yöntemleriyle değerlendirilecektir.<p>
</p>Araştırmanın uygulama süreci toplamda 2 hafta olarak planlanmaktadır. İlk test uygulamasından sonra, ikinci test uygulaması 14 gün sonra yapılacaktır. Her bir oturum yaklaşık 20 dakika sürecek olup toplamda katılımcının araştırma sürecine ayıracağı süre 40 dakika olacaktır.</p>
</p>Bu araştırmaya katılmalı mıyım?</p>
</p>Bu araştırmada yer almak tamamen size bağlıdır. Şimdi bu formu imzalasanız bile istediğiniz herhangi bir zamanda bir neden göstermeksizin araştırmadan ayrılmakta özgürsünüz. Eğer katılmak istemez iseniz veya araştırmadan ayrılırsanız, sizin için en uygun tedavi planı bu kararınızdan etkilenmeksizin uygulanacaktır. Eğer araştırmayı yürüten araştırmacı devam etmenizin sizin için yararlı olmayacağına karar verirse sizi araştırma dışı bırakabilir, bu durumda da sizin için standart olarak verilmesi gereken en uygun tedavi uygulanacaktır.</p>
</p>Araştırmanın olası riskleri nelerdir?</p>
</p>Araştırma, çevrimiçi ortamda uygulanacak bir işitme testi olup ses seviyesini kendi konforunuza göre ayarlamanız beklenmektedir. Test, yüksek ses şiddeti içermemektedir. Araştırmada yer alan test protokolleri ve deney desenlerinin herhangi bir yan etki oluşturması beklenmemektedir.</p>
</p>Araştırmanın olası riskleri konusunda ne gibi önlemler alınacaktır?</p>
</p>Araştırma ile ilgili ortaya çıkabilecek herhangi bir sağlık probleminde her türlü tıbbi girişim tarafımızdan yapılacak; bu konudaki tüm harcamalar da tarafımızdan karşılanacaktır.</p>
</p>Bu araştırmaya katılmamın maliyeti nedir?</p>
</p>Bu araştırmada yer almak tümüyle sizin isteğinize bağlıdır. Bu araştırma için size herhangi bir ödeme yapılmayacaktır. Araştırma sırasında oluşabilecek masraflar size ve bağlı olduğunuz kuruma ödetilmeyecektir.</p>
</p>Kişisel bilgilerim nasıl kullanılacak?</p>
</p>Araştırmayı yapan araştırmacı kişisel bilgilerinizi, araştırmayı ve istatiksel analizleri yürütmek için kullanacaktır ancak kimlik bilgileriniz tıp etiği ve KVKK düzenlenmelerine uygun şekilde gizli tutulacaktır. Araştırma için kullanılacak bilgileriniz üçüncü kişilerle paylaşılmayacaktır. Yalnızca gereği halinde, sizinle ilgili bilgileri etik kurullar ya da resmi makamlar inceleyebilir. Araştırmanın sonunda, kendi sonuçlarınızla ilgili bilgi istemeye hakkınız vardır. Araştırma sonuçları araştırma bitiminde tıbbi literatürde yayınlanabilecektir ancak kimliğiniz açıklanmayacaktır.</p>

</p>KATILIMCININ BEYANI</p>
</p>Biyofizik  Anabilim dalında, Öykü Akkay tarafından tıbbi bir araştırma yapılacağı belirtilerek bu araştırma ile ilgili yukarıdaki bilgiler bana aktarıldı ve ilgili metni okudum.</p>
</p>Araştırmaya katılmam konusunda zorlayıcı bir davranışla karşılaşmış değilim. Eğer katılmayı reddedersem, bu durumun tıbbi bakımıma ve tedavimi yapan kişi ile olan ilişkime herhangi bir zarar getirmeyeceğini de biliyorum. Projenin yürütülmesi sırasında herhangi bir neden göstermeden araştırmadan çekilebilirim. (Ancak araştırmacıları zor durumda bırakmamak için araştırmadan çekileceğimi önceden bildirmemim uygun olacağının bilincindeyim). Ayrıca tıbbi durumuma herhangi bir zarar verilmemesi koşuluyla araştırmacı tarafından araştırma dışı da tutulabileceğim konusunda bilgilendirildim.</p>
</p>Araştırma için yapılacak harcamalarla ilgili herhangi bir parasal sorumluluk altına girmiyorum. Bana da bir ödeme yapılmayacaktır.</p>
</p>Araştırmadan elde edilen benimle ilgili kişisel bilgilerin gizliliğinin korunacağını biliyorum.</p>
</p>Araştırma uygulamasından kaynaklanan nedenlerle meydana gelebilecek herhangi bir sağlık sorunumun ortaya çıkması halinde, her türlü tıbbi müdahalenin sağlanacağı konusunda gerekli güvence verildi. (Bu tıbbi müdahalelerle ilgili olarak da parasal bir yük altına girmeyeceğim).</p>
</p>Araştırma sırasında bir sağlık sorunu ile karşılaştığımda; herhangi bir saatte, Emre Eskicioğlu, Dokuz Eylül Üniversitesi Tıp Fakültesi, Biyofizik Anabilim Dalı, İnciraltı 35340-İZMİR,  0 555 740 01 87 ‘den arayabileceğimi biliyorum.</p>

  </p>Bana yapılan tüm açıklamaları ayrıntılarıyla anlamış bulunmaktayım. Bu koşullarla söz konusu klinik araştırmaya kendi rızamla, hiçbir baskı ve zorlama olmaksızın, gönüllülük içerisinde katılmayı kabul ediyorum.</p>
  </p>
  </div>
</div>

<style>
.modal{position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:none}
.modal-content{background:#fff;margin:5% auto;padding:20px;border-radius:10px;max-width:600px;max-height:80vh;overflow-y:auto}
.close{float:right;font-size:24px;font-weight:bold;cursor:pointer;color:#888}
.close:hover{color:#000}
</style>

</div>

<div id="infoCard" class="card hidden">
  <h3>Katılımcı Bilgileri</h3>
  <div class="small">Ad ve soyad için ilk 2 harf yeterli (gizlilik).</div>
  <input id="name" placeholder="Ad (ilk 2 harf)">
  <input id="surname" placeholder="Soyad (ilk 2 harf)">
  <input id="age" type="number" placeholder="Yaş">
  <input id="email" type="email" placeholder="E-posta adresiniz">
  <input id="phone" type="tel" placeholder="Telefon numaranız">
  <input id="race" placeholder="Doğum yeri / Irk">
  <input id="motherTongue" placeholder="Anadiliniz">
  <select id="gender"><option value="">Cinsiyet</option><option>Kadın</option><option>Erkek</option><option>Diğer</option></select>
  <div id="codeInfo" class="small" style="margin-top:6px;color:#2c3e50"></div>
  <div style="margin-top:8px"><button id="toHandFromInfo" class="bigBtn">Devam</button></div>
</div>

<div id="enterCodeCard" class="card hidden">
  <h3>Önceki Katılımcı Kodu</h3>
  <div class="small">Daha önce katıldıysanız lütfen katılımcı kodunuzu girin.</div>
  <input id="previousCode" placeholder="Örnek: OY_AB_12345">
  <div style="margin-top:8px"><button id="toStaiDirectBtn" class="bigBtn">Devam</button></div>
</div>

<div id="handUseCard" class="card hidden">
  <h3>El Kullanımı Testi</h3>
  <p class="small">Aşağıda günlük hayatta yapyığınız işlemler bulunmaktadır. Lütfen her işlem için kullandığınız eli işaretleyin. Örneğin; yazı yazarken sürekli sağ elinizi kullanıyorsanız sağ el altındaki iki kutucuğu da işaretleyin. Eğer hem sol hem de sağ elinizi kullanıyorsanız her iki el için de birer kutucuk işaretleyin. Lütfen her satır için toplam 2 kutucuk işaretlemeyi unutmayın!</p>
  <div id="handUseQuestions"></div>
  <div style="margin-top:8px"><button id="toStaiBtn" class="bigBtn">Devam</button></div>
</div>

<div id="staiCard" class="card hidden">
  <h3>STAI-TXI Formu</h3>
  <p class="small">Aşağıda kişilerin kendilerine ait duygularını anlatmada kullandıkları bir takım ifadeler verilmiştir. Her ifadeyi okuyun, sonra da nasıl hissettiğinizi ifadelerin sağ tarafındaki parantezlerden uygun olan kutucuğu işaretleyin. Doğru ya da yanlış cevap yoktur. Herhangi bir ifadenin üzerinde fazla zaman sarf etmeksizin anında nasıl hissettiğinizi gösteren cevabı işaretleyin.</p>
  <div id="staiQuestions"></div>
  <div style="margin-top:8px"><button id="toHearingBtn" class="bigBtn">Devam</button></div>
</div>

<div id="hearingCard" class="card hidden">
  <h3>İşitme Kontrolü</h3>
  <p class="small">Lütfen kulaklığınızı takın! Sol ve sağ kulak için ayrı ayrı sesi dinleyin ve size uygun olan ses seviyesini ayarlayın.</p>
  <div style="margin-top:8px">
    <label><b>Sol Kulak</b></label>
    <input type="range" id="leftSlider" min="0" max="1" step="0.01" value="0.5">
    <button id="playLeft" class="bigBtn">Sol Oynat</button>
  </div>
  <div style="margin-top:12px">
    <label><b>Sağ Kulak</b></label>
    <input type="range" id="rightSlider" min="0" max="1" step="0.01" value="0.5">
    <button id="playRight" class="bigBtn">Sağ Oynat</button>
  </div>
  <div style="margin-top:12px"><button id="toSessionIntro" class="bigBtn">Devam</button></div>
</div>

<div id="sessionIntro" class="card hidden">
  <h3 id="sessionTitle"></h3>
  <p id="sessionInstr"></p>
  <div style="margin-top:8px"><button id="sessionStartBtn" class="bigBtn">Başla</button></div>
</div>

<div id="trialCard" class="card hidden">
  <div id="trialStatus" class="small" style="margin-bottom:8px"></div>
  <audio id="stimAudio" preload="auto"></audio>
  <div class="respRow">
    <button class="respBtn" data-val="BA">BA</button>
    <button class="respBtn" data-val="DA">DA</button>
    <button class="respBtn" data-val="GA">GA</button>
    <button class="respBtn" data-val="KA">KA</button>
    <button class="respBtn" data-val="PA">PA</button>
    <button class="respBtn" data-val="TA">TA</button>
  </div>
</div>

<div id="endCard" class="card hidden">
  <h3>Deney tamamlandı ✅</h3>
  <div id="doneLog" class="small"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', ()=>{

/* ---------- helpers & state ---------- */
const $id = id => document.getElementById(id);
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] } return arr; }

let participant = {}, results = [], sessionOrder = [], currentSessionIndex = 0, currentTrial = -1;
let audioCtx=null,leftOsc=null,rightOsc=null,leftGain=null,rightGain=null;
let isResponseAllowed=false, trialTimeout=null, responseStart=0;

/* ---------- STAI & hand questions ---------- */
const staiQuestions = [
"Şu anda sakinim","Kendimi emniyette hissediyorum","Şu anda sinirlerim gergin",
"Pişmanlık duygusu içindeyim","Şu anda huzur içindeyim","Şu anda hiç keyfim yok",
"Başıma geleceklerden endişe ediyorum","Kendimi dinlenmiş hissediyorum","Şu anda kaygılıyım",
"Kendimi rahat hissediyorum","Kendime güvenim var","Şu anda asabım bozuk","Çok sinirliyim",
"Sinirlerimin çok gergin olduğunu hissediyorum","Kendimi rahatlamış hissediyorum",
"Şu anda halimden memnunum","Şu anda endişeliyim","Heyecandan kendimi şaşkına dönmüş hissediyorum",
"Şu anda sevinçliyim","Şu anda keyfim yerinde"
];

const handQs = ["Yazmak","Çizmek","Taş Atmak","Makas kullanmak","Diş fırçası kullanmak","Bıçak kullanmak","Kaşık kullanmak","Süpürge (üst el)","Kibrit çakmak","Kutunun kapağını açmak"];

function renderStai(){
  const c = $id('staiQuestions'); c.innerHTML = '';
  staiQuestions.forEach((q,i)=>{
    c.innerHTML += `<div class="question-group"><p>${i+1}. ${q}</p>
      <div class="stai-options">
        <label><input type="radio" name="staiQ${i+1}" value="1">Hiç</label>
        <label><input type="radio" name="staiQ${i+1}" value="2">Biraz</label>
        <label><input type="radio" name="staiQ${i+1}" value="3">Çok</label>
        <label><input type="radio" name="staiQ${i+1}" value="4">Tamamıyla</label>
      </div></div>`;
  });
}

function renderHand(){
  const c = $id('handUseQuestions'); c.innerHTML = `<div class="hand-grid-header"><div style="flex:2"></div><div style="flex:1;text-align:center">Sol</div><div style="flex:1;text-align:center">Sağ</div></div>`;
  handQs.forEach((q,i)=>{
    c.innerHTML += `<div class="hand-grid-row" data-q="${i+1}"><span>${i+1}. ${q}</span>
      <div class="col"><input type="checkbox" class="left"><input type="checkbox" class="left"></div>
      <div class="col"><input type="checkbox" class="right"><input type="checkbox" class="right"></div>
    </div>`;
  });
}

/* ---------- FLOW: project -> participation ---------- */
$id('toParticipationBtn').onclick = ()=>{
  const proj = $id('projectCode').value;
  if(!proj){ alert('Lütfen proje kodu seçiniz.'); return; }
  participant.projectCode = proj;
  // hide project, show participation
  $id('projectCard').classList.add('hidden');
  $id('participationCard').classList.remove('hidden');
  renderParticipationOptions(proj);
};


function renderParticipationOptions(project){
  const el = $id('participationOptions'); el.innerHTML = '';
  // FIX 2.2: CSS'te #participationOptions label kuralı ile her seçeneğin yeni satırda ve düzgün görünmesi sağlandı.
  if(project === 'OykuTez'){
    el.innerHTML = `
      <label><input type="radio" name="participation" value="1"> İlk kez katılıyorum</label>
      <label><input type="radio" name="participation" value="2"> Bir kez katıldım ama tamamlayamadım</label>
      <label><input type="radio" name="participation" value="3"> İkinci kez katılıyorum</label>
      <label><input type="radio" name="participation" value="4"> İki kez katıldım ancak tamamlayamadım</label>
    `;
  } else {
    el.innerHTML = `
      <label><input type="radio" name="participation" value="1"> İlk kez katılıyorum</label>
      <label><input type="radio" name="participation" value="2"> Bir kez katıldım ama tamamlayamadım</label>
    `;
  }
}


$id('toNextStepBtn').onclick = ()=>{
  const sel = document.querySelector('input[name="participation"]:checked');
  if(!sel){ alert('Lütfen bir seçenek seçiniz.'); return; }
  const val = sel.value;
  participant.participation = val;
  $id('participationCard').classList.add('hidden');
  if(val === '1'){
    // first time -> show consent BEFORE participant info
    $id('consentCard').classList.remove('hidden');
  } else {
    // returning -> ask for code only
    $id('enterCodeCard').classList.remove('hidden');
  }
};


// ----- Modal popup control -----
document.getElementById('consentText').insertAdjacentHTML('beforebegin', '<button id="openConsentPopup" class="bigBtn" style="margin-bottom:10px">Onam Formunu Görüntüle</button>');
const openBtn=document.getElementById('openConsentPopup');
openBtn.onclick=()=>{document.getElementById('consentModal').style.display='block';};
document.getElementById('closeConsentModal').onclick=()=>{document.getElementById('consentModal').style.display='none';};
window.onclick=e=>{if(e.target==document.getElementById('consentModal'))document.getElementById('consentModal').style.display='none';};

/* ---------- Consent buttons ---------- */
$id('consentAccept').onclick = ()=>{
  // accepted -> go to participant info
  $id('consentCard').classList.add('hidden');
  $id('infoCard').classList.remove('hidden');
};
$id('consentDecline').onclick = ()=>{
  // declined -> show message and do not progress
  $id('consentDeclinedMsg').classList.remove('hidden');
  // optionally hide other buttons to prevent further progress
  $id('consentAccept').disabled = true;
  $id('consentDecline').disabled = true;
};

/* ---------- Participant info -> Hand ---------- */
$id('toHandFromInfo').onclick = ()=>{
  const n = $id('name').value.trim(), s = $id('surname').value.trim(), a = $id('age').value.trim();
  if(!n || !s || !a){ alert('Lütfen ad (ilk2), soyad (ilk2) ve yaşı giriniz.'); return; }
  const e=$id('email').value.trim(), p=$id('phone').value.trim();
  if(!e || !p){ alert('Lütfen e-posta ve telefon bilgilerinizi giriniz.'); return; }
  participant.email=e; participant.phone=p;
  participant.name = n.slice(0,2);
  participant.surname = s.slice(0,2);
  participant.age = a;
  participant.race = $id('race').value.trim();
  participant.motherTongue = $id('motherTongue').value.trim();
  participant.gender = $id('gender').value;
  // generate code (project + _ + 5-digit random)
  const four = (participant.name.padEnd(2).slice(0,2) + participant.surname.padEnd(2).slice(0,2)).toUpperCase().replace(/[^A-Z]/g,'X');
  const rand5 = Math.floor(10000 + Math.random()*90000);
  participant.code = (participant.projectCode ? participant.projectCode + '_' : '') + four + '_' + rand5;
  $id('codeInfo').innerText = 'Katılımcı kodu: ' + participant.code;
  $id('infoCard').classList.add('hidden');
  renderHand();
  $id('handUseCard').classList.remove('hidden');
};

/* ---------- Returning participant code flow ---------- */
$id('toStaiDirectBtn').onclick = ()=>{
  const code = $id('previousCode').value.trim();
  if(!code){ alert('Lütfen önceki katılımcı kodunu giriniz.'); return; }
  participant.code = code;
  // try to load saved summary (hand use, motherTongue, race) from localStorage
  try{
    const raw = localStorage.getItem('participant.' + code);
    if(raw){
      const saved = JSON.parse(raw);
      participant = {...participant, ...saved};
    }
  }catch(e){ console.warn('local load err', e); }
  $id('enterCodeCard').classList.add('hidden');
  // Directly to STAI for returning participants
  renderStai();
  $id('staiCard').classList.remove('hidden');
};

/* ---------- Hand -> STAI ---------- */
$id('toStaiBtn').onclick = ()=>{
  // validate two checked per row
  const rows = document.querySelectorAll('#handUseQuestions .hand-grid-row');
  for(const r of rows){
    if(r.querySelectorAll('input:checked').length !== 2){ alert('Her işlem için tam olarak 2 kutucuk işaretleyiniz.'); return; }
  }
  // collect
  participant.handUse = Array.from(rows).map(r=>({
    q: r.dataset.q,
    left: r.querySelectorAll('.left:checked').length,
    right: r.querySelectorAll('.right:checked').length
  }));
  // save minimal summary to localStorage for returning merges (best-effort)
  try{ if(participant.code) localStorage.setItem('participant.' + participant.code, JSON.stringify({ projectCode: participant.projectCode, handUse: participant.handUse, motherTongue: participant.motherTongue || '', race: participant.race || '' })); }catch(e){ console.warn(e); }
  $id('handUseCard').classList.add('hidden');
  renderStai();
  $id('staiCard').classList.remove('hidden');
};

/* ---------- STAI -> Hearing ---------- */
function renderStai(){
  const c = $id('staiQuestions'); c.innerHTML = '';
  staiQuestions.forEach((q,i)=> {
    c.innerHTML += `<div class="question-group"><p>${i+1}. ${q}</p>
      <div class="stai-options">
        <label><input type="radio" name="staiQ${i+1}" value="1">Hiç</label>
        <label><input type="radio" name="staiQ${i+1}" value="2">Biraz</label>
        <label><input type="radio" name="staiQ${i+1}" value="3">Çok</label>
        <label><input type="radio" name="staiQ${i+1}" value="4">Tamamıyla</label>
      </div></div>`;
  });
}

$id('toHearingBtn').onclick = ()=>{
  const answered = document.querySelectorAll('#staiQuestions input:checked').length;
  if(answered < staiQuestions.length){ alert('Lütfen tüm STAI sorularını yanıtlayınız.'); return; }
  // collect STAI answers
  participant.staiAnswers = {};
  document.querySelectorAll('#staiQuestions input:checked').forEach(i=> participant.staiAnswers[i.name] = i.value);
  $id('staiCard').classList.add('hidden');
  $id('hearingCard').classList.remove('hidden');
};
/* ---------- Hearing: two channels ---------- */
function ensureCtx(){ if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
function stopLeft(){ try{ if(leftOsc) leftOsc.stop(); }catch(e){} leftOsc=null; leftGain=null; }
function stopRight(){ try{ if(rightOsc) rightOsc.stop(); }catch(e){} rightOsc=null; rightGain=null; }

// startLeft fonksiyonunu async olarak değiştiriyoruz
async function startLeft(){
  ensureCtx(); stopRight(); stopLeft();
  // FIX: Tarayıcı kısıtlamaları nedeniyle ses çalmayabilir. Resume komutu eklendi.
  if (audioCtx.state === 'suspended') await audioCtx.resume();
  
  leftOsc = audioCtx.createOscillator(); 
  leftGain = audioCtx.createGain();
  
  // YENİ: Sesi kesin olarak sol kanala yönlendirmek için StereoPannerNode kullanılır.
  const panner = audioCtx.createStereoPanner(); 
  panner.pan.value = -1; // Tam Sol

  leftOsc.frequency.value = 1500; 
  leftGain.gain.value = Number($id('leftSlider').value);

  // YENİ BAĞLANTI SIRA DÜZENİ: Osc -> Gain -> Panner (-1) -> Destination
  leftOsc.connect(leftGain);
  leftGain.connect(panner); 
  panner.connect(audioCtx.destination); 

  leftOsc.start();
}
// startRight fonksiyonunu async olarak değiştiriyoruz
async function startRight(){
  ensureCtx(); stopLeft(); stopRight();
  // FIX: Tarayıcı kısıtlamaları nedeniyle ses çalmayabilir. Resume komutu eklendi.
  if (audioCtx.state === 'suspended') await audioCtx.resume();
  
  rightOsc = audioCtx.createOscillator(); 
  rightGain = audioCtx.createGain();
  
  // YENİ: Sesi kesin olarak sağ kanala yönlendirmek için StereoPannerNode kullanılır.
  const panner = audioCtx.createStereoPanner(); 
  panner.pan.value = 1; // Tam Sağ

  rightOsc.frequency.value = 1500; 
  rightGain.gain.value = Number($id('rightSlider').value);

  // YENİ BAĞLANTI SIRA DÜZENİ: Osc -> Gain -> Panner (+1) -> Destination
  rightOsc.connect(rightGain);
  rightGain.connect(panner); 
  panner.connect(audioCtx.destination); 

  rightOsc.start();
}
 
$id('playLeft').onclick = ()=>{ if(leftOsc) stopLeft(); else startLeft(); setTimeout(()=>stopLeft(),1200); };
$id('playRight').onclick = ()=>{ if(rightOsc) stopRight(); else startRight(); setTimeout(()=>stopRight(),1200); };

$id('toSessionIntro').onclick = ()=>{
  stopLeft(); stopRight();
  participant.leftLevel = $id('leftSlider').value;
  participant.rightLevel = $id('rightSlider').value;
  // save hearing level entry
  results.push({ session: 'hearing_level', trial: 0, stim: '1500Hz', response: '', responseTime: '', leftLevel: participant.leftLevel, rightLevel: participant.rightLevel, age: participant.age || '', gender: participant.gender || '', race: participant.race || '', motherTongue: participant.motherTongue || '', handUseAnswers: JSON.stringify(participant.handUse || {}), staiAnswers: JSON.stringify(participant.staiAnswers || {}), code: participant.code || '' });
  // session order: training, NF, random FR/FL
  sessionOrder = ['training','NF', ...shuffle(['FR','FL'])];
  currentSessionIndex = 0;
  
  $id('hearingCard').classList.add('hidden'); // İşitme kontrol kartını gizle
  showSessionIntro();
};

/* ---------- session intro & trials ---------- */
const trainingPlaylist = [ "LBA-RBA.wav","LDA-RDA.wav","LGA-RGA.wav","LKA-RKA.wav","LPA-RPA.wav","LTA-RTA.wav","LBA-RDA.wav","LDA-RGA.wav","LGA-RKA.wav","LKA-RTA.wav" ];
const mainPlaylist = [ "LBA-RKA.wav","LDA-RGA.wav","LPA-RBA.wav","LKA-RDA.wav","LBA-RBA.wav","LTA-RGA.wav","LBA-RDA.wav","LGA-RPA.wav","LDA-RKA.wav","LPA-RTA.wav","LKA-RKA.wav","LBA-RGA.wav","LKA-RPA.wav","LTA-RDA.wav","LGA-RKA.wav","LPA-RDA.wav","LGA-RGA.wav","LBA-RTA.wav","LGA-RDA.wav","LKA-RTA.wav","LDA-RPA.wav","LTA-RKA.wav","LPA-RPA.wav","LDA-RBA.wav","LGA-RTA.wav","LPA-RKA.wav","LTA-RBA.wav","LKA-RGA.wav","LTA-RTA.wav","LBA-RPA.wav","LDA-RTA.wav","LGA-RBA.wav","LTA-RPA.wav","LDA-RDA.wav","LKA-RBA.wav","LPA-RGA.wav" ];

function showSessionIntro(){
  const s = sessionOrder[currentSessionIndex];
  $id('sessionTitle').innerText = 'Oturum: ' + s;
  $id('sessionInstr').innerHTML = (s === 'training') ? 'Eğitim oturumuna hoşgeldiniz. Yanıt vermeye çalışmadan heceleri dinleyin. Bir sonraki oturumda testimiz başlayacak' : (s === 'NF' ? 'Lütfen kulaklığınızın takılı olduğuna ve ses seviyeleri ile oynamadığınızdan emin olunuz. Şimdi sizden en iyi duyduğunuz heceyi seçmenizi istiyoruz.' : (s === 'FR' ? 'Şimdi sizden sağ kulağınıza odaklanmanızı ve sağ kulağınızdan duyduğunuz heceyi seçmenizi istiyoruz. Hazır olun!' : 'Şimdi sizden sol kulağınıza odaklanmanızı ve sol kulağınızdan duyduğunuz heceyi seçmenizi istiyoruz. Hazır olun!'));
  $id('sessionIntro').classList.remove('hidden');
}

$id('sessionStartBtn').onclick = async ()=>{
  $id('sessionIntro').classList.add('hidden');
  try{ const a = $id('stimAudio'); a.src=''; await a.play().catch(()=>{}); }catch(e){}
  setTimeout(()=> startSession(), 200);
};

function startSession(){
  currentTrial = -1;
  $id('trialCard').classList.remove('hidden');
  nextTrial();
}

const stimAudio = $id('stimAudio');

function nextTrial(){
  clearTimeout(trialTimeout);
  const sType = sessionOrder[currentSessionIndex];
  const playlist = (sType === 'training') ? trainingPlaylist : mainPlaylist;
  currentTrial++;
  if(currentTrial >= playlist.length){
    $id('trialCard').classList.add('hidden');
    currentSessionIndex++;
    if(currentSessionIndex < sessionOrder.length) showSessionIntro(); else endExperiment();
    return;
  }
  const stim = playlist[currentTrial];
  $id('trialStatus').innerText = `Deneme ${currentTrial+1}/${playlist.length} (${sType})`;
  playStim(stim);
}
// playStim fonksiyonu (değiştirilecek kısım)
async function playStim(stim){
  isResponseAllowed = false;
  const path = './sounds/yeni/erkek/' + stim; // adjust if needed
  try{
    stimAudio.src = path;
    await stimAudio.play();
    
    // FIX: onplaying olayına güvenmek yerine, play() promise'ının çözülmesini baz alıyoruz.
    // Bu, özellikle oturumun ilk denemesinde yanıtın etkinleşmesini garanti eder.
    responseStart = Date.now(); 
    setTimeout(()=> isResponseAllowed = true, 500); 

    // 4000ms zaman aşımı (timeout)
    trialTimeout = setTimeout(()=>{ 
        if(sessionOrder[currentSessionIndex] !== 'training') saveTrial(stim, 'no_response', '', Date.now()-responseStart); 
        nextTrial(); 
    }, 4000);
  }catch(e){
    console.warn('Audio play failed', e);
    // mark no_response and continue
    if(sessionOrder[currentSessionIndex] !== 'training') saveTrial(stim, 'no_response', '', '');
    setTimeout(nextTrial, 200);
  }
}

/* ---------- responses ---------- */
function saveTrial(stim, response, responseTime, rt){
  // responseTime in ms (number or empty)
  results.push({
    session: sessionOrder[currentSessionIndex],
    trial: currentTrial+1,
    stim,
    response,
    responseTime: rt === '' ? '' : rt,
    leftLevel: participant.leftLevel || '',
    rightLevel: participant.rightLevel || '',
    age: participant.age || '',
    gender: participant.gender || '',
    race: participant.race || '',
    motherTongue: participant.motherTongue || '',
    handUseAnswers: JSON.stringify(participant.handUse || {}),
    staiAnswers: JSON.stringify(participant.staiAnswers || {}),
    code: participant.code || ''
  });
}

document.querySelectorAll('.respBtn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    if(!isResponseAllowed) return;
    isResponseAllowed = false;
    clearTimeout(trialTimeout);
    const rt = Date.now() - responseStart;
    const resp = btn.dataset.val;
    const sType = sessionOrder[currentSessionIndex];
    const playlist = (sType === 'training') ? trainingPlaylist : mainPlaylist;
    const stim = playlist[currentTrial];
    if(sType !== 'training'){ saveTrial(stim, resp, rt, rt); }
    btn.classList.add('respBtn-active');
    setTimeout(()=> btn.classList.remove('respBtn-active'), 300);
    setTimeout(()=> nextTrial(), 2500); //yanıt sonrası bekleme süresi
  });
});

/* ---------- End, CSV, Email ---------- */
function makeCsv(){
  // --- 1️⃣ Katılımcı Bilgileri ---
  let csv = 'KATILIMCI BİLGİLERİ\n';
  csv += 'Kod,Proje,Yaş,Cinsiyet,Anadil,DoğumYeri,SolSeviye,SağSeviye\n';
  csv += `${participant.code || ''},${participant.projectCode || ''},${participant.age || ''},${participant.gender || ''},${participant.motherTongue || ''},${participant.race || ''},${participant.leftLevel || ''},${participant.rightLevel || ''}\n\n`;

  // --- 2️⃣ El Kullanım Testi ---
  csv += 'EL KULLANIMI\n';
  csv += JSON.stringify(participant.handUse || {}) + '\n\n';

  // --- 3️⃣ STAI Yanıtları ---
  csv += 'STAI YANITLARI\n';
  csv += JSON.stringify(participant.staiAnswers || {}) + '\n\n';

  // --- 4️⃣ İşitme Testi ---
  csv += 'İŞİTME TESTİ (1500Hz Tonu)\n';
  csv += `Sol=${participant.leftLevel || ''}, Sağ=${participant.rightLevel || ''}\n\n`;

  // --- 5️⃣ DİKOTİK SONUÇLAR ---
  csv += 'DİKOTİK SONUÇLAR\n';
  csv += 'Session,Trial,Stimulus,Response,ResponseTime\n';
  results.forEach(r=>{
    csv += `${r.session},${r.trial},${r.stim},${r.response},${r.responseTime}\n`;
  });

  return csv;
}

let emailBusy=false;
async function sendEmail(partial=false){
  if(emailBusy) return;
  emailBusy = true;
  const csv = makeCsv();
  if(!csv){ emailBusy=false; return; }
  try{
    if(!window.emailjs){
      const s = document.createElement('script'); s.src = 'https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js';
      await new Promise((res,rej)=>{ s.onload = res; s.onerror = rej; document.head.appendChild(s); });
      emailjs.init(document.querySelector('meta[name="emailjs-user"]').content);
    }
    const service = document.querySelector('meta[name="emailjs-service"]').content;
    const template = document.querySelector('meta[name="emailjs-template"]').content;
    const subject = (participant.code ? participant.code : ('partial_' + new Date().toISOString()));
    await emailjs.send(service, template, { subject: subject + (partial ? ' (partial)' : ''), message: csv });
    $id('doneLog').innerText = (partial ? 'Ara veriler gönderildi.' : 'Veriler e-posta ile gönderildi.');
  }catch(e){
    console.warn('email send failed', e);
    try{ localStorage.setItem('pending_csv_' + (participant.code || Date.now()), csv); $id('doneLog').innerText = 'E-posta başarısız oldu, CSV localStorage\'a kaydedildi.'; }catch(err){ console.warn(err); }
  } finally { emailBusy=false; }
}

async function endExperiment(){
  $id('trialCard').classList.add('hidden');
  $id('endCard').classList.remove('hidden');
  await sendEmail(false);
}

/* Best-effort partial send on unload */
let unloadTried = false;
async function trySendOnUnload(){
  if(unloadTried) return; unloadTried = true;
  try{ await sendEmail(true); }catch(e){}
}
window.addEventListener('pagehide', ()=>{ trySendOnUnload(); });
window.addEventListener('beforeunload', ()=>{ trySendOnUnload(); });

/* ---------- Init (only show projectCard first) ---------- */
renderStai(); // prepare stai DOM for later
// ensure others hidden
['participationCard','consentCard','infoCard','enterCodeCard','handUseCard','staiCard','hearingCard','sessionIntro','trialCard','endCard'].forEach(id => { const el = $id(id); if(el) el.classList.add('hidden'); });

  /* ---------- İşitme Testi Sorunu İçin Ek Güvenlik Önlemi: AudioContext'in ilk tıklamada başlatılıp sürdürülmesini sağlar. ---------- */
document.addEventListener('click', function initAudioContext() {
    ensureCtx();
    if (audioCtx && audioCtx.state === 'suspended') {
        // AudioContext'i devam ettirmeyi dener
        audioCtx.resume().catch(e => console.error("Audio Context Resume Error:", e));
    }
    // İlk tıklamadan sonra dinleyiciyi kaldır
    document.removeEventListener('click', initAudioContext);
}, {once: true});
  
}); // DOMContentLoaded end
</script>
</body>
</html>
